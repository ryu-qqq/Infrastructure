{
  "name": "Infra Issue Orchestrator",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "infra-issue",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        1728,
        -2432
      ],
      "id": "69dcad4b-7a26-4333-a92f-a91bf3962c3f",
      "name": "Webhook",
      "webhookId": "487b7679-97c7-4838-ade3-1ac3115bb39c"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://slack.com/api/chat.postMessage ",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "slackApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n    \"channel\": \"C0A5JRE5K09\",\n    \"blocks\": [\n      {\n        \"type\": \"header\",\n        \"text\": {\"type\": \"plain_text\", \"text\": \"ğŸ—ï¸ ìƒˆë¡œìš´ ì¸í”„ë¼ ë³€ê²½ ìš”ì²­\", \"emoji\": true}\n      },\n      {\n        \"type\": \"section\",\n        \"fields\": [\n          {\"type\": \"mrkdwn\", \"text\": \"*Issue:*\\n<{{ $json.url }}|{{ $json.github_issue }}>\"},\n          {\"type\": \"mrkdwn\", \"text\": \"*Jira:*\\n{{ $json.jira_key }}\"}\n        ]\n      },\n      {\n        \"type\": \"section\",\n        \"fields\": [\n          {\"type\": \"mrkdwn\", \"text\": \"*ì œëª©:*\\n{{ $json.title }}\"},\n          {\"type\": \"mrkdwn\", \"text\": \"*ì‘ì„±ì:*\\n{{ $json.author }}\"}\n        ]\n      },\n      {\"type\": \"divider\"},\n      {\n        \"type\": \"section\",\n        \"text\": {\"type\": \"mrkdwn\", \"text\": \"*ë‚´ìš©:*\\n{{ $json.body }}\"}\n      },\n      {\n        \"type\": \"actions\",\n        \"elements\": [\n          {\"type\": \"button\", \"text\": {\"type\": \"plain_text\", \"text\": \"âœ… ìŠ¹ì¸\", \"emoji\": true}, \"style\": \"primary\", \"value\": \"approve_{{ $json.github_issue }}_{{ $json.jira_key }}\", \"action_id\": \"approve_action\"},\n          {\"type\": \"button\", \"text\": {\"type\": \"plain_text\", \"text\": \"âŒ ê±°ì ˆ\", \"emoji\": true}, \"style\": \"danger\", \"value\": \"reject_{{ $json.github_issue }}_{{ $json.jira_key }}\", \"action_id\": \"reject_action\"},\n          {\"type\": \"button\", \"text\": {\"type\": \"plain_text\", \"text\": \"ğŸ“ ìˆ˜ì •ìš”ì²­\", \"emoji\": true}, \"value\": \"revise_{{ $json.github_issue }}_{{ $json.jira_key }}\", \"action_id\": \"revise_action\"}\n        ]\n      }\n    ]\n  }",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2064,
        -2432
      ],
      "id": "95be1cde-caff-4035-8e5b-91ecfc5cc1cb",
      "name": "HTTP Request",
      "credentials": {
        "slackApi": {
          "id": "JudHaRQYOjQVx9Xo",
          "name": "DevOps Bot"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "slack-interactive",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        1728,
        -1808
      ],
      "id": "5490496f-4e02-4d48-a392-8c40d787ae1f",
      "name": "Slack Interactive",
      "webhookId": "6157c06d-e687-49ce-a0b1-a53ebc80d8b9"
    },
    {
      "parameters": {
        "jsCode": "const payload = JSON.parse($input.first().json.body.payload);\nconst action = payload.actions[0];\nconst actionId = action.action_id;\nconst value = action.value || '';\nconst user = payload.user.name;\nconst channel = payload.channel.id;\n\nconst responseUrl = payload.response_url;\nconst messageTs = payload.message.ts;\n\nlet actionType = '';\nlet issueNumber = '';\nlet issueNum = '';\nlet jiraKey = '';\nlet prNumber = '';\nlet repoName = '';\nlet aiSuggestion = '';\n\n// AI ë¦¬ë·° ì ìš© ì•¡ì…˜ (apply_review|PRë²ˆí˜¸|ì´ìŠˆë²ˆí˜¸|ë ˆí¬ëª…)\nif (actionId === 'apply_ai_review') {\n  const parts = value.split('|');\n  actionType = 'apply_ai_review';\n  prNumber = parts[1] || '';\n  issueNum = parts[2] || '';\n  issueNumber = issueNum ? '#' + issueNum : '';\n  repoName = parts[3] || 'ryu-qqq/infrastructure';\n  \n  // ë©”ì‹œì§€ì—ì„œ AI ì œì•ˆ ì¶”ì¶œ\n  const blocks = payload.message.blocks || [];\n  for (const block of blocks) {\n    if (block.text && block.text.text && block.text.text.includes('AI ìˆ˜ì • ì œì•ˆ')) {\n      aiSuggestion = block.text.text.replace('*ğŸ¤– AI ìˆ˜ì • ì œì•ˆ:*\\n', '');\n    }\n  }\n} \n// ë¦¬ë·° ë¬´ì‹œ ì•¡ì…˜\nelse if (actionId === 'ignore_review') {\n  const parts = value.split('|');\n  actionType = 'ignore_review';\n  prNumber = parts[1] || '';\n}\n// ê¸°ì¡´ ìŠ¹ì¸/ê±°ì ˆ/ìˆ˜ì •ìš”ì²­ ì•¡ì…˜ (approve_#123_JIRA-456)\nelse {\n  const parts = value.split('_');\n  actionType = parts[0];\n  issueNumber = parts[1] || '';\n  jiraKey = parts.slice(2).join('_');\n  issueNum = issueNumber.replace('#', '');\n}\n\nconst blocks = payload.message.blocks || [];\nlet issueTitle = '';\nlet issueBody = '';\nlet prUrl = '';\nlet prTitle = '';\n\nfor (const block of blocks) {\n  if (block.text && block.text.text) {\n    const text = block.text.text;\n    if (text.startsWith('*ì œëª©:*')) {\n      issueTitle = text.replace('*ì œëª©:* ', '');\n    }\n    if (text.startsWith('*ë‚´ìš©:*')) {\n      issueBody = text.replace('*ë‚´ìš©:*\\n```', '').replace('```', '');\n    }\n    // PR ì •ë³´ ì¶”ì¶œ\n    if (text.includes('*PR:*')) {\n      const prMatch = text.match(/<([^|]+)\\|#(\\d+)>\\s*(.*)/);\n      if (prMatch) {\n        prUrl = prMatch[1];\n        prNumber = prNumber || prMatch[2];\n        prTitle = prMatch[3];\n      }\n    }\n  }\n  if (block.fields) {\n    for (const field of block.fields) {\n      if (field.text && field.text.startsWith('*ì œëª©:*')) {\n        issueTitle = field.text.replace('*ì œëª©:*\\n', '');\n      }\n      if (field.text && field.text.includes('*PR:*')) {\n        const prMatch = field.text.match(/<([^|]+)\\|#(\\d+)>/);\n        if (prMatch) {\n          prUrl = prMatch[1];\n          prNumber = prNumber || prMatch[2];\n        }\n      }\n    }\n  }\n}\n\nconst actionLabels = {\n  'approve': 'âœ… ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘...',\n  'reject': 'âŒ ê±°ì ˆ ì²˜ë¦¬ ì¤‘...',\n  'revise': 'ğŸ“ ìˆ˜ì •ìš”ì²­ ì²˜ë¦¬ ì¤‘...',\n  'apply_ai_review': 'ğŸ¤– AI ìˆ˜ì • ì ìš© ì¤‘...',\n  'ignore_review': 'âŒ ë¦¬ë·° ë¬´ì‹œë¨'\n};\n\nreturn {\n  actionType,\n  issueNumber,\n  issueNum,\n  jiraKey,\n  prNumber,\n  prUrl,\n  prTitle,\n  repoName,\n  aiSuggestion,\n  user,\n  channel,\n  issueTitle,\n  issueBody,\n  responseUrl,\n  messageTs,\n  actionLabel: actionLabels[actionType] || 'ì²˜ë¦¬ ì¤‘...'\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1952,
        -1808
      ],
      "id": "b2bada38-2c90-41ef-a03e-60d5700a84d7",
      "name": "Parse Action"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $json.responseUrl }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"replace_original\": true,\n  \"blocks\": [\n    {\n      \"type\": \"header\",\n      \"text\": {\"type\": \"plain_text\", \"text\": \"ğŸ—ï¸ ì¸í”„ë¼ ë³€ê²½ ìš”ì²­\", \"emoji\": true}\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\"type\": \"mrkdwn\", \"text\": \"*Issue:*\\n{{ $json.issueNumber }}\"},\n        {\"type\": \"mrkdwn\", \"text\": \"*Jira:*\\n{{ $json.jiraKey }}\"}\n      ]\n    },\n    {\"type\": \"divider\"},\n    {\n      \"type\": \"section\",\n      \"text\": {\"type\": \"mrkdwn\", \"text\": \"{{ $json.actionLabel }}\\n\\n*ì²˜ë¦¬ì:* {{ $json.user }}\"}\n    },\n    {\n      \"type\": \"context\",\n      \"elements\": [\n        {\"type\": \"mrkdwn\", \"text\": \"â³ ìš”ì²­ì´ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...\"}\n      ]\n    }\n  ]\n}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2160,
        -1904
      ],
      "id": "ac0a4d75-28b8-4fa8-ad61-5c49d23f0454",
      "name": "Disable Buttons"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Parse Action').first().json.actionType }}",
                    "rightValue": "approve",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "d962c46a-41a7-42fb-a0a3-0c7765df6ad2"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "162966e8-6925-4fa9-bc8c-a7933ff8990e",
                    "leftValue": "={{ $('Parse Action').first().json.actionType }}",
                    "rightValue": "reject",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "d4d4fa7d-39fc-42ee-aa51-3fa674dc8583",
                    "leftValue": "={{ $('Parse Action').first().json.actionType }}",
                    "rightValue": "revise",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "e5f6a7b8-c9d0-1234-ef56-789012345678",
                    "leftValue": "={{ $('Parse Action').first().json.actionType }}",
                    "rightValue": "apply_ai_review",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "f6a7b8c9-d0e1-2345-f678-901234567890",
                    "leftValue": "={{ $('Parse Action').first().json.actionType }}",
                    "rightValue": "ignore_review",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        2368,
        -1808
      ],
      "id": "01c37a8e-d3bd-49c9-b425-ca1f41f2c1ca",
      "name": "Route Action"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://ryuqqq.atlassian.net/rest/api/3/issue/{{ $('Extract SHA').first().json.jiraKey }}/transitions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "jiraSoftwareCloudApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n    \"transition\": {\n      \"id\": \"21\"\n    }\n  }\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2944,
        -2016
      ],
      "id": "04351277-08d0-4bb3-a1d4-e18f80f9a0fc",
      "name": "Update Jira",
      "credentials": {
        "jiraSoftwareCloudApi": {
          "id": "tOQBMtEJQivj7pgn",
          "name": "Jira SW Cloud account"
        }
      }
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o",
          "mode": "list",
          "cachedResultName": "GPT-4O"
        },
        "responses": {
          "values": [
            {
              "content": "=System:\n  ë‹¹ì‹ ì€ AWS ì¸í”„ë¼ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. Terraform ì½”ë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.\n\n  [ì»¨ë²¤ì…˜]\n  - í•„ìˆ˜ íƒœê·¸: Owner, CostCenter, Environment, Lifecycle, DataClass, Service\n  - ëª¨ë“  íƒœê·¸ëŠ” merge(local.required_tags, {...}) íŒ¨í„´ ì‚¬ìš©\n  - KMS ì•”í˜¸í™” í•„ìˆ˜ (AES256 ê¸ˆì§€)\n  - ë„¤ì´ë°: ë¦¬ì†ŒìŠ¤ëŠ” kebab-case, ë³€ìˆ˜ëŠ” snake_case\n\n  [ì¶œë ¥ í˜•ì‹ - ë°˜ë“œì‹œ ì´ í˜•ì‹ì„ ë”°ë¥´ì„¸ìš”]\n  ê° íŒŒì¼ì„ ì•„ë˜ í˜•ì‹ìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ ì¶œë ¥í•˜ì„¸ìš”:\n\n  ---FILE: terraform/environments/prod/{ì„œë¹„ìŠ¤ëª…}/main.tf---\n  (main.tf ë‚´ìš©)\n  ---END FILE---\n\n  ---FILE: terraform/environments/prod/{ì„œë¹„ìŠ¤ëª…}/variables.tf---\n  (variables.tf ë‚´ìš©)\n  ---END FILE---\n\n  ---FILE: terraform/environments/prod/{ì„œë¹„ìŠ¤ëª…}/outputs.tf---\n  (outputs.tf ë‚´ìš©)\n  ---END FILE---\n\n  User:\n  ë‹¤ìŒ GitHub ì´ìŠˆë¥¼ ë¶„ì„í•˜ê³  Terraform ì½”ë“œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.\n\n  ì œëª©: {{ $('Parse Action').item.json.issueTitle }}\n\n  ë‚´ìš©:\n  {{ $('Parse Action').item.json.issueBody }}\n"
            }
          ]
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2.1,
      "position": [
        3120,
        -2016
      ],
      "id": "df30bf6e-64f6-46f1-9c49-7e63e1f3d9fa",
      "name": "Generate Code",
      "credentials": {
        "openAiApi": {
          "id": "Ula5jc00tgdawbTH",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// OpenAI ì‘ë‹µ êµ¬ì¡° í™•ì¸ - ì—¬ëŸ¬ ê°€ëŠ¥í•œ ê²½ë¡œ ì‹œë„\nconst input = $input.first().json;\nlet aiResponse = '';\n\n// n8n OpenAI ë…¸ë“œì˜ ë‹¤ì–‘í•œ ì‘ë‹µ êµ¬ì¡° ì²˜ë¦¬\nif (input.output && Array.isArray(input.output)) {\n  // êµ¬ì¡°: output[0].content[0].text\n  aiResponse = input.output[0]?.content?.[0]?.text || '';\n} else if (input.message && input.message.content) {\n  // êµ¬ì¡°: message.content\n  aiResponse = input.message.content;\n} else if (input.choices && input.choices[0]) {\n  // êµ¬ì¡°: choices[0].message.content\n  aiResponse = input.choices[0].message?.content || '';\n} else if (input.text) {\n  // êµ¬ì¡°: text\n  aiResponse = input.text;\n} else if (typeof input === 'string') {\n  aiResponse = input;\n} else {\n  // ì „ì²´ ì…ë ¥ì„ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ë””ë²„ê¹…\n  aiResponse = JSON.stringify(input);\n}\n\nconst extractSha = $('Extract SHA').first().json;\n\n// íŒŒì¼ë³„ë¡œ íŒŒì‹±\nconst fileRegex = /---FILE:\\s*([^-]+)---([\\s\\S]*?)---END FILE---/g;\nconst files = [];\nlet match;\n\nwhile ((match = fileRegex.exec(aiResponse)) !== null) {\n  const filePath = match[1].trim();\n  let content = match[2].trim();\n  // ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ ì œê±° (```hcl, ```terraform, ``` ë“±)\n  content = content.replace(/^```(?:hcl|terraform|tf)?\\n?/i, '').replace(/\\n?```$/g, '').trim();\n  if (filePath && content) {\n    files.push({ path: filePath, content: content });\n  }\n}\n\n// íŒŒì¼ì´ ì—†ìœ¼ë©´ ì „ì²´ë¥¼ ë‹¨ì¼ íŒŒì¼ë¡œ ì²˜ë¦¬\nif (files.length === 0 && aiResponse.length > 100) {\n  // ì´ìŠˆ ì œëª©ì—ì„œ ì„œë¹„ìŠ¤ëª… ì¶”ì¶œ ì‹œë„\n  const issueTitle = extractSha.issueTitle || '';\n  const serviceName = issueTitle.toLowerCase().replace(/[^a-z0-9]/g, '-').substring(0, 30) || 'infra-change';\n  files.push({\n    path: `terraform/environments/prod/${serviceName}/main.tf`,\n    content: aiResponse\n  });\n}\n\nconst issueNum = extractSha.issueNum;\n// ë¸Œëœì¹˜ëª…ì—ì„œ # ì œê±°\nconst branchName = `feature/issue-${issueNum}`;\nconst githubUrl = `https://github.com/ryu-qqq/infrastructure/issues/${issueNum}`;\n\nreturn {\n  user: extractSha.user,\n  channel: extractSha.channel,\n  issueNumber: extractSha.issueNumber,\n  issueNum: issueNum,\n  jiraKey: extractSha.jiraKey,\n  branchName: branchName,\n  branchSha: extractSha.sha,\n  files: files,\n  fileCount: files.length,\n  filePaths: files.map(f => f.path).join(', '),\n  githubUrl: githubUrl,\n  responseUrl: extractSha.responseUrl,\n  rawResponse: aiResponse.substring(0, 500),\n  debug: { inputKeys: Object.keys(input), responseLength: aiResponse.length }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3296,
        -2016
      ],
      "id": "edffa7c6-1e28-47b8-ad50-9096d857463c",
      "name": "Parse Code Files"
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\nconst files = data.files;\nconst branchName = data.branchName;\n\n// ê° íŒŒì¼ì„ ìˆœì°¨ì ìœ¼ë¡œ ì»¤ë°‹í•˜ê¸° ìœ„í•´ ë°°ì—´ë¡œ ë°˜í™˜\n// SplitInBatches ë…¸ë“œì™€ í•¨ê»˜ ì‚¬ìš©\nreturn files.map((file, index) => ({\n  ...data,\n  currentFile: file,\n  fileIndex: index,\n  isLastFile: index === files.length - 1\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3472,
        -2016
      ],
      "id": "8e2683f2-e6d7-4aee-8476-f27f3a8deea3",
      "name": "Prepare Commits"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        3648,
        -2016
      ],
      "id": "2cff0c1e-a556-422d-8396-b99e727fb639",
      "name": "Split Files"
    },
    {
      "parameters": {
        "jsCode": "// Base64 ì¸ì½”ë”© í•¨ìˆ˜\nfunction btoa(str) {\n  return Buffer.from(str, 'utf-8').toString('base64');\n}\n\nconst data = $input.first().json;\nconst content = data.currentFile.content;\nconst base64Content = btoa(content);\n\nreturn {\n  ...data,\n  base64Content: base64Content\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3824,
        -2128
      ],
      "id": "18ae52e1-0381-4c60-8886-dabb89ccf905",
      "name": "Encode Base64"
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "=https://api.github.com/repos/ryu-qqq/infrastructure/contents/{{ $json.currentFile.path }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "githubApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/vnd.github.v3+json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"message\": \"feat: add {{ $json.currentFile.path }} - AI generated for {{ $json.issueNumber }}\",\n  \"content\": \"{{ $json.base64Content }}\",\n  \"branch\": \"{{ $json.branchName }}\"\n}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        4000,
        -2128
      ],
      "id": "5bf51111-c588-439c-9314-e05173dba911",
      "name": "Commit File to Branch",
      "credentials": {
        "githubApi": {
          "id": "uJpJHjMJj6qdmUVx",
          "name": "Infrastructure GitHub"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "check-last-file",
              "leftValue": "={{ $json.isLastFile }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4176,
        -2128
      ],
      "id": "c9937b2e-4825-40db-8fae-de8247b29d3b",
      "name": "Is Last File?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.github.com/repos/ryu-qqq/infrastructure/pulls",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "githubApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/vnd.github.v3+json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"title\": \"[AI Generated] {{ $('Parse Code Files').first().json.issueNumber }}: {{ $('Parse Action').first().json.issueTitle }}\",\n  \"head\": \"{{ $('Parse Code Files').first().json.branchName }}\",\n  \"base\": \"main\",\n  \"body\": \"## ğŸ¤– AI ìƒì„± ì½”ë“œ\\n\\n**ê´€ë ¨ ì´ìŠˆ:** #{{ $('Parse Code Files').first().json.issueNum }}\\n**Jira:** {{ $('Parse Code Files').first().json.jiraKey }}\\n**ìŠ¹ì¸ì:** {{ $('Parse Code Files').first().json.user }}\\n\\n---\\n\\n### ğŸ“ ìƒì„±ëœ íŒŒì¼\\n{{ $('Parse Code Files').first().json.filePaths }}\\n\\n---\\n\\n> ì´ PRì€ AIì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.\\n> CodeRabbitê³¼ Geminiì˜ ë¦¬ë·°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.\",\n  \"draft\": true\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        4352,
        -2224
      ],
      "id": "0a449a02-65da-4448-8820-8bd9c4baa512",
      "name": "Create Draft PR",
      "credentials": {
        "githubApi": {
          "id": "uJpJHjMJj6qdmUVx",
          "name": "Infrastructure GitHub"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const prData = $input.first().json;\nconst parseCodeFiles = $('Parse Code Files').first().json;\n\nreturn {\n  prNumber: prData.number,\n  prUrl: prData.html_url,\n  prTitle: prData.title,\n  user: parseCodeFiles.user,\n  channel: parseCodeFiles.channel,\n  issueNumber: parseCodeFiles.issueNumber,\n  issueNum: parseCodeFiles.issueNum,\n  jiraKey: parseCodeFiles.jiraKey,\n  fileCount: parseCodeFiles.fileCount,\n  filePaths: parseCodeFiles.filePaths,\n  githubUrl: parseCodeFiles.githubUrl,\n  responseUrl: parseCodeFiles.responseUrl\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4528,
        -2224
      ],
      "id": "2bb3a722-b249-46d5-aaa3-4a408ec135d3",
      "name": "Format PR Response"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://slack.com/api/chat.postMessage",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "slackApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n    \"channel\": \"{{ $json.channel }}\",\n    \"blocks\": [\n      {\n        \"type\": \"header\",\n        \"text\": {\"type\": \"plain_text\", \"text\": \"âœ… Draft PR ìƒì„± ì™„ë£Œ\", \"emoji\": true}\n      },\n      {\n        \"type\": \"section\",\n        \"fields\": [\n          {\"type\": \"mrkdwn\", \"text\": \"*ğŸ‘¤ ìŠ¹ì¸ì*\\n{{ $json.user }}\"},\n          {\"type\": \"mrkdwn\", \"text\": \"*ğŸ“ íŒŒì¼ ìˆ˜*\\n{{ $json.fileCount }}ê°œ\"}\n        ]\n      },\n      {\n        \"type\": \"section\",\n        \"fields\": [\n          {\"type\": \"mrkdwn\", \"text\": \"*ğŸ“Œ Issue*\\n<{{ $json.githubUrl }}|{{ $json.issueNumber }}>\"},\n          {\"type\": \"mrkdwn\", \"text\": \"*ğŸ« Jira*\\n{{ $json.jiraKey }}\"}\n        ]\n      },\n      {\"type\": \"divider\"},\n      {\n        \"type\": \"section\",\n        \"text\": {\"type\": \"mrkdwn\", \"text\": \"*ğŸ”— Pull Request:*\\n<{{ $json.prUrl }}|PR #{{ $json.prNumber }}>\"}\n      },\n      {\n        \"type\": \"context\",\n        \"elements\": [\n          {\"type\": \"mrkdwn\", \"text\": \"ğŸ¤– CodeRabbitê³¼ Geminiê°€ ê³§ ë¦¬ë·°ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. ë¦¬ë·° ì™„ë£Œ ì‹œ ì•Œë¦¼ì„ ë°›ê²Œ ë©ë‹ˆë‹¤.\"}\n        ]\n      }\n    ]\n  }",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        4704,
        -2224
      ],
      "id": "ad9352a3-0c25-43d3-80e2-37e182560824",
      "name": "Slack PR Result",
      "credentials": {
        "slackApi": {
          "id": "JudHaRQYOjQVx9Xo",
          "name": "DevOps Bot"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Parse Code Files').first().json.responseUrl }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"replace_original\": true,\n  \"blocks\": [\n    {\n      \"type\": \"header\",\n      \"text\": {\"type\": \"plain_text\", \"text\": \"âœ… ìŠ¹ì¸ ì™„ë£Œ - Draft PR ìƒì„±ë¨\", \"emoji\": true}\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\"type\": \"mrkdwn\", \"text\": \"*Issue:*\\n{{ $('Parse Code Files').first().json.issueNumber }}\"},\n        {\"type\": \"mrkdwn\", \"text\": \"*Jira:*\\n{{ $('Parse Code Files').first().json.jiraKey }}\"}\n      ]\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\"type\": \"mrkdwn\", \"text\": \"*ìŠ¹ì¸ì:*\\n{{ $('Parse Code Files').first().json.user }}\"},\n        {\"type\": \"mrkdwn\", \"text\": \"*PR:*\\n<{{ $json.prUrl }}|#{{ $json.prNumber }}>\"}\n      ]\n    },\n    {\n      \"type\": \"context\",\n      \"elements\": [\n        {\"type\": \"mrkdwn\", \"text\": \"âœ… AI ì½”ë“œê°€ Draft PRë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. CodeRabbit/Gemini ë¦¬ë·°ë¥¼ ê¸°ë‹¤ë¦¬ì„¸ìš”.\"}\n      ]\n    }\n  ]\n}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        4880,
        -2224
      ],
      "id": "1377ae84-0311-48f7-8a16-f4daddd4e0dd",
      "name": "Finalize Approve Message"
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json;\nconst sha = response.object.sha;\nconst parseAction = $('Parse Action').first().json;\n\nreturn {\n  sha: sha,\n  issueNumber: parseAction.issueNumber,\n  issueNum: parseAction.issueNum,\n  jiraKey: parseAction.jiraKey,\n  user: parseAction.user,\n  channel: parseAction.channel,\n  issueTitle: parseAction.issueTitle,\n  issueBody: parseAction.issueBody,\n  responseUrl: parseAction.responseUrl\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2592,
        -2016
      ],
      "id": "aca9c2b7-44ff-4aa0-8398-ba39c13c6d97",
      "name": "Extract SHA"
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json.body;\n\nconst escapedBody = (data.body || '')\n  .replace(/\\\\/g, '\\\\\\\\')\n  .replace(/\"/g, '\\\\\"')\n  .replace(/\\n/g, ' ')\n  .replace(/\\r/g, '');\n\nreturn {\n  github_issue: data.github_issue,\n  jira_key: data.jira_key,\n  title: data.title,\n  body: escapedBody,\n  author: data.author,\n  url: data.url\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1888,
        -2432
      ],
      "id": "5a798d57-e006-4f3c-bef5-2aca22fb90bb",
      "name": "Escape Body"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.github.com/repos/ryu-qqq/infrastructure/git/refs",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "githubApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/vnd.github.v3+json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n    \"ref\": \"refs/heads/feature/issue-{{ $json.issueNum }}\",\n    \"sha\": \"{{ $json.sha }}\"\n  }",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2768,
        -2016
      ],
      "id": "0d0249f1-68d6-4e0b-b243-b06121738020",
      "name": "Create Branch",
      "credentials": {
        "githubApi": {
          "id": "uJpJHjMJj6qdmUVx",
          "name": "Infrastructure GitHub"
        }
      }
    },
    {
      "parameters": {
        "url": "https://api.github.com/repos/ryu-qqq/infrastructure/git/ref/heads/main",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "githubApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/vnd.github.v3+json"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2432,
        -2016
      ],
      "id": "b6980494-92c2-4225-b7b1-80b6eb5eea2e",
      "name": "Get Main SHA",
      "credentials": {
        "githubApi": {
          "id": "uJpJHjMJj6qdmUVx",
          "name": "Infrastructure GitHub"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://ryuqqq.atlassian.net/rest/api/3/issue/{{ $('Parse Action').first().json.jiraKey }}/transitions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "jiraSoftwareCloudApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n    \"transition\": {\n      \"id\": \"41\"\n    }\n  }",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2592,
        -1584
      ],
      "id": "c72994c8-07d4-4be1-8172-6c3760335e69",
      "name": "Update Jira (Reject)",
      "credentials": {
        "jiraSoftwareCloudApi": {
          "id": "tOQBMtEJQivj7pgn",
          "name": "Jira SW Cloud account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.github.com/repos/ryu-qqq/infrastructure/issues/{{ $('Parse Action').first().json.issueNum }}/comments",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "githubApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/vnd.github+v3+json"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"body\": \"## âŒ ìš”ì²­ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤\\n\\n**ê±°ì ˆì:** {{ $('Parse Action').first().json.user }}\\n**Jira:** {{ $('Parse Action').first().json.jiraKey }}\\n\\n---\\n\\nì´ ì¸í”„ë¼ ë³€ê²½ ìš”ì²­ì€ ê²€í†  ê²°ê³¼ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤.\\nì¶”ê°€ ë…¼ì˜ê°€ í•„ìš”í•˜ì‹œë©´ ë‹´ë‹¹ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2816,
        -1584
      ],
      "id": "22b6f954-e81a-4360-8287-d0f42c8fee1d",
      "name": "GitHub Comment (Reject)",
      "credentials": {
        "githubApi": {
          "id": "uJpJHjMJj6qdmUVx",
          "name": "Infrastructure GitHub"
        }
      }
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "=https://api.github.com/repos/ryu-qqq/infrastructure/issues/{{ $('Parse Action').first().json.issueNum }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "githubApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/vnd.github+v3+json"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"state\": \"closed\",\n  \"state_reason\": \"not_planned\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        3040,
        -1584
      ],
      "id": "345ec949-0972-4744-8cc4-5dc6aa102989",
      "name": "Close Issue",
      "credentials": {
        "githubApi": {
          "id": "uJpJHjMJj6qdmUVx",
          "name": "Infrastructure GitHub"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Parse Action').first().json.responseUrl }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"replace_original\": true,\n  \"blocks\": [\n    {\n      \"type\": \"header\",\n      \"text\": {\"type\": \"plain_text\", \"text\": \"âŒ ìš”ì²­ ê±°ì ˆë¨\", \"emoji\": true}\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\"type\": \"mrkdwn\", \"text\": \"*Issue:*\\n{{ $('Parse Action').first().json.issueNumber }}\"},\n        {\"type\": \"mrkdwn\", \"text\": \"*Jira:*\\n{{ $('Parse Action').first().json.jiraKey }}\"}\n      ]\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\"type\": \"mrkdwn\", \"text\": \"*ê±°ì ˆì:*\\n{{ $('Parse Action').first().json.user }}\"},\n        {\"type\": \"mrkdwn\", \"text\": \"*ìƒíƒœ:*\\nCancelled\"}\n      ]\n    },\n    {\n      \"type\": \"context\",\n      \"elements\": [\n        {\"type\": \"mrkdwn\", \"text\": \"âŒ ì´ ìš”ì²­ì€ ê±°ì ˆë˜ì–´ GitHub Issueê°€ ë‹«í˜”ìŠµë‹ˆë‹¤.\"}\n      ]\n    }\n  ]\n}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        3264,
        -1584
      ],
      "id": "7ba34957-b4e4-4751-90c6-957d4d014707",
      "name": "Finalize Reject Message"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://ryuqqq.atlassian.net/rest/api/3/issue/{{ $('Parse Action').first().json.jiraKey }}/transitions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "jiraSoftwareCloudApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n    \"transition\": {\n      \"id\": \"51\"\n    }\n  }",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2592,
        -1360
      ],
      "id": "2691d0ae-cad7-47e5-9bba-cac09c45237a",
      "name": "Update Jira (Revise)",
      "credentials": {
        "jiraSoftwareCloudApi": {
          "id": "tOQBMtEJQivj7pgn",
          "name": "Jira SW Cloud account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.github.com/repos/ryu-qqq/infrastructure/issues/{{ $('Parse Action').first().json.issueNum }}/comments",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "githubApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/vnd.github+v3+json"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"body\": \"## ğŸ“ ìˆ˜ì •ì´ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤\\n\\n**ìš”ì²­ì:** {{ $('Parse Action').first().json.user }}\\n**Jira:** {{ $('Parse Action').first().json.jiraKey }}\\n\\n---\\n\\nì´ ì¸í”„ë¼ ë³€ê²½ ìš”ì²­ì— ëŒ€í•´ ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.\\nì´ìŠˆ ë‚´ìš©ì„ ë³´ì™„í•˜ì—¬ ë‹¤ì‹œ ê²€í†  ìš”ì²­í•´ì£¼ì„¸ìš”.\\n\\n### ìˆ˜ì • í›„ ì¬ê²€í†  ë°©ë²•\\n1. ì´ìŠˆ ë‚´ìš©ì„ ìˆ˜ì •í•˜ì„¸ìš”\\n2. `needs-review` ë¼ë²¨ì„ ì¶”ê°€í•˜ì„¸ìš”\\n3. ë‹´ë‹¹ìê°€ ë‹¤ì‹œ ê²€í† í•©ë‹ˆë‹¤\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2816,
        -1360
      ],
      "id": "7f779d1a-6858-4c04-8928-523183932604",
      "name": "GitHub Comment (Revise)",
      "credentials": {
        "githubApi": {
          "id": "uJpJHjMJj6qdmUVx",
          "name": "Infrastructure GitHub"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Parse Action').first().json.responseUrl }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"replace_original\": true,\n  \"blocks\": [\n    {\n      \"type\": \"header\",\n      \"text\": {\"type\": \"plain_text\", \"text\": \"ğŸ“ ìˆ˜ì • ìš”ì²­ë¨\", \"emoji\": true}\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\"type\": \"mrkdwn\", \"text\": \"*Issue:*\\n{{ $('Parse Action').first().json.issueNumber }}\"},\n        {\"type\": \"mrkdwn\", \"text\": \"*Jira:*\\n{{ $('Parse Action').first().json.jiraKey }}\"}\n      ]\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\"type\": \"mrkdwn\", \"text\": \"*ìš”ì²­ì:*\\n{{ $('Parse Action').first().json.user }}\"},\n        {\"type\": \"mrkdwn\", \"text\": \"*ìƒíƒœ:*\\nBlocked (ìˆ˜ì • ëŒ€ê¸°)\"}\n      ]\n    },\n    {\n      \"type\": \"context\",\n      \"elements\": [\n        {\"type\": \"mrkdwn\", \"text\": \"ğŸ“ GitHub Issueì— ìˆ˜ì •ìš”ì²­ ì½”ë©˜íŠ¸ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ìŠˆ ìˆ˜ì • í›„ ì¬ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤.\"}\n      ]\n    }\n  ]\n}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        3040,
        -1360
      ],
      "id": "65004316-cf1d-424d-90b1-0ff4372600fa",
      "name": "Finalize Revise Message"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "pr-review",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        1728,
        -832
      ],
      "id": "266dfed0-e1b7-4b1d-a4a0-bcd7751d2253",
      "name": "PR Review Webhook",
      "webhookId": "pr-review-webhook-id"
    },
    {
      "parameters": {
        "jsCode": "let data = $input.first().json.body;\n\n  // bodyê°€ ë°°ì—´ì´ë©´ ì²« ë²ˆì§¸ ìš”ì†Œ ì‚¬ìš©\n  if (Array.isArray(data)) {\n    data = data[0];\n  }\n\n  // ì´ë¯¸ í”Œë«í•œ í˜•ì‹ì¸ì§€ í™•ì¸ (reviewerë‚˜ prNumberê°€ ì§ì ‘ ìˆìœ¼ë©´ í”Œë«)\n  const isFlat = data.reviewer !== undefined || data.prNumber !== undefined;\n\n  if (isFlat) {\n    // í”Œë«í•œ í˜•ì‹ - ì§ì ‘ ì†ì„± ì ‘ê·¼\n    const reviewBody = data.reviewBody || '';\n    let reviewSummary = reviewBody.substring(0, 500) + (reviewBody.length > 500 ? '...' : '');\n    reviewSummary = reviewSummary\n      .replace(/\\n/g, ' ')\n      .replace(/\\r/g, '')\n      .replace(/\"/g, \"'\")\n      .replace(/\\\\/g, '')\n      .replace(/[\\x00-\\x1F]/g, '');\n\n    const prTitle = data.prTitle || '';\n    const safePrTitle = prTitle\n      .replace(/\"/g, \"'\")\n      .replace(/\\\\/g, '')\n      .replace(/[\\x00-\\x1F]/g, '');\n\n    return {\n      action: data.action || 'submitted',\n      reviewer: data.reviewer || 'unknown',\n      reviewerType: data.reviewerType || 'human',\n      reviewState: data.reviewState || 'commented',\n      reviewBody: reviewBody,\n      reviewSummary: reviewSummary,\n      prNumber: data.prNumber,\n      prTitle: safePrTitle,\n      prUrl: data.prUrl || '',\n      prAuthor: data.prAuthor || '',\n      issueNum: data.issueNum || null,\n      repoName: data.repoName || 'ryu-qqq/infrastructure'\n    };\n  }\n\n  // GitHub ì›ë³¸ í˜•ì‹ ì²˜ë¦¬ (fallback)\n  const action = data.action;\n  const review = data.review || {};\n  const pr = data.pull_request || {};\n  const repo = data.repository || {};\n\n  const reviewer = review.user?.login || 'unknown';\n  const reviewState = review.state || 'commented';\n  const reviewBody = review.body || '';\n\n  const prNumber = pr.number;\n  const prTitle = pr.title || '';\n  const prUrl = pr.html_url || '';\n  const prAuthor = pr.user?.login || '';\n\n  const issueMatch = prTitle.match(/#(\\d+)/);\n  const issueNum = issueMatch ? issueMatch[1] : null;\n\n  let reviewerType = 'human';\n  if (reviewer.includes('coderabbit') || reviewer === 'coderabbitai') {\n    reviewerType = 'coderabbit';\n  } else if (reviewer.includes('gemini') || reviewer.includes('google')) {\n    reviewerType = 'gemini';\n  }\n\n  let reviewSummary = reviewBody.substring(0, 500) + (reviewBody.length > 500 ? '...' : '');\n  reviewSummary = reviewSummary\n    .replace(/\\n/g, ' ')\n    .replace(/\\r/g, '')\n    .replace(/\"/g, \"'\")\n    .replace(/\\\\/g, '')\n    .replace(/[\\x00-\\x1F]/g, '');\n\n  const safePrTitle = prTitle\n    .replace(/\"/g, \"'\")\n    .replace(/\\\\/g, '')\n    .replace(/[\\x00-\\x1F]/g, '');\n\n  return {\n    action,\n    reviewer,\n    reviewerType,\n    reviewState,\n    reviewBody,\n    reviewSummary,\n    prNumber,\n    prTitle: safePrTitle,\n    prUrl,\n    prAuthor,\n    issueNum,\n    repoName: repo.full_name || 'ryu-qqq/infrastructure'\n  };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1952,
        -832
      ],
      "id": "c8109b44-39de-494e-89df-be4c54667db2",
      "name": "Parse PR Review"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "check-submitted",
              "leftValue": "={{ $json.action }}",
              "rightValue": "submitted",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2128,
        -832
      ],
      "id": "8bcaecbc-13f3-43d7-89d9-9812f9ac8052",
      "name": "Is Review Submitted?"
    },
    {
      "parameters": {
        "url": "=https://api.github.com/repos/{{ $json.repoName }}/pulls/{{ $json.prNumber }}/files",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "githubApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/vnd.github.v3+json"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2304,
        -832
      ],
      "id": "43c19431-cf7c-4a64-ba69-e27813e9435b",
      "name": "Fetch PR Files",
      "credentials": {
        "githubApi": {
          "id": "uJpJHjMJj6qdmUVx",
          "name": "Infrastructure GitHub"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ëª¨ë“  itemsë¥¼ ë°°ì—´ë¡œ ìˆ˜ì§‘\n  const prFiles = $input.all().map(item => item.json);\n  const reviewData = $('Parse PR Review').first().json;\n\n  // ë³€ê²½ëœ íŒŒì¼ ì •ë³´ ìˆ˜ì§‘\n  const files = prFiles.map(f => ({\n    filename: f.filename,\n    status: f.status,\n    patch: f.patch ? f.patch.substring(0, 2000) : '',\n    additions: f.additions,\n    deletions: f.deletions\n  }));\n\n  // íŒŒì¼ ì •ë³´ë¥¼ ìš”ì•½\n  const filesSummary = files.map(f =>\n    `- ${f.filename} (${f.status}, +${f.additions}/-${f.deletions})`\n  ).join('\\n');\n\n  // íŒ¨ì¹˜ ë‚´ìš© (ì²˜ìŒ 5ê°œ íŒŒì¼ë§Œ)\n  const patchContent = files.slice(0, 5).map(f =>\n    `### ${f.filename}\\n\\`\\`\\`diff\\n${f.patch}\\n\\`\\`\\``\n  ).join('\\n\\n');\n\n  return {\n    ...reviewData,\n    files,\n    filesSummary,\n    patchContent,\n    fileCount: files.length\n  };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2480,
        -832
      ],
      "id": "39524bcc-57f4-4762-a3ba-4863f2404e3b",
      "name": "Prepare Review Context"
    },
    {
      "parameters": {
        "jsCode": "const openaiResponse = $input.first().json;\n  const reviewData = $('Prepare Review Context').first().json;\n\n  // OpenAI ì‘ë‹µ íŒŒì‹±\n  const rawText = openaiResponse.output?.[0]?.content?.[0]?.text ||\n                  openaiResponse.choices?.[0]?.message?.content ||\n                  '{}';\n\n  let parsed;\n  try {\n    // JSON ì¶”ì¶œ (í…ìŠ¤íŠ¸ì—ì„œ JSON ë¶€ë¶„ë§Œ)\n    const jsonMatch = rawText.match(/\\{[\\s\\S]*\\}/);\n    parsed = jsonMatch ? JSON.parse(jsonMatch[0]) : {};\n  } catch (e) {\n    parsed = { summary: rawText.substring(0, 500), items: [], recommendation: '' };\n  }\n\n  // ê¸°ë³¸ê°’ ì„¤ì •\n  const summary = parsed.summary || 'ë¶„ì„ ê²°ê³¼ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';\n  const items = parsed.items || [];\n  const recommendation = parsed.recommendation || '';\n\n  // ìš°ì„ ìˆœìœ„ ì´ëª¨ì§€\n  const priorityEmoji = {\n    'high': 'ğŸ”´',\n    'medium': 'ğŸŸ¡',\n    'low': 'ğŸŸ¢'\n  };\n\n  // í•­ëª© ë¦¬ìŠ¤íŠ¸ í¬ë§· (ì¤„ë°”ê¿ˆì„ \\\\nìœ¼ë¡œ ì´ìŠ¤ì¼€ì´í”„)\n  const itemsList = items.map((item, i) =>\n    `${priorityEmoji[item.priority] || 'â€¢'} *${item.title}*: ${item.description}`\n  ).join('\\\\n');\n\n  // ëª¨ë“  ë¬¸ìì—´ì—ì„œ ì¤„ë°”ê¿ˆ ì´ìŠ¤ì¼€ì´í”„\n  const safeSummary = summary.replace(/\\n/g, ' ').replace(/\"/g, \"'\");\n  const safeItems = itemsList.replace(/\"/g, \"'\");\n  const safeRecommendation = recommendation.replace(/\\n/g, ' ').replace(/\"/g, \"'\");\n\n  return {\n    ...reviewData,\n    aiSummary: safeSummary,\n    aiItems: safeItems || 'â€¢ íŠ¹ë³„í•œ ìˆ˜ì • ì‚¬í•­ ì—†ìŒ',\n    aiItemCount: items.length,\n    aiRecommendation: safeRecommendation,\n    aiSuggestionFull: rawText\n  };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2976,
        -832
      ],
      "id": "bfea5776-7cba-4520-abf3-dde5427acbff",
      "name": "Format AI Suggestion"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://slack.com/api/chat.postMessage",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "slackApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n    \"channel\": \"C0A5JRE5K09\",\n    \"blocks\": [\n      {\n        \"type\": \"header\",\n        \"text\": {\"type\": \"plain_text\", \"text\": \"ğŸ¤– AI ë¦¬ë·° ë¶„ì„ ì™„ë£Œ\", \"emoji\": true}\n      },\n      {\n        \"type\": \"section\",\n        \"fields\": [\n          {\"type\": \"mrkdwn\", \"text\": \"*ë¦¬ë·°ì–´:*\\n{{ $json.reviewerType === 'coderabbit' ? 'ğŸ° CodeRabbit' : ($json.reviewerType === 'gemini' ? 'ğŸ’ Gemini' : 'ğŸ‘¤ ' + $json.reviewer) }}\"},\n          {\"type\": \"mrkdwn\", \"text\": \"*PR:*\\n<{{ $json.prUrl }}|#{{ $json.prNumber }}>\"}\n        ]\n      },\n      {\"type\": \"divider\"},\n      {\n        \"type\": \"section\",\n        \"text\": {\"type\": \"mrkdwn\", \"text\": \"*ğŸ“‹ ìš”ì•½:*\\n{{ $json.aiSummary }}\"}\n      },\n      {\n        \"type\": \"section\",\n        \"text\": {\"type\": \"mrkdwn\", \"text\": \"*ğŸ”§ ìˆ˜ì • í•„ìš” í•­ëª© ({{ $json.aiItemCount }}ê°œ):*\\n{{ $json.aiItems }}\"}\n      },\n      {\n        \"type\": \"context\",\n        \"elements\": [\n          {\"type\": \"mrkdwn\", \"text\": \"ğŸ’¡ {{ $json.aiRecommendation }}\"}\n        ]\n      },\n      {\"type\": \"divider\"},\n      {\n        \"type\": \"actions\",\n        \"elements\": [\n          {\"type\": \"button\", \"text\": {\"type\": \"plain_text\", \"text\": \"âœ… ìˆ˜ì • ì ìš©\", \"emoji\": true}, \"style\": \"primary\", \"value\": \"apply_review|{{ $json.prNumber }}|{{ $json.issueNum }}|{{ $json.repoName }}\", \"action_id\": \"apply_ai_review\"},\n          {\"type\": \"button\", \"text\": {\"type\": \"plain_text\", \"text\": \"ğŸ”— PR ë³´ê¸°\", \"emoji\": true}, \"url\": \"{{ $json.prUrl }}\"},\n          {\"type\": \"button\", \"text\": {\"type\": \"plain_text\", \"text\": \"âŒ ë¬´ì‹œ\", \"emoji\": true}, \"value\": \"ignore_review|{{ $json.prNumber }}\", \"action_id\": \"ignore_review\"}\n        ]\n      }\n    ]\n  }\n\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        3200,
        -832
      ],
      "id": "3d9b1a54-6d16-4372-9420-03da79b2d807",
      "name": "Slack Review Suggestion",
      "credentials": {
        "slackApi": {
          "id": "JudHaRQYOjQVx9Xo",
          "name": "DevOps Bot"
        }
      }
    },
    {
      "parameters": {
        "url": "=https://api.github.com/repos/{{ $('Parse Action').first().json.repoName }}/pulls/{{ $('Parse Action').first().json.prNumber }}/files",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "githubApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/vnd.github.v3+json"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2512,
        -544
      ],
      "id": "106f905f-5fa6-4618-8ea8-1b982e0f595c",
      "name": "Fetch PR Files for Apply",
      "credentials": {
        "githubApi": {
          "id": "uJpJHjMJj6qdmUVx",
          "name": "Infrastructure GitHub"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const prFiles = $input.all().map(item => item.json);\n  const parseAction = $('Parse Action').first().json;\n\n  // ë³€ê²½ëœ íŒŒì¼ ì •ë³´ ìˆ˜ì§‘\n  const files = prFiles.map(f => ({\n    filename: f.filename,\n    status: f.status,\n    patch: f.patch ? f.patch.substring(0, 3000) : '',\n    additions: f.additions,\n    deletions: f.deletions,\n    raw_url: f.raw_url,\n    sha: f.sha\n  }));\n\n  // íŒ¨ì¹˜ ë‚´ìš©\n  const patchContent = files.map(f =>\n    `### ${f.filename}\\n\\`\\`\\`diff\\n${f.patch}\\n\\`\\`\\``\n  ).join('\\n\\n');\n\n  return {\n    ...parseAction,\n    files,\n    patchContent,\n    fileCount: files.length\n  };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2688,
        -544
      ],
      "id": "43f55a7e-0399-4cb2-8748-c45fa60a0f80",
      "name": "Prepare Apply Context"
    },
    {
      "parameters": {
        "jsCode": "const openaiResponse = $input.first().json;\nconst applyContext = $('Prepare Apply Context').first().json;\n\n// OpenAI ì‘ë‹µ íŒŒì‹±\nlet aiResponse = openaiResponse.output?.[0]?.content?.[0]?.text ||\n                 openaiResponse.choices?.[0]?.message?.content ||\n                 '';\n\n// ì™¸ë¶€ ì½”ë“œ ë¸”ë¡ ì œê±°\naiResponse = aiResponse.replace(/^```(?:hcl|terraform|tf)?\\n?/i, '').replace(/\\n?```$/g, '');\n\n// ì›ë³¸ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°\nconst originalFiles = applyContext.files || [];\n\n// 1. ì‚­ì œí•  íŒŒì¼ íŒŒì‹±\nconst deleteRegex = /---DELETE:\\s*(.+?)---/g;\nconst filesToDelete = [];\nlet deleteMatch;\n\nwhile ((deleteMatch = deleteRegex.exec(aiResponse)) !== null) {\n  const filePath = deleteMatch[1].trim();\n  const originalFile = originalFiles.find(f => f.filename === filePath);\n  if (filePath) {\n    filesToDelete.push({\n      path: filePath,\n      sha: originalFile?.sha || null\n    });\n  }\n}\n\n// 2. ìƒì„±/ìˆ˜ì •í•  íŒŒì¼ íŒŒì‹±\nconst fileRegex = /---FILE:\\s*(.+?)---\\n?([\\s\\S]*?)---END FILE---/g;\nconst filesToCreate = [];\nlet fileMatch;\n\nwhile ((fileMatch = fileRegex.exec(aiResponse)) !== null) {\n  const filePath = fileMatch[1].trim();\n  let content = fileMatch[2].trim();\n  content = content.replace(/^```(?:hcl|terraform|tf)?\\n?/i, '').replace(/\\n?```$/g, '').trim();\n  const originalFile = originalFiles.find(f => f.filename === filePath);\n  \n  if (filePath && content) {\n    filesToCreate.push({\n      path: filePath,\n      content: content,\n      sha: originalFile?.sha || null,\n      isNewFile: !originalFile\n    });\n  }\n}\n\nconst deleteCount = filesToDelete.length;\nconst createCount = filesToCreate.length;\nconst hasChanges = deleteCount > 0 || createCount > 0;\n\nreturn {\n  ...applyContext,\n  filesToDelete,\n  filesToCreate,\n  deleteCount,\n  createCount,\n  hasChanges,\n  // ê¸°ì¡´ í˜¸í™˜ì„± ìœ ì§€\n  fixedFileCount: deleteCount + createCount,\n  fixedFilePaths: [...filesToDelete.map(f => '(ì‚­ì œ) ' + f.path), ...filesToCreate.map(f => f.path)].join(', '),\n  hasFixedFiles: hasChanges\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3184,
        -544
      ],
      "id": "31640a5b-7ff7-4c03-a6d0-c8660770da40",
      "name": "Parse Fix Files"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-has-fixes",
              "leftValue": "={{ $json.hasFixedFiles }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3360,
        -544
      ],
      "id": "1244d201-f816-4bd9-b1ff-da2594a06f85",
      "name": "Has Fixes?"
    },
    {
      "parameters": {
        "jsCode": "const prBranchInfo = $input.first().json;\nconst parseFixData = $('Parse Fix Files').first().json;\n\nconst branch = prBranchInfo.head?.ref || 'main';\nconst operations = [];\n\n// 1. ì‚­ì œ ì‘ì—… ì¶”ê°€\nconst filesToDelete = parseFixData.filesToDelete || [];\nfilesToDelete.forEach((file, i) => {\n  operations.push({\n    ...parseFixData,\n    branch: branch,\n    operation: 'delete',\n    currentFile: file,\n    sha: file.sha,\n    operationIndex: i\n  });\n});\n\n// 2. ìƒì„±/ìˆ˜ì • ì‘ì—… ì¶”ê°€\nconst filesToCreate = parseFixData.filesToCreate || [];\nfilesToCreate.forEach((file, i) => {\n  operations.push({\n    ...parseFixData,\n    branch: branch,\n    operation: file.isNewFile ? 'create' : 'update',\n    currentFile: file,\n    sha: file.sha,\n    operationIndex: filesToDelete.length + i\n  });\n});\n\n// ë§ˆì§€ë§‰ ì‘ì—… í‘œì‹œ\nif (operations.length > 0) {\n  operations[operations.length - 1].isLastOperation = true;\n}\n\nreturn operations;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3712,
        -560
      ],
      "id": "b68c7318-0d4a-41aa-aebc-252edbdce644",
      "name": "Prepare Fix Commits"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        3888,
        -560
      ],
      "id": "59dec03c-6ad3-496c-9443-6bd44c5d9818",
      "name": "Split Fix Files"
    },
    {
      "parameters": {
        "url": "=https://api.github.com/repos/{{ $json.repoName }}/contents/{{ $json.currentFile.path }}?ref={{ $json.branch }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "githubApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/vnd.github.v3+json"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        4176,
        -464
      ],
      "id": "ef7f5444-f15e-49b1-a496-25aa9b86a62a",
      "name": "Get File SHA",
      "credentials": {
        "githubApi": {
          "id": "uJpJHjMJj6qdmUVx",
          "name": "Infrastructure GitHub"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "const prevData = $('Split Fix Files').first().json;\nconst fileInfo = $input.first().json;\n\n// ê¸°ì¡´ íŒŒì¼ì˜ SHA ê°€ì ¸ì˜¤ê¸° (ì—…ë°ì´íŠ¸ ì‹œ í•„ìš”)\nconst existingSha = fileInfo.sha || null;\n\nreturn {\n  ...prevData,\n  existingSha\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4352,
        -464
      ],
      "id": "72cf07dc-3886-4f1d-a3bc-e82b78b499f4",
      "name": "Extract File SHA",
      "disabled": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-is-delete",
              "leftValue": "={{ $json.operation }}",
              "rightValue": "delete",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4176,
        -560
      ],
      "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
      "name": "Is Delete?"
    },
    {
      "parameters": {
        "jsCode": "// Base64 ì¸ì½”ë”© í•¨ìˆ˜\nfunction btoa(str) {\n  return Buffer.from(str, 'utf-8').toString('base64');\n}\n\nconst data = $input.first().json;\nconst content = data.currentFile.content;\nconst base64Content = btoa(content);\n\nreturn {\n  ...data,\n  base64Content: base64Content\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4352,
        -656
      ],
      "id": "b2c3d4e5-f6a7-8901-bcde-f23456789012",
      "name": "Encode Fix Base64"
    },
    {
      "parameters": {
        "method": "DELETE",
        "url": "=https://api.github.com/repos/{{ $json.repoName }}/contents/{{ $json.currentFile.path }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "githubApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/vnd.github.v3+json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n    \"message\": \"refactor: delete {{ $json.currentFile.path }} - AI review\",\n    \"sha\": \"{{ $json.sha }}\",\n    \"branch\": \"{{ $json.branch }}\"\n  }",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        4352,
        -656
      ],
      "id": "b2c3d4e5-f6a7-8901-bcde-f23456789012",
      "name": "Delete File",
      "credentials": {
        "githubApi": {
          "id": "uJpJHjMJj6qdmUVx",
          "name": "Infrastructure GitHub"
        }
      }
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "=https://api.github.com/repos/{{ $json.repoName }}/contents/{{ $json.currentFile.path }}?ref={{ $json.branch }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "githubApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/vnd.github.v3+json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ Object.assign({ message: 'fix: apply AI review suggestions for ' + $json.currentFile.path, content: $json.base64Content, branch: $json.branch }, $json.sha ? { sha: $json.sha } : {}) }}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        4528,
        -464
      ],
      "id": "826ca3a2-eb06-491a-8095-51b56005ba57",
      "name": "Create/Update File",
      "credentials": {
        "githubApi": {
          "id": "uJpJHjMJj6qdmUVx",
          "name": "Infrastructure GitHub"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-last-fix-file",
              "leftValue": "={{ $json.isLastOperation }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4704,
        -464
      ],
      "id": "621e28c1-84a2-405f-be01-b83fa25115af",
      "name": "Is Last Operation?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://slack.com/api/chat.postMessage",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "slackApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"channel\": \"{{ $('Parse Action').first().json.channel }}\",\n  \"blocks\": [\n    {\n      \"type\": \"header\",\n      \"text\": {\"type\": \"plain_text\", \"text\": \"âœ… AI ìˆ˜ì • ì ìš© ì™„ë£Œ\", \"emoji\": true}\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\"type\": \"mrkdwn\", \"text\": \"*ğŸ‘¤ ì ìš©ì*\\n{{ $('Parse Action').first().json.user }}\"},\n        {\"type\": \"mrkdwn\", \"text\": \"*ğŸ“ ìˆ˜ì • íŒŒì¼*\\n{{ $('Parse Fix Files').first().json.fixedFileCount }}ê°œ\"}\n      ]\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\"type\": \"mrkdwn\", \"text\": \"*ìˆ˜ì •ëœ íŒŒì¼:*\\n{{ $('Parse Fix Files').first().json.fixedFilePaths }}\"}\n    },\n    {\"type\": \"divider\"},\n    {\n      \"type\": \"section\",\n      \"text\": {\"type\": \"mrkdwn\", \"text\": \"*ğŸ”— PR:* <{{ $('Parse Action').first().json.prUrl }}|#{{ $('Parse Action').first().json.prNumber }}>\"}\n    },\n    {\n      \"type\": \"context\",\n      \"elements\": [\n        {\"type\": \"mrkdwn\", \"text\": \"ğŸ¤– AIê°€ ì œì•ˆí•œ ìˆ˜ì •ì‚¬í•­ì´ ë¸Œëœì¹˜ì— ì»¤ë°‹ë˜ì—ˆìŠµë‹ˆë‹¤. PRì„ í™•ì¸í•´ì£¼ì„¸ìš”.\"}\n      ]\n    }\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        4880,
        -368
      ],
      "id": "9f4e8d25-c5de-4bf7-a87a-3d2e9f4bd421",
      "name": "Slack Apply Success",
      "credentials": {
        "slackApi": {
          "id": "JudHaRQYOjQVx9Xo",
          "name": "DevOps Bot"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Parse Action').first().json.responseUrl }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"replace_original\": true,\n  \"blocks\": [\n    {\n      \"type\": \"header\",\n      \"text\": {\"type\": \"plain_text\", \"text\": \"âœ… AI ìˆ˜ì • ì ìš© ì™„ë£Œ\", \"emoji\": true}\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\"type\": \"mrkdwn\", \"text\": \"*ì ìš©ì:*\\n{{ $('Parse Action').first().json.user }}\"},\n        {\"type\": \"mrkdwn\", \"text\": \"*ìˆ˜ì • íŒŒì¼:*\\n{{ $('Parse Fix Files').first().json.fixedFileCount }}ê°œ\"}\n      ]\n    },\n    {\n      \"type\": \"context\",\n      \"elements\": [\n        {\"type\": \"mrkdwn\", \"text\": \"âœ… AI ìˆ˜ì •ì‚¬í•­ì´ ë¸Œëœì¹˜ì— ì»¤ë°‹ë˜ì—ˆìŠµë‹ˆë‹¤.\"}\n      ]\n    }\n  ]\n}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        5056,
        -368
      ],
      "id": "afe1b2bd-5e83-4015-b2d1-7508a6df75df",
      "name": "Finalize Apply Message"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Parse Action').first().json.responseUrl }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"replace_original\": true,\n  \"blocks\": [\n    {\n      \"type\": \"header\",\n      \"text\": {\"type\": \"plain_text\", \"text\": \"âš ï¸ ìˆ˜ì •í•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤\", \"emoji\": true}\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\"type\": \"mrkdwn\", \"text\": \"AIê°€ ìˆ˜ì •ì´ í•„ìš”í•œ ì½”ë“œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. PRì„ ì§ì ‘ í™•ì¸í•´ì£¼ì„¸ìš”.\"}\n    },\n    {\n      \"type\": \"context\",\n      \"elements\": [\n        {\"type\": \"mrkdwn\", \"text\": \"ğŸ’¡ ìˆ˜ë™ìœ¼ë¡œ ìˆ˜ì •í•˜ê±°ë‚˜ ë¦¬ë·° ë‚´ìš©ì„ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.\"}\n      ]\n    }\n  ]\n}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        3552,
        -48
      ],
      "id": "661fc611-fa29-4550-84d0-a0de68da9aa8",
      "name": "No Fixes Message"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Parse Action').first().json.responseUrl }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"replace_original\": true,\n  \"blocks\": [\n    {\n      \"type\": \"header\",\n      \"text\": {\"type\": \"plain_text\", \"text\": \"âŒ ë¦¬ë·° ë¬´ì‹œë¨\", \"emoji\": true}\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\"type\": \"mrkdwn\", \"text\": \"*ì²˜ë¦¬ì:*\\n{{ $('Parse Action').first().json.user }}\"},\n        {\"type\": \"mrkdwn\", \"text\": \"*PR:*\\n#{{ $('Parse Action').first().json.prNumber }}\"}\n      ]\n    },\n    {\n      \"type\": \"context\",\n      \"elements\": [\n        {\"type\": \"mrkdwn\", \"text\": \"âŒ ì´ ë¦¬ë·°ëŠ” ë¬´ì‹œë˜ì—ˆìŠµë‹ˆë‹¤. í•„ìš”ì‹œ PRì—ì„œ ì§ì ‘ í™•ì¸í•˜ì„¸ìš”.\"}\n      ]\n    }\n  ]\n}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2512,
        -304
      ],
      "id": "5290ceab-b18b-44ee-959a-5da05ad0c69b",
      "name": "Ignore Review Message"
    },
    {
      "parameters": {
        "content": "## ğŸ¤– AI ìˆ˜ì • ì ìš© í”Œë¡œìš°\n\nSlack ë²„íŠ¼ í´ë¦­ â†’ OpenAI ìˆ˜ì • ìƒì„± â†’\nGitHub ì»¤ë°‹ â†’ Slack ê²°ê³¼ ì•Œë¦¼",
        "height": 168,
        "width": 2416,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        2464,
        -944
      ],
      "id": "a66f8c1f-3733-417e-a116-7fdb3c466ffa",
      "name": "Sticky Note - Apply AI Review Flow"
    },
    {
      "parameters": {
        "content": "## ğŸ“¥ Issue ì ‘ìˆ˜ í”Œë¡œìš°\n\nGitHub Issue â†’ Jira ë™ê¸°í™” í›„\nSlack ì•Œë¦¼ ë°œì†¡ (ìŠ¹ì¸ ë²„íŠ¼ í¬í•¨)",
        "height": 200,
        "width": 480,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1680,
        -2560
      ],
      "id": "13a6732d-91aa-4374-aaa6-1d1e652a3ad2",
      "name": "Sticky Note - Issue Flow"
    },
    {
      "parameters": {
        "content": "## ğŸ”€ ì•¡ì…˜ ë¼ìš°íŒ…\n\nSlack ë²„íŠ¼ í´ë¦­ â†’ íŒŒì‹± â†’ ë¼ìš°íŒ…\në²„íŠ¼ ì¦‰ì‹œ ë¹„í™œì„±í™” (ì¤‘ë³µ ë°©ì§€)",
        "height": 280,
        "width": 360,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1680,
        -1936
      ],
      "id": "778bcf3b-7697-456b-a1df-6e66df0a37b5",
      "name": "Sticky Note - Routing"
    },
    {
      "parameters": {
        "content": "## âœ… ìŠ¹ì¸ í”Œë¡œìš° (Draft PR ìë™ ìƒì„±)\n\n1. ë¸Œëœì¹˜ ìƒì„±\n2. Jira â†’ ì§„í–‰ ì¤‘\n3. OpenAI ì½”ë“œ ìƒì„±\n4. íŒŒì¼ë³„ ì»¤ë°‹\n5. Draft PR ìƒì„±\n6. Slack ì•Œë¦¼ (PR ë§í¬)",
        "height": 240,
        "width": 2560,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        2384,
        -2320
      ],
      "id": "8e70154b-2c8c-4337-994a-864a32aaaf53",
      "name": "Sticky Note - Approve Flow"
    },
    {
      "parameters": {
        "content": "## âŒ ê±°ì ˆ í”Œë¡œìš°\n\n1. Jira â†’ Cancelled\n2. GitHub ì½”ë©˜íŠ¸\n3. Issue ì¢…ë£Œ\n4. Slack ìµœì¢… ì—…ë°ì´íŠ¸",
        "height": 200,
        "width": 840,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        2544,
        -1728
      ],
      "id": "7be58413-ed4d-4174-88b4-542109aee15a",
      "name": "Sticky Note - Reject Flow"
    },
    {
      "parameters": {
        "content": "## ğŸ“ ìˆ˜ì •ìš”ì²­ í”Œë¡œìš°\n\n1. Jira â†’ Blocked\n2. GitHub ì½”ë©˜íŠ¸ (ìˆ˜ì • ê°€ì´ë“œ)\n3. Slack ìµœì¢… ì—…ë°ì´íŠ¸",
        "height": 200,
        "width": 620,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        2544,
        -1504
      ],
      "id": "99dcea44-e2c3-4ca5-8b07-814d70b7644b",
      "name": "Sticky Note - Revise Flow"
    },
    {
      "parameters": {
        "content": "## ğŸ”” PR ë¦¬ë·° ì•Œë¦¼ í”Œë¡œìš°\n\nGitHub PR Review Webhook â†’\nCodeRabbit/Gemini ë¦¬ë·° ê°ì§€ â†’\nSlack ì•Œë¦¼ (ë¦¬ë·° ìš”ì•½ + ì•¡ì…˜ ë²„íŠ¼)",
        "height": 200,
        "width": 700,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1712,
        -992
      ],
      "id": "7162a9bc-5215-4cc0-bb52-1ae2ed437c80",
      "name": "Sticky Note - PR Review Flow"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o",
          "mode": "list",
          "cachedResultName": "GPT-4O"
        },
        "responses": {
          "values": [
            {
              "content": "= System:\n  ë‹¹ì‹ ì€ Terraform/Infrastructure ì½”ë“œ ë¦¬ë·° ì „ë¬¸ê°€ì…ë‹ˆë‹¤. PR ë¦¬ë·° í”¼ë“œë°±ì„ ë¶„ì„í•˜ê³ , êµ¬ì²´ì ì¸ ìˆ˜ì • ì œì•ˆì„ ì œê³µí•©ë‹ˆë‹¤.\n\n  ê·œì¹™:\n  1. Required Tags: merge(local.required_tags, {...}) íŒ¨í„´ í•„ìˆ˜\n  2. KMS Encryption: ê³ ê° ê´€ë¦¬í˜• KMS í‚¤ ì‚¬ìš© í•„ìˆ˜\n  3. Naming: ë¦¬ì†ŒìŠ¤ëŠ” kebab-case, ë³€ìˆ˜ëŠ” snake_case\n  4. Security: í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ ê¸ˆì§€\n\n  ì¤‘ìš”: ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”. ë‹¤ë¥¸ í…ìŠ¤íŠ¸ ì—†ì´ JSONë§Œ ì¶œë ¥í•˜ì„¸ìš”.\n\n  {\n    \"summary\": \"ë¦¬ë·° ìš”ì•½ (1-2ë¬¸ì¥)\",\n    \"items\": [\n      {\"title\": \"ìˆ˜ì • í•­ëª© ì œëª©\", \"description\": \"ê°„ë‹¨í•œ ì„¤ëª…\", \"priority\": \"high|medium|low\"}\n    ],\n    \"recommendation\": \"ì „ì²´ì ì¸ ê¶Œì¥ì‚¬í•­ (1ë¬¸ì¥)\"\n  }\n\n  User:\n  ë‹¤ìŒ PR ë¦¬ë·°ë¥¼ ë¶„ì„í•˜ê³  ìˆ˜ì • ì œì•ˆì„ í•´ì£¼ì„¸ìš”.\n\n  ## ë¦¬ë·°ì–´: {{ $json.reviewer }} ({{ $json.reviewerType }})\n  ## ë¦¬ë·° ìƒíƒœ: {{ $json.reviewState }}\n  ## ë¦¬ë·° ë‚´ìš©: {{ $json.reviewBody }}\n  ## ë³€ê²½ëœ íŒŒì¼: {{ $json.filesSummary }}\n  ## ì½”ë“œ ë³€ê²½ì‚¬í•­:{{ $json.patchContent }}\n"
            }
          ]
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2.1,
      "position": [
        2656,
        -832
      ],
      "id": "56327da2-67d6-4a91-88ad-573f4dd71079",
      "name": "Generate Code1",
      "credentials": {
        "openAiApi": {
          "id": "Ula5jc00tgdawbTH",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o",
          "mode": "list",
          "cachedResultName": "GPT-4O"
        },
        "responses": {
          "values": [
            {
              "content": "=System:\n ë‹¹ì‹ ì€ Terraform/Infrastructure ì½”ë“œ ìˆ˜ì • ì „ë¬¸ê°€ì…ë‹ˆë‹¤.\n  ë¦¬ë·° í”¼ë“œë°±ì„ ê¸°ë°˜ìœ¼ë¡œ ì½”ë“œë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤.\n\n  ê·œì¹™:\n  1. Required Tags: merge(local.required_tags, {...}) íŒ¨í„´ í•„ìˆ˜\n  2. KMS Encryption: ê³ ê° ê´€ë¦¬í˜• KMS í‚¤ ì‚¬ìš© í•„ìˆ˜\n  3. Naming: ë¦¬ì†ŒìŠ¤ëŠ” kebab-case, ë³€ìˆ˜ëŠ” snake_case\n  4. Security: í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ ê¸ˆì§€\n\n  ì‘ë‹µ í˜•ì‹ - ë°˜ë“œì‹œ ì´ í˜•ì‹ì„ ë”°ë¥´ì„¸ìš”:\n\n  1. ì‚­ì œí•  íŒŒì¼ì´ ìˆëŠ” ê²½ìš°:\n  ---DELETE: íŒŒì¼ê²½ë¡œ---\n\n  2. ìƒì„±í•˜ê±°ë‚˜ ìˆ˜ì •í•  íŒŒì¼:\n  ---FILE: íŒŒì¼ê²½ë¡œ---\n  (íŒŒì¼ ì „ì²´ ë‚´ìš©)\n  ---END FILE---\n\n  ì˜ˆì‹œ:\n  - ê¸°ì¡´ íŒŒì¼ì„ ì‚­ì œí•˜ê³  ìƒˆ íŒŒì¼ì„ ë§Œë“œëŠ” ê²½ìš°:\n    ---DELETE: terraform/old-path/main.tf---\n    ---FILE: terraform/new-path/main.tf---\n    (ìƒˆ íŒŒì¼ ë‚´ìš©)\n    ---END FILE---\n\n  - ê¸°ì¡´ íŒŒì¼ì„ ìˆ˜ì •í•˜ëŠ” ê²½ìš°:\n    ---FILE: terraform/existing-path/main.tf---\n    (ìˆ˜ì •ëœ ì „ì²´ íŒŒì¼ ë‚´ìš©)\n    ---END FILE---\n\n  User:\n   ë‹¤ìŒ ë¦¬ë·° í”¼ë“œë°±ì„ ê¸°ë°˜ìœ¼ë¡œ ì½”ë“œë¥¼ ìˆ˜ì •í•´ì£¼ì„¸ìš”.\n      ## AI ìˆ˜ì • ì œì•ˆ:\n      {{ $json.aiSuggestion }}\n      ## í˜„ì¬ ì½”ë“œ:\n      {{ $json.patchContent }}"
            }
          ]
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2.1,
      "position": [
        2848,
        -544
      ],
      "id": "4af45a60-0193-49a0-9ede-0fa613859b76",
      "name": "Generate Code2",
      "credentials": {
        "openAiApi": {
          "id": "Ula5jc00tgdawbTH",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "url": "=https://api.github.com/repos/{{ $json.repoName }}/pulls/{{ $json.prNumber }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "githubApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/vnd.github+v3+json"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"body\": \"## âŒ ìš”ì²­ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤\\n\\n**ê±°ì ˆì:** {{ $('Parse Action').first().json.user }}\\n**Jira:** {{ $('Parse Action').first().json.jiraKey }}\\n\\n---\\n\\nì´ ì¸í”„ë¼ ë³€ê²½ ìš”ì²­ì€ ê²€í†  ê²°ê³¼ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤.\\nì¶”ê°€ ë…¼ì˜ê°€ í•„ìš”í•˜ì‹œë©´ ë‹´ë‹¹ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        3536,
        -560
      ],
      "id": "d7d429a8-c71e-40c6-8fb2-d3264cbc473d",
      "name": "Get PR Branch",
      "credentials": {
        "githubApi": {
          "id": "uJpJHjMJj6qdmUVx",
          "name": "Infrastructure GitHub"
        }
      }
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://api.github.com/repos/ryu-qqq/infrastructure/pulls?head=ryu-qqq:{{ $('Parse Code Files').first().json.branchName }}&state=open",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "githubApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/vnd.github.v3+json"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        4176,
        -2224
      ],
      "id": "check-existing-pr-001",
      "name": "Check Existing PR",
      "credentials": {
        "githubApi": {
          "id": "uJpJHjMJj6qdmUVx",
          "name": "Infrastructure GitHub"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "pr-exists-check",
              "leftValue": "={{ $json.length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4264,
        -2224
      ],
      "id": "pr-exists-check-001",
      "name": "PR Exists?"
    },
    {
      "parameters": {
        "jsCode": "// Prepare data for Slack module\nconst input = $input.first().json;\n\nreturn {\n  messageType: \"review_suggestion\",\n  data: {\n    repoName: input.repoName || 'ryu-qqq/Infrastructure',\n    prNumber: input.prNumber,\n    prUrl: input.prUrl,\n    reviewerType: input.reviewerType,\n    reviewer: input.reviewer,\n    aiSummary: input.aiSummary,\n    aiItems: input.aiItems,\n    aiItemCount: input.aiItemCount,\n    aiRecommendation: input.aiRecommendation,\n    issueNum: input.issueNum\n  }\n};"
      },
      "id": "test-prepare-001",
      "name": "Test: Prepare Module Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3200,
        -632
      ]
    },
    {
      "parameters": {
        "source": "database",
        "workflowId": {
          "__rl": true,
          "mode": "list",
          "value": ""
        }
      },
      "id": "test-execute-001",
      "name": "Test: Call Slack Module",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.1,
      "position": [
        3420,
        -632
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Escape Body",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Slack Interactive": {
      "main": [
        [
          {
            "node": "Parse Action",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Action": {
      "main": [
        [
          {
            "node": "Disable Buttons",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Disable Buttons": {
      "main": [
        [
          {
            "node": "Route Action",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route Action": {
      "main": [
        [
          {
            "node": "Get Main SHA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update Jira (Reject)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update Jira (Revise)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Fetch PR Files for Apply",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Ignore Review Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Main SHA": {
      "main": [
        [
          {
            "node": "Extract SHA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract SHA": {
      "main": [
        [
          {
            "node": "Create Branch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Branch": {
      "main": [
        [
          {
            "node": "Update Jira",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Jira": {
      "main": [
        [
          {
            "node": "Generate Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Code": {
      "main": [
        [
          {
            "node": "Parse Code Files",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Code Files": {
      "main": [
        [
          {
            "node": "Prepare Commits",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Commits": {
      "main": [
        [
          {
            "node": "Split Files",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Files": {
      "main": [
        [
          {
            "node": "Check Existing PR",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Encode Base64",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Existing PR": {
      "main": [
        [
          {
            "node": "PR Exists?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PR Exists?": {
      "main": [
        [
          {
            "node": "Create Draft PR",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Encode Base64": {
      "main": [
        [
          {
            "node": "Commit File to Branch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Commit File to Branch": {
      "main": [
        [
          {
            "node": "Is Last File?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Last File?": {
      "main": [
        [],
        [
          {
            "node": "Split Files",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Draft PR": {
      "main": [
        [
          {
            "node": "Format PR Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format PR Response": {
      "main": [
        [
          {
            "node": "Slack PR Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Slack PR Result": {
      "main": [
        [
          {
            "node": "Finalize Approve Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Escape Body": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Jira (Reject)": {
      "main": [
        [
          {
            "node": "GitHub Comment (Reject)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GitHub Comment (Reject)": {
      "main": [
        [
          {
            "node": "Close Issue",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Close Issue": {
      "main": [
        [
          {
            "node": "Finalize Reject Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Jira (Revise)": {
      "main": [
        [
          {
            "node": "GitHub Comment (Revise)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GitHub Comment (Revise)": {
      "main": [
        [
          {
            "node": "Finalize Revise Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PR Review Webhook": {
      "main": [
        [
          {
            "node": "Parse PR Review",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse PR Review": {
      "main": [
        [
          {
            "node": "Is Review Submitted?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Review Submitted?": {
      "main": [
        [
          {
            "node": "Fetch PR Files",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch PR Files": {
      "main": [
        [
          {
            "node": "Prepare Review Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Review Context": {
      "main": [
        [
          {
            "node": "Generate Code1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format AI Suggestion": {
      "main": [
        [
          {
            "node": "Slack Review Suggestion",
            "type": "main",
            "index": 0
          },
          {
            "node": "Test: Prepare Module Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch PR Files for Apply": {
      "main": [
        [
          {
            "node": "Prepare Apply Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Apply Context": {
      "main": [
        [
          {
            "node": "Generate Code2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Fix Files": {
      "main": [
        [
          {
            "node": "Has Fixes?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Fixes?": {
      "main": [
        [
          {
            "node": "Get PR Branch",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Fixes Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Fix Commits": {
      "main": [
        [
          {
            "node": "Split Fix Files",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Fix Files": {
      "main": [
        [
          {
            "node": "Slack Apply Success",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Is Delete?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Delete?": {
      "main": [
        [
          {
            "node": "Delete File",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Encode Fix Base64",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Encode Fix Base64": {
      "main": [
        [
          {
            "node": "Create/Update File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete File": {
      "main": [
        [
          {
            "node": "Is Last Operation?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create/Update File": {
      "main": [
        [
          {
            "node": "Is Last Operation?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Last Operation?": {
      "main": [
        [],
        [
          {
            "node": "Split Fix Files",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Slack Apply Success": {
      "main": [
        [
          {
            "node": "Finalize Apply Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Code1": {
      "main": [
        [
          {
            "node": "Format AI Suggestion",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Code2": {
      "main": [
        [
          {
            "node": "Parse Fix Files",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get PR Branch": {
      "main": [
        [
          {
            "node": "Prepare Fix Commits",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Test: Prepare Module Data": {
      "main": [
        [
          {
            "node": "Test: Call Slack Module",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "dc3ada4f-3f8e-4702-af08-504c0cce7d63",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "ad7743d079695bc43ae4d02129a8effe323aa22a80de3b109fc6ceb5c0bcec7f"
  },
  "id": "9ng0vIp0PNL5sCJo",
  "tags": []
}