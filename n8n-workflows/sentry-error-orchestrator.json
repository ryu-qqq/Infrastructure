{
  "name": "Sentry Error Orchestrator",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "sentry-alert",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [200, 300],
      "id": "webhook-sentry",
      "name": "Sentry Webhook",
      "webhookId": "sentry-alert-webhook"
    },
    {
      "parameters": {
        "jsCode": "// Sentry ì›¹í›… ë˜ëŠ” Slack ë©”ì‹œì§€ì—ì„œ ì—ëŸ¬ ì •ë³´ íŒŒì‹±\nconst input = $input.first().json;\n\nlet errorData = {};\n\n// Sentry Direct Webhook í˜•ì‹\nif (input.event) {\n  const event = input.event;\n  errorData = {\n    source: 'sentry_direct',\n    title: event.title || 'Unknown Error',\n    message: event.message || event.title,\n    level: event.level || 'error',\n    platform: event.platform || 'unknown',\n    environment: event.environment || 'production',\n    project: input.project_name || input.project?.name || 'unknown',\n    culprit: event.culprit || '',\n    url: input.url || '',\n    stacktrace: '',\n    tags: event.tags || [],\n    timestamp: event.timestamp || new Date().toISOString()\n  };\n  \n  // ìŠ¤íƒíŠ¸ë ˆì´ìŠ¤ ì¶”ì¶œ\n  if (event.exception?.values?.[0]?.stacktrace?.frames) {\n    const frames = event.exception.values[0].stacktrace.frames.slice(-10);\n    errorData.stacktrace = frames.map(f => \n      `  at ${f.function || 'anonymous'} (${f.filename}:${f.lineno}:${f.colno})`\n    ).reverse().join('\\n');\n  }\n}\n// Slack ë©”ì‹œì§€ í˜•ì‹ (Sentry â†’ Slack â†’ n8n)\nelse if (input.event?.text || input.text) {\n  const text = input.event?.text || input.text;\n  errorData = {\n    source: 'slack_sentry',\n    title: text.split('\\n')[0] || 'Sentry Alert',\n    message: text,\n    level: 'error',\n    platform: 'unknown',\n    environment: 'production',\n    project: 'unknown',\n    culprit: '',\n    url: '',\n    stacktrace: text,\n    tags: [],\n    timestamp: new Date().toISOString()\n  };\n  \n  // Slack ë©”ì‹œì§€ì—ì„œ í”„ë¡œì íŠ¸ëª… ì¶”ì¶œ ì‹œë„\n  const projectMatch = text.match(/\\[([^\\]]+)\\]/);\n  if (projectMatch) {\n    errorData.project = projectMatch[1];\n  }\n}\nelse {\n  // ê¸°íƒ€ í˜•ì‹\n  errorData = {\n    source: 'unknown',\n    title: JSON.stringify(input).substring(0, 100),\n    message: JSON.stringify(input),\n    level: 'error',\n    platform: 'unknown',\n    environment: 'production',\n    project: 'unknown',\n    culprit: '',\n    url: '',\n    stacktrace: '',\n    tags: [],\n    timestamp: new Date().toISOString()\n  };\n}\n\nreturn errorData;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [420, 300],
      "id": "parse-sentry",
      "name": "Parse Sentry Data"
    },
    {
      "parameters": {
        "model": "gpt-4o",
        "messages": {
          "values": [
            {
              "role": "system",
              "content": "ë‹¹ì‹ ì€ ì‹œë‹ˆì–´ ë°±ì—”ë“œ ê°œë°œìì…ë‹ˆë‹¤. Sentry ì—ëŸ¬ë¥¼ ë¶„ì„í•˜ê³  í•´ê²° ë°©ì•ˆì„ ì œì‹œí•´ì£¼ì„¸ìš”.\n\nì‘ë‹µ í˜•ì‹ (JSON):\n{\n  \"severity\": \"critical|high|medium|low\",\n  \"category\": \"runtime|network|database|auth|config|unknown\",\n  \"root_cause\": \"ì—ëŸ¬ì˜ ê·¼ë³¸ ì›ì¸ (í•œê¸€, 2-3ë¬¸ì¥)\",\n  \"solution\": \"í•´ê²° ë°©ì•ˆ (í•œê¸€, êµ¬ì²´ì ì¸ ì½”ë“œ ìˆ˜ì • ë°©í–¥)\",\n  \"affected_files\": [\"ì˜ˆìƒë˜ëŠ” ìˆ˜ì • ëŒ€ìƒ íŒŒì¼ ê²½ë¡œë“¤\"],\n  \"labels\": [\"GitHub Issueì— ë¶™ì¼ ë¼ë²¨ë“¤\"]\n}"
            },
            {
              "role": "user",
              "content": "=ë‹¤ìŒ ì—ëŸ¬ë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”:\n\n**í”„ë¡œì íŠ¸**: {{ $json.project }}\n**í™˜ê²½**: {{ $json.environment }}\n**ì—ëŸ¬ ë ˆë²¨**: {{ $json.level }}\n**ì œëª©**: {{ $json.title }}\n**ë©”ì‹œì§€**: {{ $json.message }}\n**Culprit**: {{ $json.culprit }}\n\n**ìŠ¤íƒíŠ¸ë ˆì´ìŠ¤**:\n```\n{{ $json.stacktrace }}\n```"
            }
          ]
        },
        "options": {
          "responseFormat": "json_object",
          "temperature": 0.3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [640, 300],
      "id": "analyze-error",
      "name": "Analyze Error",
      "credentials": {
        "openAiApi": {
          "id": "your-openai-credential-id",
          "name": "OpenAI API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const errorData = $('Parse Sentry Data').first().json;\nconst analysisRaw = $('Analyze Error').first().json.message?.content || $('Analyze Error').first().json.text || '{}';\n\nlet analysis;\ntry {\n  analysis = JSON.parse(analysisRaw);\n} catch (e) {\n  analysis = {\n    severity: 'medium',\n    category: 'unknown',\n    root_cause: 'ë¶„ì„ ì‹¤íŒ¨',\n    solution: 'ìˆ˜ë™ í™•ì¸ í•„ìš”',\n    affected_files: [],\n    labels: ['bug']\n  };\n}\n\n// GitHub Issue ë³¸ë¬¸ ìƒì„±\nconst issueBody = `## ğŸš¨ Sentry ì—ëŸ¬ ì•Œë¦¼\n\n### ì—ëŸ¬ ì •ë³´\n| í•­ëª© | ê°’ |\n|------|----|\n| **í”„ë¡œì íŠ¸** | ${errorData.project} |\n| **í™˜ê²½** | ${errorData.environment} |\n| **ì‹¬ê°ë„** | ${analysis.severity} |\n| **ì¹´í…Œê³ ë¦¬** | ${analysis.category} |\n| **ë°œìƒì‹œê°** | ${errorData.timestamp} |\n\n### ì—ëŸ¬ ë©”ì‹œì§€\n\\`\\`\\`\n${errorData.title}\n\\`\\`\\`\n\n### ìŠ¤íƒíŠ¸ë ˆì´ìŠ¤\n\\`\\`\\`\n${errorData.stacktrace || 'N/A'}\n\\`\\`\\`\n\n### ğŸ” AI ë¶„ì„ ê²°ê³¼\n\n#### ê·¼ë³¸ ì›ì¸\n${analysis.root_cause}\n\n#### ğŸ’¡ í•´ê²° ë°©ì•ˆ\n${analysis.solution}\n\n#### ğŸ“ ì˜ˆìƒ ìˆ˜ì • íŒŒì¼\n${analysis.affected_files?.map(f => '- `' + f + '`').join('\\n') || '- ë¶„ì„ í•„ìš”'}\n\n---\n\n### ğŸ¤– Claude Code ìë™ ìˆ˜ì • ìš”ì²­\n\nì´ ì´ìŠˆê°€ ìƒì„±ë˜ë©´ GitHub Actionsê°€ íŠ¸ë¦¬ê±°ë˜ì–´ Claude Code CLIê°€ ìë™ìœ¼ë¡œ ìˆ˜ì •ì„ ì‹œë„í•©ë‹ˆë‹¤.\n\n**ìë™ ìˆ˜ì • ëª…ë ¹:**\n\\`\\`\\`\nclaude -p \"ì´ ì—ëŸ¬ë¥¼ ìˆ˜ì •í•´ì£¼ì„¸ìš”: ${errorData.title.replace(/\"/g, '\\\\"')}\\n\\ní•´ê²°ë°©ì•ˆ: ${analysis.solution.replace(/\"/g, '\\\\"')}\"\n\\`\\`\\`\n\n---\n_ì´ ì´ìŠˆëŠ” Sentry â†’ n8n ìë™í™”ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤._\n`;\n\n// ë¼ë²¨ ê²°ì •\nconst labels = ['sentry-auto', 'claude-code-fix'];\nif (analysis.severity === 'critical') labels.push('priority:critical');\nelse if (analysis.severity === 'high') labels.push('priority:high');\nif (analysis.category) labels.push(`type:${analysis.category}`);\nif (analysis.labels) labels.push(...analysis.labels);\n\nreturn {\n  title: `[Sentry][${errorData.project}] ${errorData.title.substring(0, 80)}`,\n  body: issueBody,\n  labels: [...new Set(labels)],\n  errorData,\n  analysis\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [860, 300],
      "id": "format-issue",
      "name": "Format GitHub Issue"
    },
    {
      "parameters": {
        "resource": "issue",
        "operation": "create",
        "owner": "ryu-qqq",
        "repository": "=auto-detect-from-project",
        "title": "={{ $json.title }}",
        "body": "={{ $json.body }}",
        "labels": "={{ $json.labels }}"
      },
      "type": "n8n-nodes-base.github",
      "typeVersion": 1,
      "position": [1080, 300],
      "id": "create-issue",
      "name": "Create GitHub Issue",
      "credentials": {
        "githubApi": {
          "id": "your-github-credential-id",
          "name": "GitHub API"
        }
      }
    },
    {
      "parameters": {
        "resource": "issue",
        "operation": "createComment",
        "owner": "ryu-qqq",
        "repository": "={{ $('Format GitHub Issue').first().json.errorData.project }}",
        "issueNumber": "={{ $('Create GitHub Issue').first().json.number }}",
        "body": "=@claude ì´ Sentry ì—ëŸ¬ë¥¼ ìˆ˜ì •í•´ì£¼ì„¸ìš”.\n\n## ì—ëŸ¬ ì •ë³´\n- **ì œëª©**: {{ $('Parse Sentry Data').first().json.title }}\n- **í”„ë¡œì íŠ¸**: {{ $('Parse Sentry Data').first().json.project }}\n- **í™˜ê²½**: {{ $('Parse Sentry Data').first().json.environment }}\n\n## AI ë¶„ì„ ê²°ê³¼\n### ê·¼ë³¸ ì›ì¸\n{{ $('Format GitHub Issue').first().json.analysis.root_cause }}\n\n### í•´ê²° ë°©ì•ˆ\n{{ $('Format GitHub Issue').first().json.analysis.solution }}\n\n### ì˜ˆìƒ ìˆ˜ì • íŒŒì¼\n{{ $('Format GitHub Issue').first().json.analysis.affected_files.map(f => '- `' + f + '`').join('\\n') }}\n\n## ì‘ì—… ì§€ì¹¨\n1. ìœ„ ë¶„ì„ ê²°ê³¼ë¥¼ ì°¸ê³ í•´ì„œ ì—ëŸ¬ë¥¼ ìˆ˜ì •í•´ì£¼ì„¸ìš”\n2. ê¸°ì¡´ ì½”ë“œ ìŠ¤íƒ€ì¼ì„ ìœ ì§€í•´ì£¼ì„¸ìš”\n3. ìˆ˜ì • í›„ PRì„ ìƒì„±í•´ì£¼ì„¸ìš”"
      },
      "type": "n8n-nodes-base.github",
      "typeVersion": 1,
      "position": [1300, 300],
      "id": "trigger-claude",
      "name": "Trigger @claude Comment",
      "credentials": {
        "githubApi": {
          "id": "your-github-credential-id",
          "name": "GitHub API"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://slack.com/api/chat.postMessage",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "slackApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"channel\": \"sentry-alerts\",\n  \"blocks\": [\n    {\n      \"type\": \"header\",\n      \"text\": {\"type\": \"plain_text\", \"text\": \"ğŸš¨ Sentry ì—ëŸ¬ â†’ Claude ìë™ ìˆ˜ì • ìš”ì²­\", \"emoji\": true}\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\"type\": \"mrkdwn\", \"text\": \"*í”„ë¡œì íŠ¸:*\\n{{ $('Parse Sentry Data').first().json.project }}\"},\n        {\"type\": \"mrkdwn\", \"text\": \"*ì‹¬ê°ë„:*\\n{{ $('Format GitHub Issue').first().json.analysis.severity }}\"}\n      ]\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\"type\": \"mrkdwn\", \"text\": \"*ì—ëŸ¬:*\\n```{{ $('Parse Sentry Data').first().json.title }}```\"}\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\"type\": \"mrkdwn\", \"text\": \"*GitHub Issue:*\\n<{{ $('Create GitHub Issue').first().json.html_url }}|#{{ $('Create GitHub Issue').first().json.number }}>\"}\n    },\n    {\n      \"type\": \"context\",\n      \"elements\": [\n        {\"type\": \"mrkdwn\", \"text\": \"ğŸ¤– @claude ë©˜ì…˜ìœ¼ë¡œ ìë™ ìˆ˜ì •ì´ íŠ¸ë¦¬ê±°ë˜ì—ˆìŠµë‹ˆë‹¤...\"}\n      ]\n    }\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [1520, 300],
      "id": "notify-slack",
      "name": "Notify Slack",
      "credentials": {
        "slackApi": {
          "id": "your-slack-credential-id",
          "name": "Slack API"
        }
      }
    }
  ],
  "connections": {
    "Sentry Webhook": {
      "main": [
        [
          {
            "node": "Parse Sentry Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Sentry Data": {
      "main": [
        [
          {
            "node": "Analyze Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze Error": {
      "main": [
        [
          {
            "node": "Format GitHub Issue",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format GitHub Issue": {
      "main": [
        [
          {
            "node": "Create GitHub Issue",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create GitHub Issue": {
      "main": [
        [
          {
            "node": "Trigger @claude Comment",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trigger @claude Comment": {
      "main": [
        [
          {
            "node": "Notify Slack",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "name": "sentry",
      "id": "sentry-tag"
    },
    {
      "name": "automation",
      "id": "automation-tag"
    }
  ]
}
