# =============================================================================
# Dockerfile Template with OpenTelemetry (ADOT Agent)
# =============================================================================
# Spring Boot 3.x + Micrometer + OpenTelemetry + AWS X-Ray 통합을 위한 템플릿
#
# 사용법:
#   1. 이 템플릿을 프로젝트의 Dockerfile로 복사
#   2. ${SERVICE_NAME}, ${SERVICE_NAMESPACE} 등을 실제 값으로 교체
#   3. 필요에 따라 JVM 옵션 및 OTEL 설정 수정
#
# 전제조건:
#   - ECS Task Definition에 otel-collector sidecar 컨테이너가 포함되어 있어야 함
#   - ECS Task Role에 X-Ray, CloudWatch 권한이 있어야 함
#     (terraform/modules/ecs-task-role-observability 모듈 참고)
# =============================================================================

# -----------------------------------------------------------------------------
# Stage 1: Build (선택사항 - 멀티스테이지 빌드 시)
# -----------------------------------------------------------------------------
# FROM gradle:8-jdk21 AS builder
# WORKDIR /app
# COPY . .
# RUN gradle :${MODULE_PATH}:bootJar --no-daemon

# -----------------------------------------------------------------------------
# Stage 2: Runtime
# -----------------------------------------------------------------------------
FROM eclipse-temurin:21-jre-alpine

# 보안: non-root 사용자 생성
RUN addgroup -g 1000 appgroup && \
    adduser -u 1000 -G appgroup -D appuser

WORKDIR /app

# -----------------------------------------------------------------------------
# AWS ADOT Agent 다운로드
# -----------------------------------------------------------------------------
# ADOT Agent는 Java 애플리케이션을 자동 계측하여 메트릭과 트레이스를 수집합니다.
# 특정 버전을 사용하려면 'latest' 대신 버전 태그 사용 (예: v1.32.0)
ADD --chmod=644 https://github.com/aws-observability/aws-otel-java-instrumentation/releases/latest/download/aws-opentelemetry-agent.jar /app/aws-opentelemetry-agent.jar

# -----------------------------------------------------------------------------
# 애플리케이션 JAR 복사
# -----------------------------------------------------------------------------
# 멀티스테이지 빌드 시: COPY --from=builder /app/${MODULE_PATH}/build/libs/*.jar app.jar
COPY app.jar app.jar

# 소유권 변경
RUN chown -R appuser:appgroup /app

# -----------------------------------------------------------------------------
# JVM 옵션
# -----------------------------------------------------------------------------
# 컨테이너 환경에 최적화된 JVM 설정
ENV JAVA_OPTS="-XX:+UseContainerSupport \
    -XX:MaxRAMPercentage=75.0 \
    -XX:+UseG1GC \
    -XX:+HeapDumpOnOutOfMemoryError \
    -XX:HeapDumpPath=/tmp/heapdump.hprof"

# OTEL Agent JVM 옵션
ENV OTEL_AGENT_OPTS="-javaagent:/app/aws-opentelemetry-agent.jar"

# -----------------------------------------------------------------------------
# OpenTelemetry 환경변수
# -----------------------------------------------------------------------------
# 서비스 식별
ENV OTEL_SERVICE_NAME="${SERVICE_NAME:-my-service}"
ENV OTEL_RESOURCE_ATTRIBUTES="service.namespace=${SERVICE_NAMESPACE:-default},deployment.environment=${ENVIRONMENT:-dev}"

# OTLP Endpoint (otel-collector sidecar)
ENV OTEL_EXPORTER_OTLP_ENDPOINT="http://localhost:4317"

# Exporter 설정
# - otlp: OTEL Collector로 전송 (권장)
# - none: 비활성화
ENV OTEL_METRICS_EXPORTER="otlp"
ENV OTEL_TRACES_EXPORTER="otlp"
ENV OTEL_LOGS_EXPORTER="none"

# Propagator 설정 (AWS X-Ray 통합)
ENV OTEL_PROPAGATORS="xray,tracecontext,baggage"

# 샘플링 설정 (기본: 전체 샘플링)
# 프로덕션에서는 비율 조정 권장 (예: 0.1 = 10%)
ENV OTEL_TRACES_SAMPLER="always_on"

# -----------------------------------------------------------------------------
# 헬스체크
# -----------------------------------------------------------------------------
HEALTHCHECK --interval=30s --timeout=3s --start-period=60s --retries=3 \
    CMD wget -q --spider http://localhost:8080/actuator/health || exit 1

# -----------------------------------------------------------------------------
# 실행
# -----------------------------------------------------------------------------
USER appuser

EXPOSE 8080

ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS $OTEL_AGENT_OPTS -jar app.jar"]
