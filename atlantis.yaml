# Atlantis Configuration for Infrastructure Repository
# https://www.runatlantis.io/docs/repo-level-atlantis-yaml.html

version: 3

# Global settings
automerge: false
delete_source_branch_on_merge: false
# Disable parallel plan to prevent plugin cache conflicts
# Multiple terraform init operations can race for the same plugin cache files
parallel_plan: false
parallel_apply: false

# Projects configuration
projects:
  # ============================================================================
  # Shared Infrastructure (공유 인프라)
  # ============================================================================

  # 1. Bootstrap - Initial Setup
  - name: bootstrap-prod
    dir: terraform/bootstrap
    workspace: default
    terraform_version: v1.12.2
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true
    apply_requirements: ["approved", "mergeable"]
    workflow: default

  # 2. KMS - Encryption Keys
  - name: kms-prod
    dir: terraform/kms
    workspace: default
    terraform_version: v1.12.2
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true
    apply_requirements: ["approved", "mergeable"]
    workflow: default

  # 3. Network - VPC, Subnets, Routing
  - name: network-prod
    dir: terraform/network
    workspace: default
    terraform_version: v1.12.2
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true
    apply_requirements: ["approved", "mergeable"]
    workflow: default

  # 4. Secrets - Secrets Manager
  - name: secrets-prod
    dir: terraform/secrets
    workspace: default
    terraform_version: v1.12.2
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true
    apply_requirements: ["approved", "mergeable"]
    workflow: default

  # 5. RDS - Shared Database
  - name: rds-prod
    dir: terraform/rds
    workspace: default
    terraform_version: v1.12.2
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true
    apply_requirements: ["approved", "mergeable"]
    workflow: default

  # 6. CloudTrail - Audit Logging
  - name: cloudtrail-prod
    dir: terraform/cloudtrail
    workspace: default
    terraform_version: v1.12.2
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true
    apply_requirements: ["approved", "mergeable"]
    workflow: default

  # 7. Logging - Log Infrastructure
  - name: logging-prod
    dir: terraform/logging
    workspace: default
    terraform_version: v1.12.2
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true
    apply_requirements: ["approved", "mergeable"]
    workflow: default

  # 8. Monitoring - CloudWatch, Alarms
  - name: monitoring-prod
    dir: terraform/monitoring
    workspace: default
    terraform_version: v1.12.2
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true
    apply_requirements: ["approved", "mergeable"]
    workflow: default

  # 9. Route53 - DNS Management
  - name: route53-prod
    dir: terraform/route53
    workspace: default
    terraform_version: v1.12.2
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true
    apply_requirements: ["approved", "mergeable"]
    workflow: default

  # 10. ACM - SSL Certificates
  - name: acm-prod
    dir: terraform/acm
    workspace: default
    terraform_version: v1.12.2
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true
    apply_requirements: ["approved", "mergeable"]
    workflow: default

  # ============================================================================
  # Platform Infrastructure (플랫폼 인프라)
  # ============================================================================

  # Atlantis Server Infrastructure
  - name: atlantis-prod
    dir: terraform/atlantis
    workspace: default
    terraform_version: v1.12.2
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true
    apply_requirements: ["approved", "mergeable"]
    workflow: default

  # Test Infrastructure for Atlantis Integration Testing
  - name: atlantis-test
    dir: terraform/test
    workspace: default
    terraform_version: v1.12.2
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true
    apply_requirements: ["approved", "mergeable"]
    workflow: default


# Workflows
workflows:
  default:
    plan:
      steps:
        # Disable shared plugin cache to prevent "text file busy" race conditions
        # Forces each terraform init to use project-local plugins
        - env:
            name: TF_PLUGIN_CACHE_DIR
            value: ""
        - init:
            extra_args:
              - "-upgrade"
        - plan
    apply:
      steps:
        - apply
