# Atlantis Configuration for Infrastructure Repository
# https://www.runatlantis.io/docs/repo-level-atlantis-yaml.html

version: 3

# Global settings
automerge: false
delete_source_branch_on_merge: false
# Disable parallel plan to prevent plugin cache conflicts
# Multiple terraform init operations can race for the same plugin cache files
parallel_plan: false
parallel_apply: false

# Projects configuration
projects:
  # Atlantis Server Infrastructure
  - name: atlantis-prod
    dir: terraform/atlantis
    workspace: default
    terraform_version: v1.5.0
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true
    apply_requirements: ["approved", "mergeable"]
    workflow: default

  # Test Infrastructure for Atlantis Integration Testing
  - name: atlantis-test
    dir: terraform/test
    workspace: default
    terraform_version: v1.5.0
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true
    apply_requirements: ["approved", "mergeable"]
    workflow: default


# Workflows
workflows:
  default:
    plan:
      steps:
        # Disable shared plugin cache to prevent "text file busy" race conditions
        # Forces each terraform init to use project-local plugins
        - env:
            name: TF_PLUGIN_CACHE_DIR
            value: ""
        - init:
            extra_args:
              - "-upgrade"
        - plan
    apply:
      steps:
        - apply
