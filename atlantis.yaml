# Atlantis Configuration for Infrastructure Repository
# https://www.runatlantis.io/docs/repo-level-atlantis-yaml.html

version: 3

# Global settings
automerge: false
delete_source_branch_on_merge: false
# Disable parallel plan to prevent plugin cache conflicts
# Multiple terraform init operations can race for the same plugin cache files
parallel_plan: false
parallel_apply: false

# Projects configuration
projects:
  # ============================================================================
  # 1. Shared Infrastructure (공유 인프라) - Manual Management
  # ============================================================================
  # Core infrastructure shared across all services
  # Managed manually - changes require careful review
  # ============================================================================

  # 1. Bootstrap - Initial Setup
  - name: bootstrap-prod
    dir: terraform/bootstrap
    workspace: default
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true
    apply_requirements: ["approved", "mergeable"]
    workflow: default

  # 2. KMS - Encryption Keys
  - name: kms-prod
    dir: terraform/kms
    workspace: default
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true
    apply_requirements: ["approved", "mergeable"]
    workflow: default

  # 3. Network - VPC, Subnets, Routing
  - name: network-prod
    dir: terraform/network
    workspace: default
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true
    apply_requirements: ["approved", "mergeable"]
    workflow: default

  # 4. Secrets - Secrets Manager
  - name: secrets-prod
    dir: terraform/secrets
    workspace: default
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true
    apply_requirements: ["approved", "mergeable"]
    workflow: default

  # 5. RDS - Shared Database
  - name: rds-prod
    dir: terraform/rds
    workspace: default
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true
    # apply_requirements: ["approved", "mergeable"]  # Temporarily disabled for SSM parameter deployment
    workflow: default

  # 6. CloudTrail - Audit Logging
  - name: cloudtrail-prod
    dir: terraform/cloudtrail
    workspace: default
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true
    apply_requirements: ["approved", "mergeable"]
    workflow: default

  # 7. Logging - Log Infrastructure
  - name: logging-prod
    dir: terraform/logging
    workspace: default
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true
    apply_requirements: ["approved", "mergeable"]
    workflow: default

  # 8. Monitoring - CloudWatch, Alarms
  - name: monitoring-prod
    dir: terraform/monitoring
    workspace: default
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true
    apply_requirements: ["approved", "mergeable"]
    workflow: default

  # 9. Route53 - DNS Management
  - name: route53-prod
    dir: terraform/route53
    workspace: default
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true
    apply_requirements: ["approved", "mergeable"]
    workflow: default

  # 10. ACM - SSL Certificates
  - name: acm-prod
    dir: terraform/acm
    workspace: default
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true
    apply_requirements: ["approved", "mergeable"]
    workflow: default

  # ============================================================================
  # 2. Platform Infrastructure (플랫폼 인프라) - Manual Management
  # ============================================================================
  # Platform services like Atlantis, CI/CD tools
  # Managed manually - critical infrastructure
  # ============================================================================

  # Atlantis Server Infrastructure
  - name: atlantis-prod
    dir: terraform/atlantis
    workspace: default
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true
    apply_requirements: ["approved", "mergeable"]
    workflow: default

  # Test Infrastructure for Atlantis Integration Testing
  - name: atlantis-test
    dir: terraform/test
    workspace: default
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true
    apply_requirements: ["approved", "mergeable"]
    workflow: default

  # ============================================================================
  # 3. Container Registry (컨테이너 레지스트리) - Manual Management
  # ============================================================================
  # ECR repositories for container images
  # Managed manually - add new registries as needed
  # ============================================================================

  # ECR - FileFlow Container Registry
  - name: ecr-fileflow-prod
    dir: terraform/ecr/fileflow
    workspace: default
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true
    apply_requirements: ["approved", "mergeable"]
    workflow: default

  # ============================================================================
  # 4. Application Services (애플리케이션 서비스) - Wizard Auto-Managed
  # ============================================================================
  # ⚠️  WARNING: This section is AUTOMATICALLY managed by Infrastructure Wizard
  #
  # New services are added below in alphabetical order by the wizard
  # DO NOT manually edit projects in this section
  #
  # To add a new service, run:
  #   $ ./wizard/infra-wizard.sh
  #
  # The wizard will:
  #   1. Generate Terraform code in terraform/services/{service-name}/
  #   2. Automatically add the project to this section
  #   3. Create a PR with all changes
  #
  # Last updated: 2025-10-24
  # ============================================================================

  # FILEFLOW - Service infrastructure (migrated from terraform/fileflow)
  - name: fileflow-prod
    dir: terraform/fileflow
    workspace: default
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true
    apply_requirements: ["approved", "mergeable"]
    workflow: default

  # ============================================================================
  # END OF WIZARD AUTO-MANAGED SECTION
  # ============================================================================


# Workflows
workflows:
  default:
    plan:
      steps:
        # Disable shared plugin cache to prevent "text file busy" race conditions
        # Forces each terraform init to use project-local plugins
        - env:
            name: TF_PLUGIN_CACHE_DIR
            value: ""
        - init:
            extra_args:
              - "-upgrade"
        - plan
    apply:
      steps:
        - apply
