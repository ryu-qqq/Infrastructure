# Infrastructure Module Command

**Task**: infrastructure í”„ë¡œì íŠ¸ì˜ Terraform ëª¨ë“ˆì„ ë‹¤ë¥¸ í”„ë¡œì íŠ¸ì—ì„œ ì‰½ê²Œ ê°€ì ¸ë‹¤ ì“¸ ìˆ˜ ìˆê²Œ ë„ì™€ì¤ë‹ˆë‹¤.

## í•µì‹¬ ê°œë…

ì´ infrastructure ë ˆí¬ëŠ” **ì¬ì‚¬ìš© ê°€ëŠ¥í•œ Terraform ëª¨ë“ˆ**ì„ ì œê³µí•©ë‹ˆë‹¤.
ë‹¤ë¥¸ í”„ë¡œì íŠ¸(ì˜ˆ: fileflow, api-server)ì—ì„œ ì´ ëª¨ë“ˆë“¤ì„ Git sourceë¡œ ì°¸ì¡°í•˜ì—¬ ì¸í”„ë¼ë¥¼ êµ¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ë²„ì „ ê´€ë¦¬**: Git íƒœê·¸ë¡œ ëª¨ë“ˆ ë²„ì „ ê´€ë¦¬ (`modules/{module-name}/v{version}`)

## ì‚¬ìš© ê°€ëŠ¥í•œ ì»¤ë§¨ë“œ

### 1. ğŸ“‹ ëª¨ë“ˆ ëª©ë¡ ì¡°íšŒ

```bash
# Claude Codeì—ì„œ
/if/module list

# ë˜ëŠ” ì§ì ‘ ì‹¤í–‰
./scripts/modules/module-manager.sh list
```

**ì¶œë ¥ ì˜ˆì‹œ**:
```
â„¹ï¸  ì‚¬ìš© ê°€ëŠ¥í•œ Infrastructure ëª¨ë“ˆ ëª©ë¡:

ğŸ“¦ alb
   Latest: v1.0.0
   ğŸ“ Application Load Balancer with HTTPS support

ğŸ“¦ ecr
   Latest: v1.0.0 (CHANGELOG only)
   ğŸ“ Amazon ECR repository with KMS encryption

ğŸ“¦ ecs-service
   Latest: v1.2.0
   All versions: v1.0.0 v1.1.0 v1.2.0
   ğŸ“ ECS Service with Auto Scaling
```

### 2. ğŸ” ëª¨ë“ˆ ìƒì„¸ ì •ë³´

```bash
# Claude Codeì—ì„œ
/if/module info ecr

# ë˜ëŠ” ì§ì ‘ ì‹¤í–‰
./scripts/modules/module-manager.sh info ecr
```

**ì¶œë ¥ ë‚´ìš©**:
- ëª¨ë“ˆ ë²„ì „ ì •ë³´
- README ë‚´ìš©
- ë””ë ‰í† ë¦¬ êµ¬ì¡°
- ê¸°ë³¸ ì‚¬ìš© ì˜ˆì œ

### 3. ğŸ“¦ ëª¨ë“ˆ ê°€ì ¸ì˜¤ê¸° (Terraform source ìƒì„±)

```bash
# ìµœì‹  ë²„ì „ ê°€ì ¸ì˜¤ê¸°
/if/module get ecr

# íŠ¹ì • ë²„ì „ ê°€ì ¸ì˜¤ê¸°
/if/module get ecr@v1.0.0

# ë˜ëŠ” ì§ì ‘ ì‹¤í–‰
./scripts/modules/module-manager.sh get ecr@v1.0.0
```

**ì¶œë ¥ ì˜ˆì‹œ**:
```
âœ… Module: ecr (v1.0.0)

Terraformì—ì„œ ì‚¬ìš©í•˜ëŠ” ë°©ë²•:

module "ecr" {
  source = "git::https://github.com/ryuqqq/infrastructure.git//terraform/modules/ecr?ref=modules/ecr/v1.0.0"

  # ì—¬ê¸°ì— ëª¨ë“ˆ ë³€ìˆ˜ë¥¼ ì¶”ê°€í•˜ì„¸ìš”
}

ì‚¬ìš© ê°€ëŠ¥í•œ ë³€ìˆ˜:
  - repository_name
  - image_tag_mutability
  - scan_on_push
  - kms_key_arn
  - lifecycle_policy
  - common_tags

â„¹ï¸  Tip: /if/module init ecr ë¥¼ ì‹¤í–‰í•˜ë©´ ìë™ìœ¼ë¡œ ì„¤ì • íŒŒì¼ì´ ìƒì„±ë©ë‹ˆë‹¤
```

### 4. ğŸš€ ëª¨ë“ˆ ì´ˆê¸°í™” (í˜„ì¬ í”„ë¡œì íŠ¸ì— ì„¤ì • íŒŒì¼ ìƒì„±)

```bash
# ìµœì‹  ë²„ì „ìœ¼ë¡œ ì´ˆê¸°í™”
/if/module init ecr

# íŠ¹ì • ë²„ì „ìœ¼ë¡œ ì´ˆê¸°í™”
/if/module init alb@v1.0.0

# ë˜ëŠ” ì§ì ‘ ì‹¤í–‰
./scripts/modules/module-manager.sh init ecr
```

**ìƒì„±ë˜ëŠ” íŒŒì¼ë“¤**:
```
terraform/
â”œâ”€â”€ provider.tf                    # ìƒì„±ë¨ (ì—†ëŠ” ê²½ìš°)
â”œâ”€â”€ variables.tf                   # ìƒì„±ë¨ (ì—†ëŠ” ê²½ìš°)
â””â”€â”€ ecr/                          # ìƒˆë¡œ ìƒì„±
    â”œâ”€â”€ main.tf                   # ëª¨ë“ˆ ì°¸ì¡° ì½”ë“œ
    â”œâ”€â”€ outputs.tf                # ì¶œë ¥ ë³€ìˆ˜
    â”œâ”€â”€ example.tf.template       # ì‚¬ìš© ì˜ˆì œ (ì°¸ê³ ìš©)
    â””â”€â”€ variables-reference.tf.md # ë³€ìˆ˜ ë¬¸ì„œ
```

**main.tf ì˜ˆì‹œ**:
```hcl
# ecr Module Configuration
# Version: v1.0.0
# Auto-generated by /if/module init

module "ecr" {
  source = "git::https://github.com/ryuqqq/infrastructure.git//terraform/modules/ecr?ref=modules/ecr/v1.0.0"

  # TODO: Configure module variables
  # See variables.tf for available options
}
```

## ì›Œí¬í”Œë¡œìš° ì˜ˆì‹œ

### FileFlow í”„ë¡œì íŠ¸ì—ì„œ ECR ëª¨ë“ˆ ì‚¬ìš©í•˜ê¸°

```bash
# 1. FileFlow í”„ë¡œì íŠ¸ë¡œ ì´ë™
cd ~/fileflow

# 2. ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë“ˆ í™•ì¸
/if/module list

# 3. ECR ëª¨ë“ˆ ìƒì„¸ ì •ë³´ í™•ì¸
/if/module info ecr

# 4. ECR ëª¨ë“ˆ ì´ˆê¸°í™” (ì„¤ì • íŒŒì¼ ìë™ ìƒì„±)
/if/module init ecr

# 5. ìƒì„±ëœ main.tf í¸ì§‘
vim terraform/ecr/main.tf

# 6. Terraform ì‹¤í–‰
cd terraform/ecr
terraform init
terraform plan
terraform apply
```

### ì—¬ëŸ¬ ëª¨ë“ˆì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš°

```bash
# 1. í•„ìš”í•œ ëª¨ë“ˆë“¤ ì´ˆê¸°í™”
/if/module init ecr
/if/module init alb
/if/module init ecs-service

# 2. ê° ëª¨ë“ˆ ì„¤ì •
# terraform/ecr/main.tf
# terraform/alb/main.tf
# terraform/ecs-service/main.tf

# 3. í”„ë¡œì íŠ¸ êµ¬ì¡°
fileflow/
â”œâ”€â”€ src/                    # ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ
â”œâ”€â”€ terraform/
â”‚   â”œâ”€â”€ provider.tf
â”‚   â”œâ”€â”€ variables.tf
â”‚   â”œâ”€â”€ ecr/
â”‚   â”‚   â”œâ”€â”€ main.tf
â”‚   â”‚   â””â”€â”€ outputs.tf
â”‚   â”œâ”€â”€ alb/
â”‚   â”‚   â”œâ”€â”€ main.tf
â”‚   â”‚   â””â”€â”€ outputs.tf
â”‚   â””â”€â”€ ecs-service/
â”‚       â”œâ”€â”€ main.tf
â”‚       â””â”€â”€ outputs.tf
â””â”€â”€ atlantis.yaml
```

## ë²„ì „ ê´€ë¦¬ ì „ëµ

### Git íƒœê·¸ í˜•ì‹
```
modules/{module-name}/v{major}.{minor}.{patch}

ì˜ˆì‹œ:
modules/ecr/v1.0.0
modules/alb/v1.1.0
modules/ecs-service/v2.0.0
```

### Semantic Versioning

- **Major (v2.0.0)**: Breaking changes (í˜¸í™˜ì„± ê¹¨ì§)
  - í•„ìˆ˜ ë³€ìˆ˜ ì¶”ê°€
  - ì¶œë ¥ ë³€ìˆ˜ ì‚­ì œ
  - ë¦¬ì†ŒìŠ¤ ì´ë¦„ ë³€ê²½

- **Minor (v1.1.0)**: ê¸°ëŠ¥ ì¶”ê°€ (í•˜ìœ„ í˜¸í™˜)
  - ì„ íƒì  ë³€ìˆ˜ ì¶”ê°€
  - ìƒˆ ì¶œë ¥ ë³€ìˆ˜ ì¶”ê°€
  - ìƒˆ ê¸°ëŠ¥ ì¶”ê°€

- **Patch (v1.0.1)**: ë²„ê·¸ ìˆ˜ì • (í•˜ìœ„ í˜¸í™˜)
  - ë²„ê·¸ ìˆ˜ì •
  - ë¬¸ì„œ ê°œì„ 
  - ë¦¬íŒ©í† ë§

### ë²„ì „ ì—…ê·¸ë ˆì´ë“œ

```bash
# 1. í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ ë²„ì „ í™•ì¸
grep "ref=" terraform/ecr/main.tf

# 2. ìƒˆ ë²„ì „ í™•ì¸
/if/module info ecr

# 3. ìƒˆ ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸
# terraform/ecr/main.tfì—ì„œ ref ê°’ ë³€ê²½
source = "git::...?ref=modules/ecr/v1.1.0"

# 4. Terraform ì¬ì´ˆê¸°í™”
cd terraform/ecr
terraform init -upgrade
terraform plan
```

## ëª¨ë“ˆ ê°œë°œ ê°€ì´ë“œ

### ìƒˆ ëª¨ë“ˆ ë§Œë“¤ê¸° (Infrastructure ë ˆí¬ì—ì„œ)

```bash
# 1. Infrastructure ë ˆí¬ì—ì„œ ì‘ì—…
cd /Users/sangwon-ryu/infrastructure

# 2. ëª¨ë“ˆ ë””ë ‰í† ë¦¬ ìƒì„±
mkdir -p terraform/modules/my-module/{examples/basic}

# 3. í•„ìˆ˜ íŒŒì¼ ìƒì„±
cd terraform/modules/my-module
touch main.tf variables.tf outputs.tf versions.tf README.md CHANGELOG.md

# 4. ì˜ˆì œ ì‘ì„±
cd examples/basic
touch main.tf variables.tf
```

### ëª¨ë“ˆ ë²„ì „ íƒœê¹…

```bash
# 1. CHANGELOG.md ì—…ë°ì´íŠ¸
vim terraform/modules/ecr/CHANGELOG.md

# 2. ë³€ê²½ì‚¬í•­ ì»¤ë°‹
git add terraform/modules/ecr/
git commit -m "feat(ecr): Add lifecycle policy configuration"

# 3. Git íƒœê·¸ ìƒì„±
git tag -a modules/ecr/v1.1.0 -m "Release ECR module v1.1.0"

# 4. í‘¸ì‹œ
git push origin main
git push origin modules/ecr/v1.1.0
```

## ìë™í™” ìŠ¤í¬ë¦½íŠ¸

**ìœ„ì¹˜**: `/Users/sangwon-ryu/infrastructure/scripts/modules/module-manager.sh`

**ì§ì ‘ ì‹¤í–‰**:
```bash
# Infrastructure ë ˆí¬ì—ì„œ
./scripts/modules/module-manager.sh list
./scripts/modules/module-manager.sh info ecr
./scripts/modules/module-manager.sh get ecr@v1.0.0
./scripts/modules/module-manager.sh init ecr

# ë‹¤ë¥¸ í”„ë¡œì íŠ¸ì—ì„œ (ì ˆëŒ€ ê²½ë¡œ ì‚¬ìš©)
/Users/sangwon-ryu/infrastructure/scripts/modules/module-manager.sh list
```

## ì£¼ì˜ì‚¬í•­

### âœ… Do's

- í•­ìƒ ë²„ì „ì„ ëª…ì‹œí•´ì„œ ì‚¬ìš© (`@v1.0.0`)
- CHANGELOG.mdë¥¼ ë°˜ë“œì‹œ ì—…ë°ì´íŠ¸
- Breaking changesëŠ” Major ë²„ì „ ì—…
- ëª¨ë“ˆ ë³€ê²½ ì „ `/if/validate` ì‹¤í–‰

### âŒ Don'ts

- `ref=main` ì‚¬ìš© ì§€ì–‘ (í”„ë¡œë•ì…˜ì—ì„œ)
- ë²„ì „ ì—†ì´ ì‚¬ìš©í•˜ì§€ ë§ ê²ƒ
- ëª¨ë“ˆ ë‚´ë¶€ êµ¬ì¡°ë¥¼ ì§ì ‘ ìˆ˜ì •í•˜ì§€ ë§ ê²ƒ
- Git íƒœê·¸ ì‚­ì œí•˜ì§€ ë§ ê²ƒ

## íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŒ

```bash
# ì¦ìƒ: Module not found
Error: Failed to download module

# í•´ê²°:
1. Git ì €ì¥ì†Œ URL í™•ì¸
2. Git íƒœê·¸ ì¡´ì¬ í™•ì¸: git tag -l "modules/ecr/*"
3. ë„¤íŠ¸ì›Œí¬ ì—°ê²° í™•ì¸
```

### ë²„ì „ ì¶©ëŒ

```bash
# ì¦ìƒ: Version conflict
Error: Module version X is not compatible

# í•´ê²°:
1. CHANGELOG.mdì—ì„œ í˜¸í™˜ì„± í™•ì¸
2. Breaking changes ëª©ë¡ í™•ì¸
3. í•„ìš”ì‹œ ì½”ë“œ ë§ˆì´ê·¸ë ˆì´ì…˜
```

### Terraform init ì‹¤íŒ¨

```bash
# ì¦ìƒ: Terraform init fails
Error: Error downloading modules

# í•´ê²°:
1. Git credentials í™•ì¸
2. SSH í‚¤ ì„¤ì • í™•ì¸ (private repoì¸ ê²½ìš°)
3. Terraform version í™•ì¸ (>= 1.0)
```

## ê´€ë ¨ ë¬¸ì„œ

- [Multi-Repo ì•„í‚¤í…ì²˜ ì „ëµ](../../architecture/multi-repo-strategy.md)
- [Module ê°œë°œ ê°€ì´ë“œ](../../modules/README.md)
- [Atlantis ì„¤ì • ê°€ì´ë“œ](./atlantis.md)

## ì‹¤ì „ ì˜ˆì œ

### ì˜ˆì œ 1: FileFlow ECR ì„¤ì •

```hcl
# terraform/ecr/main.tf
module "ecr" {
  source = "git::https://github.com/ryuqqq/infrastructure.git//terraform/modules/ecr?ref=modules/ecr/v1.0.0"

  repository_name      = "fileflow"
  image_tag_mutability = "MUTABLE"
  scan_on_push         = true

  lifecycle_policy = {
    rules = [
      {
        rulePriority = 1
        description  = "Keep last 30 tagged images"
        selection = {
          tagStatus     = "tagged"
          tagPrefixList = ["v"]
          countType     = "imageCountMoreThan"
          countNumber   = 30
        }
      }
    ]
  }

  common_tags = {
    Environment = "prod"
    Service     = "fileflow"
    ManagedBy   = "terraform"
  }
}
```

### ì˜ˆì œ 2: ALB + ECS Service

```hcl
# terraform/alb/main.tf
module "alb" {
  source = "git::https://github.com/ryuqqq/infrastructure.git//terraform/modules/alb?ref=modules/alb/v1.0.0"

  name               = "fileflow-alb"
  vpc_id             = data.aws_ssm_parameter.vpc_id.value
  subnets            = split(",", data.aws_ssm_parameter.public_subnet_ids.value)
  security_group_ids = [aws_security_group.alb.id]

  certificate_arn = data.aws_ssm_parameter.certificate_arn.value

  common_tags = local.common_tags
}

# terraform/ecs-service/main.tf
module "ecs_service" {
  source = "git::https://github.com/ryuqqq/infrastructure.git//terraform/modules/ecs-service?ref=modules/ecs-service/v1.2.0"

  cluster_id      = data.aws_ecs_cluster.main.id
  service_name    = "fileflow"
  task_definition = aws_ecs_task_definition.fileflow.arn
  desired_count   = 2

  load_balancer = {
    target_group_arn = module.alb.target_group_arn
    container_name   = "fileflow"
    container_port   = 8080
  }

  common_tags = local.common_tags
}
```

## FAQ

**Q: ëª¨ë“ˆ ë²„ì „ì€ ì–´ë–»ê²Œ ì„ íƒí•˜ë‚˜ìš”?**
A: í”„ë¡œë•ì…˜ì—ì„œëŠ” í•­ìƒ íŠ¹ì • ë²„ì „(`v1.0.0`)ì„ ì‚¬ìš©í•˜ì„¸ìš”. ê°œë°œ/í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œë§Œ `main` ë¸Œëœì¹˜ ì‚¬ìš©ì„ ê³ ë ¤í•˜ì„¸ìš”.

**Q: ëª¨ë“ˆì„ ìˆ˜ì •í•˜ê³  ì‹¶ì–´ìš”.**
A: Infrastructure ë ˆí¬ì—ì„œ ìˆ˜ì • â†’ Git íƒœê·¸ ìƒì„± â†’ ë‹¤ë¥¸ í”„ë¡œì íŠ¸ì—ì„œ ìƒˆ ë²„ì „ ì°¸ì¡°

**Q: Private repoì—ì„œ ëª¨ë“ˆì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‚˜ìš”?**
A: ë„¤, SSH í‚¤ ë˜ëŠ” Git credentialsê°€ ì„¤ì •ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

**Q: ì—¬ëŸ¬ í”„ë¡œì íŠ¸ì—ì„œ ê°™ì€ ëª¨ë“ˆì˜ ë‹¤ë¥¸ ë²„ì „ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë‚˜ìš”?**
A: ë„¤, ê° í”„ë¡œì íŠ¸ëŠ” ë…ë¦½ì ìœ¼ë¡œ ë²„ì „ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.
