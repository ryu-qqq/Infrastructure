# Infrastructure Shared Resources Command

**Task**: infrastructure í”„ë¡œì íŠ¸ì—ì„œ ì´ë¯¸ ë°°í¬ëœ ê³µìœ  ì¸í”„ë¼ë¥¼ ë‹¤ë¥¸ í”„ë¡œì íŠ¸ì—ì„œ ì°¸ì¡°í•  ìˆ˜ ìˆê²Œ ë„ì™€ì¤ë‹ˆë‹¤.

## í•µì‹¬ ê°œë…

ì´ infrastructure ë ˆí¬ëŠ” **ì¤‘ì•™ ì§‘ì¤‘ì‹ ê³µìœ  ì¸í”„ë¼**ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
ë‹¤ë¥¸ í”„ë¡œì íŠ¸(ì˜ˆ: fileflow, api-server)ì—ì„œ ì´ë¯¸ ë°°í¬ëœ ê³µìœ  ë¦¬ì†ŒìŠ¤ë¥¼ SSM Parameter Storeë¥¼ í†µí•´ ì°¸ì¡°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ì°¸ì¡° ë°©ë²•**: SSM Parameter Store + Terraform data sources (import ë¶ˆí•„ìš”)

## ëª¨ë“ˆ vs ê³µìœ  ì¸í”„ë¼

| êµ¬ë¶„ | ëª¨ë“ˆ (`/if/module`) | ê³µìœ  ì¸í”„ë¼ (`/if/shared`) |
|------|-------------------|------------------------|
| ëª©ì  | ìƒˆ ë¦¬ì†ŒìŠ¤ ìƒì„± | ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ ì°¸ì¡° |
| ë°©ì‹ | Terraform module ì‚¬ìš© | Terraform data source ì‚¬ìš© |
| ë²„ì „ | Git íƒœê·¸ ë²„ì „ ê´€ë¦¬ | ë°°í¬ëœ í˜„ì¬ ìƒíƒœ |
| ì˜ˆì‹œ | ECR, ALB, ECS ìƒì„± | RDS, VPC, S3 ì°¸ì¡° |

## ì‚¬ìš© ê°€ëŠ¥í•œ ì»¤ë§¨ë“œ

### 1. ğŸ“‹ ê³µìœ  ë¦¬ì†ŒìŠ¤ ëª©ë¡ ì¡°íšŒ

```bash
# Claude Codeì—ì„œ
/if/shared list

# ë˜ëŠ” ì§ì ‘ ì‹¤í–‰
./scripts/shared/shared-infra-manager.sh list
```

**ì¶œë ¥ ì˜ˆì‹œ**:
```
â„¹ï¸  ì‚¬ìš© ê°€ëŠ¥í•œ ê³µìœ  ì¸í”„ë¼ ë¦¬ì†ŒìŠ¤:

ğŸ—„ï¸  tfstate
   ğŸ“ Terraform State Storage (S3)
   ğŸ“‚ terraform/tfstate

ğŸ”’ tflock
   ğŸ“ Terraform State Lock (DynamoDB)
   ğŸ“‚ terraform/tfstate

ğŸŒ vpc
   ğŸ“ VPC Network
   ğŸ“‚ terraform/network

ğŸ“Š rds
   ğŸ“ RDS MySQL Database
   ğŸ“‚ terraform/rds

ğŸ”‘ kms
   ğŸ“ KMS Encryption Keys
   ğŸ“‚ terraform/kms

ğŸ“ˆ amp
   ğŸ“ Amazon Managed Prometheus
   ğŸ“‚ terraform/monitoring

ğŸ“Š amg
   ğŸ“ Amazon Managed Grafana
   ğŸ“‚ terraform/monitoring

ğŸŒ route53
   ğŸ“ Route53 Hosted Zones
   ğŸ“‚ terraform/dns

ğŸ”’ acm
   ğŸ“ ACM SSL Certificates
   ğŸ“‚ terraform/dns

ğŸ” secrets
   ğŸ“ Secrets Manager
   ğŸ“‚ terraform/secrets

ğŸ“‹ cloudtrail
   ğŸ“ CloudTrail Audit Logging
   ğŸ“‚ terraform/audit

ğŸ“ logging
   ğŸ“ Centralized Logging (S3)
   ğŸ“‚ terraform/logging
```

### 2. ğŸ” ê³µìœ  ë¦¬ì†ŒìŠ¤ ìƒì„¸ ì •ë³´

```bash
# Claude Codeì—ì„œ
/if/shared info rds

# ë˜ëŠ” ì§ì ‘ ì‹¤í–‰
./scripts/shared/shared-infra-manager.sh info rds
```

**ì¶œë ¥ ë‚´ìš©**:
- SSM Parameter Store ê²½ë¡œ ëª©ë¡
- í˜„ì¬ AWSì— ë°°í¬ëœ ì‹¤ì œ ê°’ (AWS CLI ì‚¬ìš© ê°€ëŠ¥ ì‹œ)
- Terraform data source ì‚¬ìš© ì˜ˆì œ
- Secrets Manager í†µí•© (RDS ë“±)

**ì¶œë ¥ ì˜ˆì‹œ**:
```
â„¹ï¸  ê³µìœ  ë¦¬ì†ŒìŠ¤: RDS MySQL Database

ğŸ“‹ SSM Parameters:
  âœ“ /shared/rds/db-instance-id
    Current value: prod-shared-mysql

  âœ“ /shared/rds/db-instance-address
    Current value: prod-shared-mysql.cfacertspqbw.ap-northeast-2.rds.amazonaws.com

  âœ“ /shared/rds/db-instance-port
    Current value: 3306

  âœ“ /shared/rds/master-password-secret-name
    Current value: prod-shared-mysql-master-password

  âœ“ /shared/rds/db-security-group-id
    Current value: sg-0d9b6f65239b16b44

ğŸ’¡ Terraformì—ì„œ ì‚¬ìš©í•˜ëŠ” ë°©ë²•:
data "aws_ssm_parameter" "rds_address" {
  name = "/shared/rds/db-instance-address"
}

output "rds_endpoint" {
  value = data.aws_ssm_parameter.rds_address.value
}
```

### 3. ğŸ“¦ ê³µìœ  ë¦¬ì†ŒìŠ¤ ì½”ë“œ ìƒì„±

```bash
# Claude Codeì—ì„œ
/if/shared get rds

# ë˜ëŠ” ì§ì ‘ ì‹¤í–‰
./scripts/shared/shared-infra-manager.sh get rds
```

**ì¶œë ¥ ë‚´ìš©**:
- ì™„ì „í•œ Terraform data source ì½”ë“œ
- SSM Parameter ì°¸ì¡°
- Secrets Manager í†µí•© (í•„ìš” ì‹œ)
- Local variablesë¡œ ë””ì½”ë”©ëœ ê°’

**ìƒì„±ë˜ëŠ” íŒŒì¼ ì˜ˆì‹œ (`/tmp/shared-rds.tf`)**:
```hcl
# Shared Infrastructure Reference: RDS MySQL Database
# Auto-generated by /if/shared get rds
# Description: Shared MySQL database

# RDS Connection Information
data "aws_ssm_parameter" "rds_address" {
  name = "/shared/rds/db-instance-address"
}

data "aws_ssm_parameter" "rds_port" {
  name = "/shared/rds/db-instance-port"
}

data "aws_ssm_parameter" "rds_security_group" {
  name = "/shared/rds/db-security-group-id"
}

# RDS Credentials (from Secrets Manager)
data "aws_ssm_parameter" "rds_secret_name" {
  name = "/shared/rds/master-password-secret-name"
}

data "aws_secretsmanager_secret" "rds" {
  name = data.aws_ssm_parameter.rds_secret_name.value
}

data "aws_secretsmanager_secret_version" "rds" {
  secret_id = data.aws_secretsmanager_secret.rds.id
}

# Decoded credentials
locals {
  rds_credentials = jsondecode(data.aws_secretsmanager_secret_version.rds.secret_string)
  rds_username    = local.rds_credentials.username
  rds_password    = local.rds_credentials.password
  rds_dbname      = local.rds_credentials.dbname
  rds_endpoint    = "${data.aws_ssm_parameter.rds_address.value}:${data.aws_ssm_parameter.rds_port.value}"
}
```

## ì›Œí¬í”Œë¡œìš° ì˜ˆì‹œ

### FileFlow í”„ë¡œì íŠ¸ì—ì„œ ê³µìœ  RDS ì‚¬ìš©í•˜ê¸°

```bash
# 1. FileFlow í”„ë¡œì íŠ¸ë¡œ ì´ë™
cd ~/fileflow

# 2. ì‚¬ìš© ê°€ëŠ¥í•œ ê³µìœ  ë¦¬ì†ŒìŠ¤ í™•ì¸
/if/shared list

# 3. RDS ìƒì„¸ ì •ë³´ í™•ì¸
/if/shared info rds

# 4. RDS ì°¸ì¡° ì½”ë“œ ìƒì„±
/if/shared get rds

# 5. ìƒì„±ëœ íŒŒì¼ì„ í”„ë¡œì íŠ¸ë¡œ ë³µì‚¬
cp /tmp/shared-rds.tf terraform/shared-rds.tf

# 6. ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œì—ì„œ ì‚¬ìš©
# main.tfì—ì„œ localsë¥¼ ì°¸ì¡°
resource "aws_ecs_task_definition" "app" {
  # ...

  environment = [
    {
      name  = "DB_HOST"
      value = local.rds_endpoint
    },
    {
      name  = "DB_USER"
      value = local.rds_username
    }
  ]

  secrets = [
    {
      name      = "DB_PASSWORD"
      valueFrom = data.aws_secretsmanager_secret.rds.arn
    }
  ]
}
```

### ì—¬ëŸ¬ ê³µìœ  ë¦¬ì†ŒìŠ¤ë¥¼ í•¨ê»˜ ì‚¬ìš©í•˜ëŠ” ê²½ìš°

```bash
# 1. í•„ìš”í•œ ê³µìœ  ë¦¬ì†ŒìŠ¤ ì½”ë“œ ìƒì„±
/if/shared get vpc
/if/shared get rds
/if/shared get kms
/if/shared get amp

# 2. í”„ë¡œì íŠ¸ë¡œ ë³µì‚¬
cp /tmp/shared-vpc.tf terraform/
cp /tmp/shared-rds.tf terraform/
cp /tmp/shared-kms.tf terraform/
cp /tmp/shared-amp.tf terraform/

# 3. í”„ë¡œì íŠ¸ êµ¬ì¡°
fileflow/
â”œâ”€â”€ src/                    # ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ
â”œâ”€â”€ terraform/
â”‚   â”œâ”€â”€ provider.tf
â”‚   â”œâ”€â”€ variables.tf
â”‚   â”œâ”€â”€ shared-vpc.tf       # VPC ì°¸ì¡°
â”‚   â”œâ”€â”€ shared-rds.tf       # RDS ì°¸ì¡°
â”‚   â”œâ”€â”€ shared-kms.tf       # KMS ì°¸ì¡°
â”‚   â”œâ”€â”€ shared-amp.tf       # AMP ì°¸ì¡°
â”‚   â””â”€â”€ main.tf             # ì• í”Œë¦¬ì¼€ì´ì…˜ ë¦¬ì†ŒìŠ¤
â””â”€â”€ atlantis.yaml
```

## ì‚¬ìš© ê°€ëŠ¥í•œ ê³µìœ  ë¦¬ì†ŒìŠ¤

### ğŸ—„ï¸ Terraform State (tfstate)
**SSM Parameters**:
- `/shared/tfstate/bucket-name`: S3 ë²„í‚· ì´ë¦„
- `/shared/tfstate/bucket-arn`: S3 ë²„í‚· ARN
- `/shared/tfstate/kms-key-id`: KMS í‚¤ ID

**ì‚¬ìš© ëª©ì **: Terraform backend ì„¤ì •

```hcl
terraform {
  backend "s3" {
    bucket         = "ryuqqq-prod-tfstate"
    key            = "fileflow/terraform.tfstate"
    region         = "ap-northeast-2"
    encrypt        = true
    dynamodb_table = "terraform-lock"
    kms_key_id     = "alias/terraform-state"
  }
}
```

### ğŸ”’ Terraform Lock (tflock)
**SSM Parameters**:
- `/shared/tflock/table-name`: DynamoDB í…Œì´ë¸” ì´ë¦„
- `/shared/tflock/table-arn`: DynamoDB í…Œì´ë¸” ARN

**ì‚¬ìš© ëª©ì **: Terraform state lock

### ğŸŒ VPC (vpc)
**SSM Parameters**:
- `/shared/vpc/vpc-id`: VPC ID
- `/shared/vpc/cidr-block`: VPC CIDR

**ì‚¬ìš© ëª©ì **: ë³´ì•ˆ ê·¸ë£¹, ì„œë¸Œë„· ì„¤ì •

```hcl
resource "aws_security_group" "app" {
  vpc_id = data.aws_ssm_parameter.vpc_id.value
  # ...
}
```

### ğŸ“¡ Subnets (subnets)
**SSM Parameters**:
- `/shared/vpc/public-subnet-ids`: Public ì„œë¸Œë„· (ì‰¼í‘œ êµ¬ë¶„)
- `/shared/vpc/private-subnet-ids`: Private ì„œë¸Œë„· (ì‰¼í‘œ êµ¬ë¶„)
- `/shared/vpc/data-subnet-ids`: Data ì„œë¸Œë„· (ì‰¼í‘œ êµ¬ë¶„)

**ì‚¬ìš© ëª©ì **: ALB, ECS, RDS ë°°ì¹˜

```hcl
resource "aws_lb" "main" {
  subnets = split(",", data.aws_ssm_parameter.public_subnet_ids.value)
  # ...
}
```

### ğŸ“Š RDS (rds)
**SSM Parameters**:
- `/shared/rds/db-instance-id`: RDS ì¸ìŠ¤í„´ìŠ¤ ID
- `/shared/rds/db-instance-address`: RDS ì—”ë“œí¬ì¸íŠ¸
- `/shared/rds/db-instance-port`: RDS í¬íŠ¸
- `/shared/rds/master-password-secret-name`: Secrets Manager ì´ë¦„
- `/shared/rds/db-security-group-id`: RDS ë³´ì•ˆ ê·¸ë£¹

**ì‚¬ìš© ëª©ì **: ê³µìœ  MySQL ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°

### ğŸ”‘ KMS (kms)
**SSM Parameters**:
- `/shared/kms/ebs-key-arn`: EBS ì•”í˜¸í™” í‚¤
- `/shared/kms/s3-key-arn`: S3 ì•”í˜¸í™” í‚¤
- `/shared/kms/rds-key-arn`: RDS ì•”í˜¸í™” í‚¤
- `/shared/kms/secrets-key-arn`: Secrets Manager í‚¤
- `/shared/kms/logs-key-arn`: CloudWatch Logs í‚¤

**ì‚¬ìš© ëª©ì **: ë¦¬ì†ŒìŠ¤ ì•”í˜¸í™”

```hcl
resource "aws_s3_bucket_server_side_encryption_configuration" "example" {
  rule {
    apply_server_side_encryption_by_default {
      sse_algorithm     = "aws:kms"
      kms_master_key_id = data.aws_ssm_parameter.s3_kms_key.value
    }
  }
}
```

### ğŸ“ˆ AMP (Amazon Managed Prometheus)
**SSM Parameters**:
- `/shared/monitoring/amp-workspace-id`: AMP Workspace ID
- `/shared/monitoring/amp-endpoint`: Prometheus ì—”ë“œí¬ì¸íŠ¸

**ì‚¬ìš© ëª©ì **: ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ë° ëª¨ë‹ˆí„°ë§

```hcl
# Prometheus remote write ì„¤ì •
remote_write:
  - url: "${data.aws_ssm_parameter.amp_endpoint.value}api/v1/remote_write"
```

### ğŸ“Š AMG (Amazon Managed Grafana)
**SSM Parameters**:
- `/shared/monitoring/amg-workspace-id`: AMG Workspace ID
- `/shared/monitoring/amg-endpoint`: Grafana ì—”ë“œí¬ì¸íŠ¸

**ì‚¬ìš© ëª©ì **: ëŒ€ì‹œë³´ë“œ ë° ì‹œê°í™”

### ğŸŒ Route53 (route53)
**SSM Parameters**:
- `/shared/dns/hosted-zone-id`: Route53 Hosted Zone ID
- `/shared/dns/domain-name`: ë„ë©”ì¸ ì´ë¦„

**ì‚¬ìš© ëª©ì **: DNS ë ˆì½”ë“œ ìƒì„±

```hcl
resource "aws_route53_record" "app" {
  zone_id = data.aws_ssm_parameter.hosted_zone_id.value
  name    = "app.${data.aws_ssm_parameter.domain_name.value}"
  # ...
}
```

### ğŸ”’ ACM (acm)
**SSM Parameters**:
- `/shared/acm/certificate-arn`: SSL ì¸ì¦ì„œ ARN

**ì‚¬ìš© ëª©ì **: ALB HTTPS ë¦¬ìŠ¤ë„ˆ

```hcl
resource "aws_lb_listener" "https" {
  certificate_arn = data.aws_ssm_parameter.certificate_arn.value
  # ...
}
```

### ğŸ” Secrets Manager (secrets)
**SSM Parameters**:
- `/shared/secrets/kms-key-arn`: Secrets ì•”í˜¸í™” í‚¤

**ì‚¬ìš© ëª©ì **: ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œí¬ë¦¿ ì €ì¥

### ğŸ“‹ CloudTrail (cloudtrail)
**SSM Parameters**:
- `/shared/audit/cloudtrail-name`: CloudTrail ì´ë¦„
- `/shared/audit/cloudtrail-arn`: CloudTrail ARN
- `/shared/audit/cloudtrail-bucket`: ê°ì‚¬ ë¡œê·¸ S3 ë²„í‚·

**ì‚¬ìš© ëª©ì **: ê°ì‚¬ ë¡œê·¸ ì°¸ì¡°

### ğŸ“ Logging (logging)
**SSM Parameters**:
- `/shared/logging/s3-bucket`: ì¤‘ì•™ ë¡œê·¸ S3 ë²„í‚·
- `/shared/logging/firehose-arn`: Kinesis Firehose ARN

**ì‚¬ìš© ëª©ì **: ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ ì „ì†¡

## ìë™í™” ìŠ¤í¬ë¦½íŠ¸

**ìœ„ì¹˜**: `/Users/sangwon-ryu/infrastructure/scripts/shared/shared-infra-manager.sh`

**ì§ì ‘ ì‹¤í–‰**:
```bash
# Infrastructure ë ˆí¬ì—ì„œ
./scripts/shared/shared-infra-manager.sh list
./scripts/shared/shared-infra-manager.sh info rds
./scripts/shared/shared-infra-manager.sh get rds

# ë‹¤ë¥¸ í”„ë¡œì íŠ¸ì—ì„œ (ì ˆëŒ€ ê²½ë¡œ ì‚¬ìš©)
/Users/sangwon-ryu/infrastructure/scripts/shared/shared-infra-manager.sh list
```

## ì£¼ì˜ì‚¬í•­

### âœ… Do's

- ê³µìœ  ì¸í”„ë¼ëŠ” **ì½ê¸° ì „ìš©**ìœ¼ë¡œ ì°¸ì¡°ë§Œ í•˜ì„¸ìš”
- SSM Parameter Store ê°’ì´ ë³€ê²½ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ í•˜ë“œì½”ë”©í•˜ì§€ ë§ˆì„¸ìš”
- Secrets Managerë¥¼ í†µí•´ ì•ˆì „í•˜ê²Œ í¬ë ˆë´ì…œ ì ‘ê·¼í•˜ì„¸ìš”
- ê° í”„ë¡œì íŠ¸ì—ì„œ í•„ìš”í•œ ë¦¬ì†ŒìŠ¤ë§Œ ì°¸ì¡°í•˜ì„¸ìš”

### âŒ Don'ts

- ê³µìœ  ì¸í”„ë¼ë¥¼ ì§ì ‘ ìˆ˜ì •í•˜ì§€ ë§ˆì„¸ìš” (Infrastructure ë ˆí¬ì—ì„œë§Œ ê´€ë¦¬)
- `terraform import`ë¡œ ê°€ì ¸ì˜¤ì§€ ë§ˆì„¸ìš” (data source ì‚¬ìš©)
- SSM Parameter ì´ë¦„ì„ í•˜ë“œì½”ë”©í•˜ì§€ ë§ˆì„¸ìš”
- í¬ë ˆë´ì…œì„ í™˜ê²½ ë³€ìˆ˜ë‚˜ ì½”ë“œì— ì§ì ‘ ì €ì¥í•˜ì§€ ë§ˆì„¸ìš”

## íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### SSM Parameterë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ

```bash
# ì¦ìƒ: Parameter not found
Error: error getting SSM parameter: ParameterNotFound

# í•´ê²°:
1. Infrastructure ë ˆí¬ì—ì„œ í•´ë‹¹ ë¦¬ì†ŒìŠ¤ê°€ ë°°í¬ë˜ì—ˆëŠ”ì§€ í™•ì¸
2. SSM Parameterê°€ ì˜¬ë°”ë¥¸ ê²½ë¡œì— exportë˜ì—ˆëŠ”ì§€ í™•ì¸
3. AWS ë¦¬ì „ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸ (ap-northeast-2)
```

### Secrets Manager ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ

```bash
# ì¦ìƒ: Access denied to Secrets Manager
Error: AccessDeniedException

# í•´ê²°:
1. IAM ì—­í• ì— Secrets Manager ì½ê¸° ê¶Œí•œ ì¶”ê°€
2. KMS í‚¤ì— ëŒ€í•œ ë³µí˜¸í™” ê¶Œí•œ í™•ì¸
3. Resource-based policy í™•ì¸
```

### ê°’ì´ ì—…ë°ì´íŠ¸ë˜ì§€ ì•ŠìŒ

```bash
# ì¦ìƒ: Terraformì´ ì´ì „ ê°’ì„ ê³„ì† ì‚¬ìš©
Plan shows no changes

# í•´ê²°:
1. terraform refresh ì‹¤í–‰
2. SSM Parameter Storeì—ì„œ ì‹¤ì œ ê°’ í™•ì¸ (AWS Console or CLI)
3. Data sourceê°€ ì˜¬ë°”ë¥¸ parameterë¥¼ ì°¸ì¡°í•˜ëŠ”ì§€ í™•ì¸
```

## ê´€ë ¨ ë¬¸ì„œ

- [Multi-Repo ì•„í‚¤í…ì²˜ ì „ëµ](../../architecture/multi-repo-strategy.md)
- [SSM Parameter Store ê°€ì´ë“œ](../../guides/ssm-parameters.md)
- [Module ê°œë°œ ê°€ì´ë“œ](./module.md)
- [Atlantis ì„¤ì • ê°€ì´ë“œ](./atlantis.md)

## ì‹¤ì „ ì˜ˆì œ

### ì˜ˆì œ 1: FileFlowì—ì„œ ê³µìœ  RDS + VPC ì‚¬ìš©

```hcl
# terraform/shared-infrastructure.tf
# RDS ì°¸ì¡°
data "aws_ssm_parameter" "rds_address" {
  name = "/shared/rds/db-instance-address"
}

data "aws_ssm_parameter" "rds_secret_name" {
  name = "/shared/rds/master-password-secret-name"
}

data "aws_secretsmanager_secret_version" "rds" {
  secret_id = data.aws_secretsmanager_secret.rds.id
}

# VPC ì°¸ì¡°
data "aws_ssm_parameter" "vpc_id" {
  name = "/shared/vpc/vpc-id"
}

data "aws_ssm_parameter" "private_subnet_ids" {
  name = "/shared/vpc/private-subnet-ids"
}

locals {
  rds_credentials = jsondecode(data.aws_secretsmanager_secret_version.rds.secret_string)
  vpc_id          = data.aws_ssm_parameter.vpc_id.value
  private_subnets = split(",", data.aws_ssm_parameter.private_subnet_ids.value)
}

# terraform/main.tf
resource "aws_ecs_task_definition" "fileflow" {
  family = "fileflow"

  container_definitions = jsonencode([
    {
      name  = "fileflow"
      image = "${aws_ecr_repository.fileflow.repository_url}:latest"

      environment = [
        {
          name  = "DB_HOST"
          value = data.aws_ssm_parameter.rds_address.value
        },
        {
          name  = "DB_USER"
          value = local.rds_credentials.username
        },
        {
          name  = "DB_NAME"
          value = local.rds_credentials.dbname
        }
      ]

      secrets = [
        {
          name      = "DB_PASSWORD"
          valueFrom = data.aws_secretsmanager_secret.rds.arn
        }
      ]
    }
  ])
}

resource "aws_security_group" "fileflow" {
  vpc_id = local.vpc_id

  egress {
    from_port   = 3306
    to_port     = 3306
    protocol    = "tcp"
    cidr_blocks = ["10.0.0.0/16"]
  }
}
```

### ì˜ˆì œ 2: API Serverì—ì„œ ê³µìœ  ëª¨ë‹ˆí„°ë§ ìŠ¤íƒ ì‚¬ìš©

```hcl
# terraform/shared-monitoring.tf
data "aws_ssm_parameter" "amp_endpoint" {
  name = "/shared/monitoring/amp-endpoint"
}

data "aws_ssm_parameter" "amg_endpoint" {
  name = "/shared/monitoring/amg-endpoint"
}

# Prometheus remote write ì„¤ì •
resource "aws_ecs_task_definition" "api_server" {
  container_definitions = jsonencode([
    {
      name  = "api-server"

      environment = [
        {
          name  = "PROMETHEUS_REMOTE_WRITE_URL"
          value = "${data.aws_ssm_parameter.amp_endpoint.value}api/v1/remote_write"
        }
      ]
    }
  ])
}
```

### ì˜ˆì œ 3: ì™„ì „í•œ ê³µìœ  ì¸í”„ë¼ ì°¸ì¡° íŒ¨í„´

```hcl
# terraform/shared.tf - ëª¨ë“  ê³µìœ  ë¦¬ì†ŒìŠ¤ í•œ ë²ˆì— ì°¸ì¡°
locals {
  # VPC
  vpc_id          = data.aws_ssm_parameter.vpc_id.value
  public_subnets  = split(",", data.aws_ssm_parameter.public_subnet_ids.value)
  private_subnets = split(",", data.aws_ssm_parameter.private_subnet_ids.value)

  # RDS
  rds_endpoint    = data.aws_ssm_parameter.rds_address.value
  rds_credentials = jsondecode(data.aws_secretsmanager_secret_version.rds.secret_string)

  # KMS
  kms_key_s3   = data.aws_ssm_parameter.s3_kms_key.value
  kms_key_logs = data.aws_ssm_parameter.logs_kms_key.value

  # DNS
  hosted_zone_id  = data.aws_ssm_parameter.hosted_zone_id.value
  domain_name     = data.aws_ssm_parameter.domain_name.value
  certificate_arn = data.aws_ssm_parameter.certificate_arn.value

  # Monitoring
  amp_endpoint = data.aws_ssm_parameter.amp_endpoint.value
  amg_endpoint = data.aws_ssm_parameter.amg_endpoint.value
}

# terraform/main.tfì—ì„œ local ê°’ë“¤ì„ ì‚¬ìš©
resource "aws_lb" "main" {
  subnets            = local.public_subnets
  security_groups    = [aws_security_group.alb.id]

  tags = {
    Name = "${var.service_name}-alb"
  }
}

resource "aws_lb_listener" "https" {
  load_balancer_arn = aws_lb.main.arn
  port              = 443
  protocol          = "HTTPS"
  certificate_arn   = local.certificate_arn
}

resource "aws_route53_record" "app" {
  zone_id = local.hosted_zone_id
  name    = "${var.service_name}.${local.domain_name}"
  type    = "A"

  alias {
    name                   = aws_lb.main.dns_name
    zone_id                = aws_lb.main.zone_id
    evaluate_target_health = true
  }
}
```

## FAQ

**Q: ê³µìœ  ì¸í”„ë¼ì™€ ëª¨ë“ˆì˜ ì°¨ì´ëŠ” ë¬´ì—‡ì¸ê°€ìš”?**
A: ëª¨ë“ˆì€ ìƒˆ ë¦¬ì†ŒìŠ¤ë¥¼ ë§Œë“œëŠ” í…œí”Œë¦¿ì´ê³ , ê³µìœ  ì¸í”„ë¼ëŠ” ì´ë¯¸ ë°°í¬ëœ ë¦¬ì†ŒìŠ¤ë¥¼ ì°¸ì¡°í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

**Q: SSM Parameter ê°’ì´ ë³€ê²½ë˜ë©´ ì–´ë–»ê²Œ í•˜ë‚˜ìš”?**
A: `terraform refresh` ë˜ëŠ” `terraform plan`ì„ ì‹¤í–‰í•˜ë©´ ìë™ìœ¼ë¡œ ìµœì‹  ê°’ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.

**Q: ê³µìœ  ì¸í”„ë¼ë¥¼ ìˆ˜ì •í•˜ê³  ì‹¶ì–´ìš”.**
A: Infrastructure ë ˆí¬ì˜ í•´ë‹¹ Terraform ì½”ë“œë¥¼ ìˆ˜ì •í•˜ê³  ë°°í¬í•´ì•¼ í•©ë‹ˆë‹¤. ë‹¤ë¥¸ í”„ë¡œì íŠ¸ì—ì„œëŠ” ì½ê¸° ì „ìš©ì…ë‹ˆë‹¤.

**Q: ëª¨ë“  ê³µìœ  ë¦¬ì†ŒìŠ¤ë¥¼ ë°˜ë“œì‹œ ì‚¬ìš©í•´ì•¼ í•˜ë‚˜ìš”?**
A: ì•„ë‹ˆìš”, í”„ë¡œì íŠ¸ì— í•„ìš”í•œ ë¦¬ì†ŒìŠ¤ë§Œ ì°¸ì¡°í•˜ì„¸ìš”.

**Q: Private repoì—ì„œë„ ì‘ë™í•˜ë‚˜ìš”?**
A: ë„¤, SSM Parameter Storeì™€ Secrets ManagerëŠ” AWS ê³„ì • ë‚´ì—ì„œ ì‘ë™í•˜ë¯€ë¡œ repo ì ‘ê·¼ ê¶Œí•œê³¼ ë¬´ê´€í•©ë‹ˆë‹¤.

**Q: ì—¬ëŸ¬ í™˜ê²½(dev/staging/prod)ì—ì„œ ë‹¤ë¥¸ ê³µìœ  ì¸í”„ë¼ë¥¼ ì°¸ì¡°í•  ìˆ˜ ìˆë‚˜ìš”?**
A: ë„¤, SSM Parameter ê²½ë¡œì— í™˜ê²½ ì ‘ë‘ì‚¬ë¥¼ ì¶”ê°€í•˜ë©´ ë©ë‹ˆë‹¤ (ì˜ˆ: `/dev/shared/rds/...`).
