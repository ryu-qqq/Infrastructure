# ============================================================================
# Reusable Workflow: Slack Deployment Notification
#
# ë°°í¬ ê²°ê³¼ë¥¼ Slackìœ¼ë¡œ ì•Œë¦¼ (Block Kit ì‚¬ìš©)
#
# ì‚¬ìš©ë²•:
#   jobs:
#     notify:
#       uses: ryu-qqq/Infrastructure/.github/workflows/reusable-notify-slack.yml@main
#       with:
#         project-name: crawlinghub
#         environment: prod
#         status: success
#         components: '[{"name":"web-api","status":"success","image":"web-api-42-abc"},...]'
#       secrets:
#         SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
# ============================================================================

name: Reusable Slack Notification

on:
  workflow_call:
    inputs:
      # í”„ë¡œì íŠ¸ ì •ë³´
      project-name:
        description: "í”„ë¡œì íŠ¸ëª… (ì˜ˆ: CrawlingHub, FileFlow)"
        required: true
        type: string

      environment:
        description: "ë°°í¬ í™˜ê²½ (ì˜ˆ: prod, staging, dev)"
        type: string
        default: "prod"

      # ë°°í¬ ìƒíƒœ
      status:
        description: "ì „ì²´ ë°°í¬ ìƒíƒœ (success, failure, partial)"
        required: true
        type: string

      # ì»´í¬ë„ŒíŠ¸ ì •ë³´ (JSON ë°°ì—´)
      # í˜•ì‹: [{"name":"web-api","status":"success","image":"tag","build":"success","deploy":"success"},...]
      components:
        description: "ì»´í¬ë„ŒíŠ¸ë³„ ìƒíƒœ (JSON ë°°ì—´)"
        required: true
        type: string

      # ë©”íƒ€ ì •ë³´
      duration:
        description: "ì´ ì†Œìš” ì‹œê°„ (ì˜ˆ: 5m 32s)"
        type: string
        default: ""

      commit-message:
        description: "ì»¤ë°‹ ë©”ì‹œì§€"
        type: string
        default: ""

      # ì¶”ê°€ ì˜µì…˜
      mention-on-failure:
        description: "ì‹¤íŒ¨ ì‹œ ë©˜ì…˜í•  Slack ì‚¬ìš©ì/ê·¸ë£¹ (ì˜ˆ: @here, <@U123456>)"
        type: string
        default: ""

      custom-message:
        description: "ì¶”ê°€ ë©”ì‹œì§€"
        type: string
        default: ""

    secrets:
      SLACK_WEBHOOK_URL:
        description: "Slack Incoming Webhook URL"
        required: true

jobs:
  notify:
    name: Send Slack Notification
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Prepare notification data
        id: prepare
        env:
          # í™˜ê²½ë³€ìˆ˜ë¡œ ì•ˆì „í•˜ê²Œ ì „ë‹¬ (ì‰˜ command substitution ë°©ì§€)
          INPUT_COMMIT_MSG: ${{ inputs.commit-message }}
          HEAD_COMMIT_MSG: ${{ github.event.head_commit.message }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          INPUT_STATUS: ${{ inputs.status }}
          INPUT_DURATION: ${{ inputs.duration }}
        run: |
          # ìƒíƒœì— ë”°ë¥¸ ì´ëª¨ì§€ ë° ìƒ‰ìƒ ì„¤ì •
          STATUS="$INPUT_STATUS"

          case "$STATUS" in
            success)
              EMOJI="âœ…"
              COLOR="#36a64f"
              TITLE_EMOJI="ğŸš€"
              STATUS_TEXT="ë°°í¬ ì™„ë£Œ"
              ;;
            failure)
              EMOJI="âŒ"
              COLOR="#dc3545"
              TITLE_EMOJI="ğŸ”¥"
              STATUS_TEXT="ë°°í¬ ì‹¤íŒ¨"
              ;;
            partial)
              EMOJI="âš ï¸"
              COLOR="#ffc107"
              TITLE_EMOJI="âš¡"
              STATUS_TEXT="ë¶€ë¶„ ë°°í¬"
              ;;
            cancelled)
              EMOJI="ğŸš«"
              COLOR="#6c757d"
              TITLE_EMOJI="ğŸ›‘"
              STATUS_TEXT="ë°°í¬ ì·¨ì†Œ"
              ;;
            *)
              EMOJI="â„¹ï¸"
              COLOR="#17a2b8"
              TITLE_EMOJI="ğŸ“¢"
              STATUS_TEXT="ë°°í¬ ì•Œë¦¼"
              ;;
          esac

          echo "emoji=${EMOJI}" >> $GITHUB_OUTPUT
          echo "color=${COLOR}" >> $GITHUB_OUTPUT
          echo "title_emoji=${TITLE_EMOJI}" >> $GITHUB_OUTPUT
          echo "status_text=${STATUS_TEXT}" >> $GITHUB_OUTPUT

          # ì»¤ë°‹ ë©”ì‹œì§€ ì²˜ë¦¬ (í™˜ê²½ë³€ìˆ˜ë¡œ ì•ˆì „í•˜ê²Œ ì „ë‹¬ë¨)
          COMMIT_MSG="$INPUT_COMMIT_MSG"
          if [ -z "$COMMIT_MSG" ]; then
            COMMIT_MSG="${HEAD_COMMIT_MSG:-${PR_TITLE:-No message}}"
          fi
          # ì²« ì¤„ë§Œ ì‚¬ìš©í•˜ê³  íŠ¹ìˆ˜ë¬¸ì ì´ìŠ¤ì¼€ì´í”„ (ë°±í‹±, $() ì œê±°)
          COMMIT_MSG=$(printf '%s' "$COMMIT_MSG" | head -1 | tr '`' "'" | sed 's/\$(/(/g; s/"/\\"/g' | cut -c1-100)
          echo "commit_msg=${COMMIT_MSG}" >> $GITHUB_OUTPUT

          # ì†Œìš” ì‹œê°„ (ì—†ìœ¼ë©´ ê³„ì‚° ì‹œë„)
          DURATION="$INPUT_DURATION"
          if [ -z "$DURATION" ]; then
            DURATION="N/A"
          fi
          echo "duration=${DURATION}" >> $GITHUB_OUTPUT

      - name: Build component status
        id: components
        run: |
          COMPONENTS='${{ inputs.components }}'

          # JSON íŒŒì‹±í•˜ì—¬ ì»´í¬ë„ŒíŠ¸ ìƒíƒœ ë¬¸ìì—´ ìƒì„±
          # ë°±í‹± ëŒ€ì‹  *bold* ì‚¬ìš© (heredocì—ì„œ ë°±í‹±ì´ ëª…ë ¹ì–´ë¡œ í•´ì„ë˜ëŠ” ë¬¸ì œ ë°©ì§€)
          COMPONENT_TEXT=$(echo "$COMPONENTS" | jq -r '
            .[] |
            if .status == "success" then
              "âœ… *\(.name)*: \(.image // "deployed")"
            elif .status == "failure" then
              "âŒ *\(.name)*: ì‹¤íŒ¨"
            elif .status == "skipped" then
              "â­ï¸ *\(.name)*: ìŠ¤í‚µ"
            else
              "âšª *\(.name)*: \(.status)"
            end
          ' | paste -sd '\n' -)

          # ë¹Œë“œ/ë°°í¬ ìƒì„¸ ì •ë³´ê°€ ìˆëŠ” ê²½ìš°
          DETAIL_TEXT=$(echo "$COMPONENTS" | jq -r '
            .[] |
            select(.build != null or .deploy != null) |
            "â€¢ \(.name): Build=\(.build // "N/A"), Deploy=\(.deploy // "N/A")"
          ' | paste -sd '\n' -)

          # ë©€í‹°ë¼ì¸ ì¶œë ¥ ì²˜ë¦¬
          echo "component_text<<EOF" >> $GITHUB_OUTPUT
          echo "$COMPONENT_TEXT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # ì„±ê³µ/ì‹¤íŒ¨ ì¹´ìš´íŠ¸
          SUCCESS_COUNT=$(echo "$COMPONENTS" | jq '[.[] | select(.status == "success")] | length')
          FAILURE_COUNT=$(echo "$COMPONENTS" | jq '[.[] | select(.status == "failure")] | length')
          TOTAL_COUNT=$(echo "$COMPONENTS" | jq 'length')

          echo "success_count=${SUCCESS_COUNT}" >> $GITHUB_OUTPUT
          echo "failure_count=${FAILURE_COUNT}" >> $GITHUB_OUTPUT
          echo "total_count=${TOTAL_COUNT}" >> $GITHUB_OUTPUT

      - name: Send Slack notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          # í™˜ê²½ë³€ìˆ˜ë¡œ ì•ˆì „í•˜ê²Œ ì „ë‹¬ (ì‰˜ command substitution ë°©ì§€)
          INPUT_STATUS: ${{ inputs.status }}
          INPUT_MENTION: ${{ inputs.mention-on-failure }}
          INPUT_CUSTOM_MSG: ${{ inputs.custom-message }}
        run: |
          # ë©˜ì…˜ ì²˜ë¦¬
          MENTION=""
          if [ "$INPUT_STATUS" == "failure" ] && [ -n "$INPUT_MENTION" ]; then
            MENTION="$INPUT_MENTION "
          fi

          # ì»¤ìŠ¤í…€ ë©”ì‹œì§€ ì²˜ë¦¬ (íŠ¹ìˆ˜ë¬¸ì ì´ìŠ¤ì¼€ì´í”„)
          CUSTOM_MSG=""
          SAFE_CUSTOM_MSG=$(printf '%s' "$INPUT_CUSTOM_MSG" | tr '`' "'" | sed 's/\$(/(/g; s/"/\\"/g')
          if [ -n "$SAFE_CUSTOM_MSG" ]; then
            CUSTOM_MSG=$(cat <<CUSTOMMSG
          ,
          {
            "type": "section",
            "text": {
              "type": "mrkdwn",
              "text": "ğŸ’¬ ${SAFE_CUSTOM_MSG}"
            }
          }
          CUSTOMMSG
          )
          fi

          # Block Kit ë©”ì‹œì§€ êµ¬ì„±
          PAYLOAD=$(cat <<PAYLOAD
          {
            "attachments": [
              {
                "color": "${{ steps.prepare.outputs.color }}",
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "${{ steps.prepare.outputs.title_emoji }} ${{ inputs.project-name }} ${{ steps.prepare.outputs.status_text }}",
                      "emoji": true
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Environment:*\n\`${{ inputs.environment }}\`"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Status:*\n${{ steps.prepare.outputs.emoji }} ${{ steps.prepare.outputs.status_text }}"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Components:*\n${{ steps.components.outputs.success_count }}/${{ steps.components.outputs.total_count }} ì„±ê³µ"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Duration:*\nâ±ï¸ ${{ steps.prepare.outputs.duration }}"
                      }
                    ]
                  },
                  {
                    "type": "divider"
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*ğŸ“¦ Component Details:*\n${{ steps.components.outputs.component_text }}"
                    }
                  },
                  {
                    "type": "context",
                    "elements": [
                      {
                        "type": "mrkdwn",
                        "text": "ğŸ‘¤ *Actor:* ${{ github.actor }}"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "ğŸ”— *Commit:* <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${GITHUB_SHA:0:7}>"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "ğŸ“ ${{ steps.prepare.outputs.commit_msg }}"
                      }
                    ]
                  }${CUSTOM_MSG},
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "ğŸ“‹ View Workflow",
                          "emoji": true
                        },
                        "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                      },
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "ğŸ“‚ View Commit",
                          "emoji": true
                        },
                        "url": "${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
                      }
                    ]
                  }
                ]
              }
            ],
            "text": "${MENTION}${{ steps.prepare.outputs.title_emoji }} ${{ inputs.project-name }} ${{ steps.prepare.outputs.status_text }}"
          }
          PAYLOAD
          )

          # Slackìœ¼ë¡œ ì „ì†¡
          echo "ğŸ“¤ Sending notification to Slack..."

          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            "$SLACK_WEBHOOK_URL")

          if [ "$RESPONSE" == "200" ]; then
            echo "âœ… Slack notification sent successfully"
          else
            echo "âŒ Failed to send Slack notification (HTTP $RESPONSE)"
            exit 1
          fi

      - name: Output summary
        run: |
          echo "## ğŸ“¢ Slack Notification Sent" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Project** | ${{ inputs.project-name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | ${{ inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | ${{ steps.prepare.outputs.emoji }} ${{ steps.prepare.outputs.status_text }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Components** | ${{ steps.components.outputs.success_count }}/${{ steps.components.outputs.total_count }} succeeded |" >> $GITHUB_STEP_SUMMARY
