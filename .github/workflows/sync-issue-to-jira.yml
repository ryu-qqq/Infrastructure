# ============================================================================
# Sync GitHub Issue to Jira - Infrastructure Repository
#
# Infrastructure 레포 전용 Jira 동기화 워크플로우
# reusable-sync-jira.yml을 호출하여 동작
#
# 다른 레포에서 사용하려면:
#   1. 아래 워크플로우를 해당 레포에 복사
#   2. jira-project-key를 해당 프로젝트에 맞게 변경
#   3. 필요한 secrets 설정
# ============================================================================

name: Sync GitHub Issue to Jira

on:
  issues:
    types: [opened, edited, closed, reopened, labeled]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'GitHub Issue Number to sync (leave empty to sync all open issues)'
        required: false
        type: string

jobs:
  # ===========================================
  # Reusable Workflow 호출 (자동 이벤트)
  # ===========================================
  sync:
    if: github.event_name != 'workflow_dispatch'
    permissions:
      issues: write
      contents: read
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-sync-jira.yml@main
    with:
      jira-project-key: IN
      issue-type: Task
      sync-comments: true
      sync-status: true
      enable-n8n-webhook: true
      transition-id-todo: "11"
      transition-id-done: "31"
    secrets:
      JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
      JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
      JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
      N8N_WEBHOOK_URL: ${{ secrets.N8N_WEBHOOK_URL }}

  # ===========================================
  # Manual Sync (workflow_dispatch)
  # ===========================================
  manual-sync:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to Jira
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      - name: Sync Single Issue
        if: github.event.inputs.issue_number != ''
        id: sync_single
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = parseInt('${{ github.event.inputs.issue_number }}');
            console.log(`Manually syncing issue #${issueNumber}`);

            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });

            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });

            const jiraKeyRegex = /\[([A-Z]+-\d+)\]/;
            const alreadySynced = comments.data.some(c => jiraKeyRegex.test(c.body));

            if (alreadySynced) {
              console.log('⚠️ Issue already synced to Jira');
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: '⚠️ 이 이슈는 이미 Jira와 동기화되어 있습니다.'
              });
              return;
            }

            core.setOutput('should_create', 'true');
            core.setOutput('issue_data', JSON.stringify(issue.data));

      - name: Create Jira Issue (Manual)
        if: github.event.inputs.issue_number != '' && steps.sync_single.outputs.should_create == 'true'
        id: create_manual
        uses: atlassian/gajira-create@v3
        with:
          project: IN
          issuetype: Task
          summary: "[GH-${{ github.event.inputs.issue_number }}] ${{ fromJSON(steps.sync_single.outputs.issue_data).title }}"
          description: |
            *Synced from GitHub Issue:* ${{ fromJSON(steps.sync_single.outputs.issue_data).html_url }}

            h3. Description
            ${{ fromJSON(steps.sync_single.outputs.issue_data).body || 'No description provided' }}

            ---
            *Created by:* ${{ fromJSON(steps.sync_single.outputs.issue_data).user.login }}
            *GitHub Issue Number:* #${{ github.event.inputs.issue_number }}

      - name: Add Jira Link (Manual)
        if: github.event.inputs.issue_number != '' && steps.create_manual.outputs.issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const jiraKey = '${{ steps.create_manual.outputs.issue }}';
            const jiraUrl = '${{ secrets.JIRA_BASE_URL }}';
            const issueNumber = parseInt('${{ github.event.inputs.issue_number }}');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `✅ Jira 이슈가 생성되었습니다: [${jiraKey}](${jiraUrl}/browse/${jiraKey})`
            });

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['jira-synced']
            });

      - name: Sync All Open Issues
        if: github.event.inputs.issue_number == ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('Syncing all open issues without Jira tickets...');

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            console.log(`Found ${issues.data.length} open issues to check`);

            for (const issue of issues.data) {
              if (issue.pull_request) continue;

              const hasJiraLabel = issue.labels.some(l => l.name === 'jira-synced');
              if (hasJiraLabel) {
                console.log(`Issue #${issue.number} already synced, skipping`);
                continue;
              }

              console.log(`Issue #${issue.number} needs sync: ${issue.title}`);
            }
