# ============================================================================
# Reusable Workflow: Docker Build & ECR Push
#
# Java/Gradle Í∏∞Î∞ò ÌîÑÎ°úÏ†ùÌä∏Ïùò Docker Ïù¥ÎØ∏ÏßÄ ÎπåÎìú Î∞è ECR Ìë∏ÏãúÎ•º ÏúÑÌïú Í≥µÌÜµ ÏõåÌÅ¨ÌîåÎ°úÏö∞
#
# ÏÇ¨Ïö©Î≤ï:
#   jobs:
#     build:
#       uses: ryu-qqq/Infrastructure/.github/workflows/reusable-build-docker.yml@main
#       with:
#         ecr-repository: my-project-web-api-prod
#         component: web-api
#         dockerfile: bootstrap/bootstrap-web-api/Dockerfile
#         gradle-task: ":bootstrap:bootstrap-web-api:bootJar"
#       secrets:
#         AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}
# ============================================================================

name: Reusable Docker Build & ECR Push

on:
  workflow_call:
    inputs:
      # ECR ÏÑ§Ï†ï
      ecr-repository:
        description: "ECR Î†àÌè¨ÏßÄÌÜ†Î¶¨ Ïù¥Î¶Ñ (Ïòà: crawlinghub-web-api-prod)"
        required: true
        type: string

      # Ïª¥Ìè¨ÎÑåÌä∏ Ï†ïÎ≥¥
      component:
        description: "Ïª¥Ìè¨ÎÑåÌä∏Î™Ö - Ïù¥ÎØ∏ÏßÄ ÌÉúÍ∑∏Ïóê ÏÇ¨Ïö© (Ïòà: web-api, scheduler)"
        required: true
        type: string

      # ÎπåÎìú ÏÑ§Ï†ï
      dockerfile:
        description: "Dockerfile Í≤ΩÎ°ú"
        required: true
        type: string

      build-context:
        description: "Docker build context Í≤ΩÎ°ú"
        type: string
        default: "."

      gradle-task:
        description: "Gradle ÎπåÎìú ÌÉúÏä§ÌÅ¨ (Ïòà: :bootstrap:bootstrap-web-api:bootJar)"
        required: true
        type: string

      # ÏòµÏÖò ÏÑ§Ï†ï
      java-version:
        description: "Java Î≤ÑÏ†Ñ"
        type: string
        default: "21"

      aws-region:
        description: "AWS Î¶¨Ï†Ñ"
        type: string
        default: "ap-northeast-2"

      timeout-minutes:
        description: "ÎπåÎìú ÌÉÄÏûÑÏïÑÏõÉ (Î∂Ñ)"
        type: number
        default: 30

      run-tests:
        description: "ÌÖåÏä§Ìä∏ Ïã§Ìñâ Ïó¨Î∂Ä"
        type: boolean
        default: false

      # Ï∂îÍ∞Ä Docker ÎπåÎìú Ïù∏Ïûê
      build-args:
        description: "Ï∂îÍ∞Ä Docker build arguments (KEY=VALUE ÌòïÏãù, Ï§ÑÎ∞îÍøàÏúºÎ°ú Íµ¨Î∂Ñ)"
        type: string
        default: ""

    outputs:
      image-uri:
        description: "Ìë∏ÏãúÎêú Ïù¥ÎØ∏ÏßÄ Ï†ÑÏ≤¥ URI"
        value: ${{ jobs.build.outputs.image-uri }}
      image-tag:
        description: "Ïù¥ÎØ∏ÏßÄ ÌÉúÍ∑∏"
        value: ${{ jobs.build.outputs.image-tag }}
      ecr-repository:
        description: "ECR Î†àÌè¨ÏßÄÌÜ†Î¶¨ Ïù¥Î¶Ñ"
        value: ${{ jobs.build.outputs.ecr-repository }}

    secrets:
      AWS_ROLE_ARN:
        description: "AWS IAM Role ARN for GitHub Actions"
        required: true

jobs:
  build:
    name: Build & Push ${{ inputs.component }}
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.timeout-minutes }}

    outputs:
      image-uri: ${{ steps.build-push.outputs.image-uri }}
      image-tag: ${{ steps.generate-tag.outputs.tag }}
      ecr-repository: ${{ inputs.ecr-repository }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ inputs.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java-version }}
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run tests
        if: inputs.run-tests
        run: |
          echo "üß™ Running tests..."
          ./gradlew test -x jacocoTestCoverageVerification --no-daemon --stacktrace
          echo "‚úÖ Tests completed"

      - name: Build JAR
        run: |
          echo "üî® Building ${{ inputs.component }} JAR..."
          ./gradlew ${{ inputs.gradle-task }} -x test --no-daemon --stacktrace
          echo "‚úÖ JAR build completed"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ inputs.aws-region }}
          role-duration-seconds: 3600
          role-session-name: GitHubActions-${{ inputs.component }}-Build

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Generate image tag
        id: generate-tag
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          # ÌÉúÍ∑∏ Ìè¨Îß∑: {component}-{run_number}-{short_sha}
          TAG="${{ inputs.component }}-${{ github.run_number }}-${SHORT_SHA}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "üì¶ Image tag: ${TAG}"

      - name: Build and Push Docker image
        id: build-push
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ inputs.ecr-repository }}
          IMAGE_TAG: ${{ steps.generate-tag.outputs.tag }}
        run: |
          IMAGE_URI="${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"

          echo "üê≥ Building Docker image for ${{ inputs.component }}..."
          echo "   Registry: ${ECR_REGISTRY}"
          echo "   Repository: ${ECR_REPOSITORY}"
          echo "   Tag: ${IMAGE_TAG}"

          # Build arguments Ï≤òÎ¶¨
          BUILD_ARGS=""
          if [ -n "${{ inputs.build-args }}" ]; then
            while IFS= read -r arg; do
              if [ -n "$arg" ]; then
                BUILD_ARGS="${BUILD_ARGS} --build-arg ${arg}"
              fi
            done <<< "${{ inputs.build-args }}"
          fi

          docker build \
            -f ${{ inputs.dockerfile }} \
            -t "${IMAGE_URI}" \
            ${BUILD_ARGS} \
            ${{ inputs.build-context }}

          echo "üì§ Pushing to ECR..."
          docker push "${IMAGE_URI}"

          # latest ÌÉúÍ∑∏ÎèÑ Ìë∏Ïãú
          docker tag "${IMAGE_URI}" "${ECR_REGISTRY}/${ECR_REPOSITORY}:latest"
          docker push "${ECR_REGISTRY}/${ECR_REPOSITORY}:latest"

          echo "image-uri=${IMAGE_URI}" >> $GITHUB_OUTPUT
          echo "‚úÖ Image pushed: ${IMAGE_URI}"

      - name: Image vulnerability scan
        continue-on-error: true
        run: |
          echo "üîç Checking ECR scan results..."
          # ECR Ïä§Ï∫îÏùÄ ÎπÑÎèôÍ∏∞Î°ú Ïã§ÌñâÎêòÎØÄÎ°ú Í≤∞Í≥º ÌôïÏù∏Îßå
          aws ecr describe-image-scan-findings \
            --repository-name "${{ inputs.ecr-repository }}" \
            --image-id imageTag="${{ steps.generate-tag.outputs.tag }}" \
            --region "${{ inputs.aws-region }}" 2>/dev/null || echo "‚ö†Ô∏è Scan not yet complete or not enabled"

      - name: Output summary
        run: |
          echo "## üê≥ Docker Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Component** | ${{ inputs.component }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **ECR Repository** | ${{ inputs.ecr-repository }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Image Tag** | ${{ steps.generate-tag.outputs.tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Image URI** | \`${{ steps.build-push.outputs.image-uri }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Java Version** | ${{ inputs.java-version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Gradle Task** | ${{ inputs.gradle-task }} |" >> $GITHUB_STEP_SUMMARY
