# ============================================================================
# Reusable Workflow: ECS Deploy
#
# ECS Fargate ì„œë¹„ìŠ¤ ë°°í¬ë¥¼ ìœ„í•œ ê³µí†µ ì›Œí¬í”Œë¡œìš°
# Task Definition ì—…ë°ì´íŠ¸ â†’ ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ â†’ ì•ˆì •í™” ëŒ€ê¸°
#
# ì‚¬ìš©ë²•:
#   jobs:
#     deploy:
#       uses: ryu-qqq/Infrastructure/.github/workflows/reusable-deploy-ecs.yml@main
#       with:
#         ecs-cluster: my-cluster-prod
#         ecs-service: my-service-prod
#         image-uri: 123456789.dkr.ecr.ap-northeast-2.amazonaws.com/my-repo:tag
#       secrets:
#         AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}
# ============================================================================

name: Reusable ECS Deploy

on:
  workflow_call:
    inputs:
      # ECS ì„¤ì •
      ecs-cluster:
        description: "ECS í´ëŸ¬ìŠ¤í„° ì´ë¦„"
        required: true
        type: string

      ecs-service:
        description: "ECS ì„œë¹„ìŠ¤ ì´ë¦„"
        required: true
        type: string

      # ì´ë¯¸ì§€ ì •ë³´
      image-uri:
        description: "ë°°í¬í•  Docker ì´ë¯¸ì§€ URI"
        required: true
        type: string

      # ì»¨í…Œì´ë„ˆ ì„¤ì • (ë©€í‹° ì»¨í…Œì´ë„ˆ ì§€ì›)
      container-name:
        description: "ì—…ë°ì´íŠ¸í•  ì»¨í…Œì´ë„ˆ ì´ë¦„ (ê¸°ë³¸: ì²« ë²ˆì§¸ ì»¨í…Œì´ë„ˆ)"
        type: string
        default: ""

      # AWS ì„¤ì •
      aws-region:
        description: "AWS ë¦¬ì „"
        type: string
        default: "ap-northeast-2"

      # ë°°í¬ ì˜µì…˜
      timeout-minutes:
        description: "ë°°í¬ íƒ€ìž„ì•„ì›ƒ (ë¶„)"
        type: number
        default: 20

      wait-for-stability:
        description: "ì„œë¹„ìŠ¤ ì•ˆì •í™” ëŒ€ê¸° ì—¬ë¶€"
        type: boolean
        default: true

      force-new-deployment:
        description: "ê°•ì œ ìƒˆ ë°°í¬ ì—¬ë¶€"
        type: boolean
        default: true

    outputs:
      task-definition-arn:
        description: "ìƒˆë¡œ ë“±ë¡ëœ Task Definition ARN"
        value: ${{ jobs.deploy.outputs.task-definition-arn }}
      deployment-id:
        description: "ECS ë°°í¬ ID"
        value: ${{ jobs.deploy.outputs.deployment-id }}

    secrets:
      AWS_ROLE_ARN:
        description: "AWS IAM Role ARN for GitHub Actions"
        required: true

jobs:
  deploy:
    name: Deploy to ${{ inputs.ecs-service }}
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.timeout-minutes }}

    outputs:
      task-definition-arn: ${{ steps.register-task-def.outputs.task-definition-arn }}
      deployment-id: ${{ steps.update-service.outputs.deployment-id }}

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ inputs.aws-region }}
          role-duration-seconds: 3600
          role-session-name: GitHubActions-ECS-Deploy

      - name: Get current task definition
        id: get-task-def
        run: |
          echo "ðŸ“‹ Fetching current task definition for ${{ inputs.ecs-service }}..."

          # í˜„ìž¬ ì„œë¹„ìŠ¤ì˜ Task Definition ARN ê°€ì ¸ì˜¤ê¸°
          TASK_DEF_ARN=$(aws ecs describe-services \
            --cluster "${{ inputs.ecs-cluster }}" \
            --services "${{ inputs.ecs-service }}" \
            --query 'services[0].taskDefinition' \
            --output text)

          if [ "$TASK_DEF_ARN" == "None" ] || [ -z "$TASK_DEF_ARN" ]; then
            echo "âŒ Service not found: ${{ inputs.ecs-service }}"
            exit 1
          fi

          echo "task-definition-arn=${TASK_DEF_ARN}" >> $GITHUB_OUTPUT
          echo "âœ… Current Task Definition: ${TASK_DEF_ARN}"

          # Task Definition ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
          aws ecs describe-task-definition \
            --task-definition "${TASK_DEF_ARN}" \
            --query 'taskDefinition' > task-definition.json

          echo "ðŸ“„ Task Definition retrieved"

      - name: Update task definition with new image
        id: update-task-def
        run: |
          echo "ðŸ”„ Updating task definition with new image..."

          # ì»¨í…Œì´ë„ˆ ì´ë¦„ ê²°ì •
          if [ -n "${{ inputs.container-name }}" ]; then
            CONTAINER_NAME="${{ inputs.container-name }}"
          else
            # ì²« ë²ˆì§¸ ì»¨í…Œì´ë„ˆ ì´ë¦„ ì‚¬ìš©
            CONTAINER_NAME=$(jq -r '.containerDefinitions[0].name' task-definition.json)
          fi

          echo "ðŸ“¦ Target container: ${CONTAINER_NAME}"
          echo "ðŸ³ New image: ${{ inputs.image-uri }}"

          # ì´ë¯¸ì§€ URI ì—…ë°ì´íŠ¸ (íŠ¹ì • ì»¨í…Œì´ë„ˆë§Œ)
          jq --arg IMAGE "${{ inputs.image-uri }}" \
             --arg CONTAINER "$CONTAINER_NAME" \
             '(.containerDefinitions[] | select(.name == $CONTAINER) | .image) = $IMAGE' \
             task-definition.json > updated-task-definition.json

          # ë¶ˆí•„ìš”í•œ í•„ë“œ ì œê±° (ìƒˆ Task Definition ë“±ë¡ ì‹œ í•„ìš”)
          jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)' \
             updated-task-definition.json > new-task-definition.json

          echo "âœ… Task definition updated"

      - name: Register new task definition
        id: register-task-def
        run: |
          echo "ðŸ“ Registering new task definition..."

          NEW_TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://new-task-definition.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)

          echo "task-definition-arn=${NEW_TASK_DEF_ARN}" >> $GITHUB_OUTPUT
          echo "âœ… New Task Definition registered: ${NEW_TASK_DEF_ARN}"

      - name: Update ECS service
        id: update-service
        run: |
          echo "ðŸš€ Updating ECS service ${{ inputs.ecs-service }}..."

          FORCE_FLAG=""
          if [ "${{ inputs.force-new-deployment }}" == "true" ]; then
            FORCE_FLAG="--force-new-deployment"
          fi

          # ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸
          DEPLOYMENT_ID=$(aws ecs update-service \
            --cluster "${{ inputs.ecs-cluster }}" \
            --service "${{ inputs.ecs-service }}" \
            --task-definition "${{ steps.register-task-def.outputs.task-definition-arn }}" \
            ${FORCE_FLAG} \
            --query 'service.deployments[0].id' \
            --output text \
            --no-cli-pager)

          echo "deployment-id=${DEPLOYMENT_ID}" >> $GITHUB_OUTPUT
          echo "âœ… ECS service update initiated (Deployment: ${DEPLOYMENT_ID})"

      - name: Wait for service stability
        if: inputs.wait-for-stability
        run: |
          echo "â³ Waiting for ${{ inputs.ecs-service }} to become stable..."
          echo "   This may take a few minutes..."

          aws ecs wait services-stable \
            --cluster "${{ inputs.ecs-cluster }}" \
            --services "${{ inputs.ecs-service }}"

          echo "âœ… Service is now stable"

      - name: Verify deployment
        run: |
          echo "ðŸ” Verifying deployment..."

          SERVICE_STATUS=$(aws ecs describe-services \
            --cluster "${{ inputs.ecs-cluster }}" \
            --services "${{ inputs.ecs-service }}" \
            --query 'services[0].{Running:runningCount,Desired:desiredCount,Status:status,TaskDef:taskDefinition}' \
            --output json)

          echo "ðŸ“Š Service Status:"
          echo "$SERVICE_STATUS" | jq .

          RUNNING=$(echo "$SERVICE_STATUS" | jq -r '.Running')
          DESIRED=$(echo "$SERVICE_STATUS" | jq -r '.Desired')

          if [ "$RUNNING" -eq "$DESIRED" ] && [ "$RUNNING" -gt 0 ]; then
            echo "âœ… Deployment successful: ${RUNNING}/${DESIRED} tasks running"
          else
            echo "âš ï¸ Warning: ${RUNNING}/${DESIRED} tasks running"
          fi

      - name: Output summary
        run: |
          echo "## ðŸš€ ECS Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Cluster** | ${{ inputs.ecs-cluster }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Service** | ${{ inputs.ecs-service }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Image URI** | \`${{ inputs.image-uri }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Task Definition** | \`${{ steps.register-task-def.outputs.task-definition-arn }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Deployment ID** | ${{ steps.update-service.outputs.deployment-id }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Deployment Steps Completed" >> $GITHUB_STEP_SUMMARY
          echo "1. Retrieved current task definition" >> $GITHUB_STEP_SUMMARY
          echo "2. Updated image URI in task definition" >> $GITHUB_STEP_SUMMARY
          echo "3. Registered new task definition" >> $GITHUB_STEP_SUMMARY
          echo "4. Updated ECS service" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.wait-for-stability }}" == "true" ]; then
            echo "5. Waited for service stability" >> $GITHUB_STEP_SUMMARY
          fi
