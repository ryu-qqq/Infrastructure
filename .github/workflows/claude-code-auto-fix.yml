name: Claude Code Auto Fix

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened]

jobs:
  claude-fix:
    # @claude ë©˜ì…˜ì´ ìˆëŠ” ì½”ë©˜íŠ¸ ë˜ëŠ” Issue ë³¸ë¬¸ì—ì„œ íŠ¸ë¦¬ê±°
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'issues' && contains(github.event.issue.body, '@claude'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Run Claude Code Action
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          trigger_phrase: "@claude"
          # Claudeê°€ ì½”ë“œ ìˆ˜ì • ë° PR ìƒì„± ê°€ëŠ¥í•˜ë„ë¡ ë„êµ¬ í—ˆìš©
          claude_args: |
            --model claude-sonnet-4-5
            --allowedTools "Read,Write,Edit,Glob,Grep,Bash(git:*),Bash(gh pr create:*),Bash(gh pr comment:*)"

      - name: Check for changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes"
          fi

      - name: Create PR if changes exist
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number || github.event.comment.issue_url && github.event.comment.issue_url | split('/') | last }}"
          BRANCH_NAME="fix/claude-issue-${ISSUE_NUMBER}-$(date +%s)"

          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git checkout -b "$BRANCH_NAME"
          git add -A
          git commit -m "fix: auto-fix from Claude Code

          Resolves #${ISSUE_NUMBER}

          ğŸ¤– Generated with Claude Code Action"

          git push origin "$BRANCH_NAME"

          gh pr create \
            --title "ğŸ¤– Claude Auto-fix for #${ISSUE_NUMBER}" \
            --body "## ğŸ¤– Claude Code ìë™ ìˆ˜ì •

          @claude ë©˜ì…˜ì— ì˜í•´ ìë™ìœ¼ë¡œ ìƒì„±ëœ PRì…ë‹ˆë‹¤.

          ### ê´€ë ¨ ì´ìŠˆ
          Closes #${ISSUE_NUMBER}

          ### âš ï¸ ì£¼ì˜
          **ë°˜ë“œì‹œ ì½”ë“œ ë¦¬ë·° í›„ ë¨¸ì§€í•´ì£¼ì„¸ìš”!**

          ---
          _ğŸ¤– Generated with [Claude Code Action](https://github.com/anthropics/claude-code-action)_" \
            --label "auto-fix,claude-code"
