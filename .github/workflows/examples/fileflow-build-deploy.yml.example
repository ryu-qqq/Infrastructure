# ============================================================================
# FileFlow Build & Deploy Example (with Change Detection)
#
# Ïù¥ ÌååÏùºÏùÄ FileFlow ÌîÑÎ°úÏ†ùÌä∏Ïùò .github/workflows/build-and-deploy.yml ÏòàÏãúÏûÖÎãàÎã§.
# Î≥ÄÍ≤Ω Í∞êÏßÄ Í∏∞Îä•ÏùÑ Ïú†ÏßÄÌïòÎ©¥ÏÑú reusable workflow ÏÇ¨Ïö©
#
# Í∏∞Ï°¥ 600Ï§Ñ ‚Üí ÏïΩ 200Ï§ÑÎ°ú Îã®ÏàúÌôî
# ============================================================================

name: Build and Deploy to ECS (Smart)

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'terraform/**'
      - '.github/workflows/terraform-*.yml'
      - '**.md'
      - 'docs/**'

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: ap-northeast-2
  ECS_CLUSTER: fileflow-prod  # ÎÑ§Ïù¥Î∞ç Ïª®Î≤§ÏÖò: {project}-{env}

jobs:
  # ============================================================================
  # Step 1: Î≥ÄÍ≤Ω Í∞êÏßÄ (FileFlow Í≥†Ïú† Í∏∞Îä• Ïú†ÏßÄ)
  # ============================================================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      web-api: ${{ steps.filter.outputs.web-api }}
      download-worker: ${{ steps.filter.outputs.download-worker }}
      scheduler: ${{ steps.filter.outputs.scheduler }}
      any-changed: ${{ steps.filter.outputs.any-changed }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed paths
        id: filter
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          echo "üìÅ Changed files:"
          echo "$CHANGED_FILES"

          # Í∞ïÏ†ú ÎπåÎìú ÌîåÎûòÍ∑∏ Ï≤¥ÌÅ¨
          FORCE_BUILD_ALL=false
          COMMIT_MSG=$(git log -1 --format=%s HEAD)
          if echo "$COMMIT_MSG" | grep -qE '\[build-all\]|\[rebuild\]'; then
            FORCE_BUILD_ALL=true
            echo "üîÑ Force build all flag detected"
          fi

          # Í≥µÌÜµ Î†àÏù¥Ïñ¥ Î≥ÄÍ≤Ω Ï≤¥ÌÅ¨
          COMMON_CHANGED=false
          if echo "$CHANGED_FILES" | grep -qE '^(domain/|application/)'; then
            COMMON_CHANGED=true
            echo "üîÑ Common layer changed"
          fi

          # BootstrapÎ≥Ñ Î≥ÄÍ≤Ω Ïó¨Î∂Ä
          WEB_API=false
          DOWNLOAD_WORKER=false
          SCHEDULER=false

          if [ "$FORCE_BUILD_ALL" = "true" ] || [ "$COMMON_CHANGED" = "true" ]; then
            WEB_API=true
            DOWNLOAD_WORKER=true
            SCHEDULER=true
          else
            # Í∞úÎ≥Ñ Î≥ÄÍ≤Ω Í∞êÏßÄ
            if echo "$CHANGED_FILES" | grep -qE '^(adapter-in/rest-api/|bootstrap/bootstrap-web-api/)'; then
              WEB_API=true
            fi
            if echo "$CHANGED_FILES" | grep -qE '^(adapter-in/sqs-listener/|adapter-out/http-client/|bootstrap/bootstrap-download-worker/)'; then
              DOWNLOAD_WORKER=true
            fi
            if echo "$CHANGED_FILES" | grep -qE '^(bootstrap/bootstrap-scheduler/)'; then
              SCHEDULER=true
            fi
            # Í≥µÌÜµ Adapter Î≥ÄÍ≤Ω
            if echo "$CHANGED_FILES" | grep -qE '^(adapter-out/(persistence-mysql|persistence-redis|aws-s3)/)'; then
              WEB_API=true
              DOWNLOAD_WORKER=true
              SCHEDULER=true
            fi
          fi

          echo "web-api=${WEB_API}" >> $GITHUB_OUTPUT
          echo "download-worker=${DOWNLOAD_WORKER}" >> $GITHUB_OUTPUT
          echo "scheduler=${SCHEDULER}" >> $GITHUB_OUTPUT

          ANY_CHANGED=false
          if [ "$WEB_API" = "true" ] || [ "$DOWNLOAD_WORKER" = "true" ] || [ "$SCHEDULER" = "true" ]; then
            ANY_CHANGED=true
          fi
          echo "any-changed=${ANY_CHANGED}" >> $GITHUB_OUTPUT

          echo "üîç Results: web-api=${WEB_API}, download-worker=${DOWNLOAD_WORKER}, scheduler=${SCHEDULER}"

  # ============================================================================
  # Step 2: ÎπåÎìú (Ï°∞Í±¥Î∂Ä Ïã§Ìñâ)
  # ============================================================================
  build-web-api:
    name: Build web-api
    needs: detect-changes
    if: needs.detect-changes.outputs.web-api == 'true'
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-build-docker.yml@main
    with:
      ecr-repository: fileflow-web-api-prod  # Î∂ÑÎ¶¨Îêú ECR
      component: web-api
      dockerfile: bootstrap/bootstrap-web-api/Dockerfile
      gradle-task: ":bootstrap:bootstrap-web-api:bootJar"
      timeout-minutes: 30
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  build-download-worker:
    name: Build download-worker
    needs: detect-changes
    if: needs.detect-changes.outputs.download-worker == 'true'
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-build-docker.yml@main
    with:
      ecr-repository: fileflow-download-worker-prod
      component: download-worker
      dockerfile: bootstrap/bootstrap-download-worker/Dockerfile
      gradle-task: ":bootstrap:bootstrap-download-worker:bootJar"
      timeout-minutes: 30
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  build-scheduler:
    name: Build scheduler
    needs: detect-changes
    if: needs.detect-changes.outputs.scheduler == 'true'
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-build-docker.yml@main
    with:
      ecr-repository: fileflow-scheduler-prod
      component: scheduler
      dockerfile: bootstrap/bootstrap-scheduler/Dockerfile
      gradle-task: ":bootstrap:bootstrap-scheduler:bootJar"
      timeout-minutes: 25
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  # ============================================================================
  # Step 3: Î∞∞Ìè¨ (Ï°∞Í±¥Î∂Ä Ïã§Ìñâ)
  # ============================================================================
  deploy-web-api:
    name: Deploy web-api
    needs: [detect-changes, build-web-api]
    if: needs.detect-changes.outputs.web-api == 'true'
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-deploy-ecs.yml@main
    with:
      ecs-cluster: fileflow-prod
      ecs-service: fileflow-web-api-prod
      image-uri: ${{ needs.build-web-api.outputs.image-uri }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  deploy-download-worker:
    name: Deploy download-worker
    needs: [detect-changes, build-download-worker]
    if: needs.detect-changes.outputs.download-worker == 'true'
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-deploy-ecs.yml@main
    with:
      ecs-cluster: fileflow-prod
      ecs-service: fileflow-download-worker-prod
      image-uri: ${{ needs.build-download-worker.outputs.image-uri }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  deploy-scheduler:
    name: Deploy scheduler
    needs: [detect-changes, build-scheduler]
    if: needs.detect-changes.outputs.scheduler == 'true'
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-deploy-ecs.yml@main
    with:
      ecs-cluster: fileflow-prod
      ecs-service: fileflow-scheduler-prod
      image-uri: ${{ needs.build-scheduler.outputs.image-uri }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  # ============================================================================
  # Step 4: Î∞∞Ìè¨ ÏôÑÎ£å ÏïåÎ¶º (Slack + GitHub Summary)
  # ============================================================================
  notify:
    name: Deployment Notification
    needs: [detect-changes, build-web-api, build-download-worker, build-scheduler, deploy-web-api, deploy-download-worker, deploy-scheduler]
    if: always() && needs.detect-changes.outputs.any-changed == 'true'
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-notify-slack.yml@main
    with:
      project-name: FileFlow
      environment: prod
      status: ${{ (needs.deploy-web-api.result == 'success' || needs.deploy-web-api.result == 'skipped') && (needs.deploy-download-worker.result == 'success' || needs.deploy-download-worker.result == 'skipped') && (needs.deploy-scheduler.result == 'success' || needs.deploy-scheduler.result == 'skipped') && 'success' || 'failure' }}
      components: |
        [
          {"name": "web-api", "status": "${{ needs.detect-changes.outputs.web-api == 'true' && needs.deploy-web-api.result || 'skipped' }}", "image": "${{ needs.build-web-api.outputs.image-tag || 'N/A' }}"},
          {"name": "download-worker", "status": "${{ needs.detect-changes.outputs.download-worker == 'true' && needs.deploy-download-worker.result || 'skipped' }}", "image": "${{ needs.build-download-worker.outputs.image-tag || 'N/A' }}"},
          {"name": "scheduler", "status": "${{ needs.detect-changes.outputs.scheduler == 'true' && needs.deploy-scheduler.result || 'skipped' }}", "image": "${{ needs.build-scheduler.outputs.image-tag || 'N/A' }}"}
        ]
      custom-message: "üí° Use `[build-all]` in commit message to force build all components"
      mention-on-failure: "@here"
    secrets:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
