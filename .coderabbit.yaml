# yaml-language-server: $schema=https://coderabbit.ai/integrations/schema.v2.json

# CodeRabbit Configuration for Infrastructure (Terraform) Project
# Based on: governance/policies/*.rego, .claude/INFRASTRUCTURE_RULES.md

language: ko-KR
tone_instructions: "Be ASSERTIVE on Zero-Tolerance rules (Required Tags, KMS Encryption, Naming Conventions, Hardcoded Secrets, Security Groups). Be CHILL on formatting/comments. Focus on AWS security best practices and Terraform conventions."

early_access: true
enable_free_tier: false

reviews:
  profile: assertive
  high_level_summary: true
  high_level_summary_placeholder: |
    ## ğŸ“Š Infrastructure Change Summary

    This PR modifies...

    ### âœ… Governance Compliance
    - Required Tags: [Pass/Fail]
    - KMS Encryption: [Pass/Fail]
    - Naming Conventions: [Pass/Fail]
    - Security: [Pass/Fail]

  poem: false
  collapse_walkthrough: false

  auto_review:
    enabled: true
    auto_incremental_review: true
    ignore_title_keywords:
      - "WIP"
      - "DO NOT MERGE"
    # AI ìƒì„± Draft PRë„ ë¦¬ë·°
    drafts: true
    base_branches:
      - "main"
      - "develop"
    ignore_usernames:
      - "dependabot"
      - "renovate"

  # ë¹Œë“œ ì‚°ì¶œë¬¼ ë° ë¶ˆí•„ìš”í•œ íŒŒì¼ ì œì™¸
  path_filters:
    - "!**/.terraform/**"
    - "!**/*.tfstate"
    - "!**/*.tfstate.backup"
    - "!**/terraform.tfvars"
    - "!**/.terraformrc"
    - "!**/crash.log"
    - "!**/*.tfplan"
    - "!**/node_modules/**"

  # Terraform íŒŒì¼ë³„ ë¦¬ë·° ê·œì¹™
  path_instructions:
    # Terraform Modules (ì¬ì‚¬ìš© ëª¨ë“ˆ - ê°€ì¥ ì—„ê²©)
    - path: "terraform/modules/**/*.tf"
      instructions: |
        ğŸš¨ **CRITICAL ZERO-TOLERANCE RULES** (Must enforce):

        1. **Required Tags Pattern**
           - âŒ ê°œë³„ íƒœê·¸ í•˜ë“œì½”ë”© ê¸ˆì§€
           - âœ… `merge(local.required_tags, {...})` ë˜ëŠ” `merge(var.common_tags, {...})` íŒ¨í„´ í•„ìˆ˜
           - **í•„ìˆ˜ íƒœê·¸**: Environment, Service, Team, Owner, CostCenter, ManagedBy, Project

        2. **KMS Encryption (ê³ ê° ê´€ë¦¬í˜• KMS í•„ìˆ˜)**
           - âŒ `encryption_type = "AES256"` ê¸ˆì§€
           - âŒ ì•”í˜¸í™” ì„¤ì • ëˆ„ë½ ê¸ˆì§€
           - âœ… `encryption_type = "KMS"` + `kms_key = aws_kms_key.*.arn`
           - **ì ìš© ëŒ€ìƒ**: ECR, S3, RDS, EBS, CloudWatch Logs

        3. **Naming Conventions**
           - âœ… ë¦¬ì†ŒìŠ¤ ì´ë¦„: kebab-case (`ecr-atlantis`, `prod-server-vpc`)
           - âœ… ë³€ìˆ˜/ë¡œì»¬: snake_case (`aws_region`, `required_tags`)
           - âŒ camelCase ê¸ˆì§€ (`ecrAtlantis`)
           - âŒ UPPER_SNAKE_CASE ê¸ˆì§€ (`ECR_ATLANTIS`)

        4. **No Hardcoded Secrets**
           - âŒ `password = "..."` í•˜ë“œì½”ë”© ê¸ˆì§€
           - âŒ `secret = "..."`, `api_key = "..."` ê¸ˆì§€
           - âœ… `var.db_password` ë˜ëŠ” `data.aws_secretsmanager_secret_version.*.secret_string`

        5. **KMS Key Rotation**
           - âœ… `enable_key_rotation = true` í•„ìˆ˜
           - âœ… `deletion_window_in_days >= 7` ê¶Œì¥

        **Module Best Practices**:
        - variables.tfì— ì ì ˆí•œ descriptionê³¼ validation í¬í•¨
        - outputs.tfì— í•„ìš”í•œ ê°’ë“¤ ë…¸ì¶œ
        - README.mdì— ì‚¬ìš© ì˜ˆì‹œ í¬í•¨

    # Environment Configurations (í™˜ê²½ë³„ ì„¤ì •)
    - path: "terraform/environments/**/*.tf"
      instructions: |
        ğŸš¨ **CRITICAL RULES**:

        1. **Required Tags Pattern**
           - âœ… `merge(local.required_tags, {...})` íŒ¨í„´ ì‚¬ìš© í•„ìˆ˜
           - âŒ íƒœê·¸ ê°œë³„ ì •ì˜ ê¸ˆì§€

        2. **KMS Encryption**
           - âœ… ëª¨ë“  ì•”í˜¸í™” ê°€ëŠ¥ ë¦¬ì†ŒìŠ¤ì— KMS í‚¤ ì‚¬ìš©
           - âŒ AWS ê´€ë¦¬í˜• í‚¤(AES256) ì‚¬ìš© ê¸ˆì§€

        3. **Environment Consistency**
           - âœ… í™˜ê²½ ë³€ìˆ˜ê°€ ì˜¬ë°”ë¥¸ ê°’ì¸ì§€ í™•ì¸ (dev/staging/prod)
           - âœ… í™˜ê²½ë³„ ë¦¬ì†ŒìŠ¤ ì´ë¦„ì— í™˜ê²½ prefix í¬í•¨ ê¶Œì¥

        4. **Secrets Management**
           - âŒ terraform.tfvarsì— ë¯¼ê° ì •ë³´ ì ˆëŒ€ ê¸ˆì§€
           - âœ… AWS Secrets Manager ë˜ëŠ” í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš©

        **Security Checks**:
        - Production í™˜ê²½ì—ì„œ ë” ì—„ê²©í•œ ë³´ì•ˆ ì„¤ì • í™•ì¸
        - Multi-AZ, ë°±ì—… ì„¤ì • ë“± ê³ ê°€ìš©ì„± í™•ì¸

    # Security Group Resources
    - path: "**/*security*.tf"
      instructions: |
        ğŸš¨ **SECURITY GROUP CRITICAL RULES**:

        1. **Overly Permissive Rules ê¸ˆì§€**
           - âŒ `cidr_blocks = ["0.0.0.0/0"]` + ëª¨ë“  í¬íŠ¸(0-0) ê¸ˆì§€
           - âŒ `protocol = "-1"` + `0.0.0.0/0` ê¸ˆì§€

        2. **Dangerous Ports ì¸í„°ë„· ë…¸ì¶œ ê¸ˆì§€**
           - âŒ SSH(22), RDP(3389) ì¸í„°ë„· ë…¸ì¶œ
           - âŒ DB í¬íŠ¸(3306, 5432, 6379, 27017) ì¸í„°ë„· ë…¸ì¶œ
           - âŒ Elasticsearch(9200), Kibana(5601) ì¸í„°ë„· ë…¸ì¶œ
           - âœ… VPN, Bastion, ë˜ëŠ” íŠ¹ì • IP ëŒ€ì—­ìœ¼ë¡œ ì œí•œ

        3. **Description í•„ìˆ˜**
           - âœ… ëª¨ë“  Security Groupì— êµ¬ì²´ì ì¸ description í•„ìˆ˜
           - âŒ "Managed by Terraform" ê°™ì€ generic ì„¤ëª… ê¸ˆì§€

        4. **IPv6 ë³´ì•ˆ**
           - âŒ `::/0`ë¡œ ìœ„í—˜ í¬íŠ¸ ë…¸ì¶œ ê¸ˆì§€

        **Best Practices**:
        - ìµœì†Œ ê¶Œí•œ ì›ì¹™ ì ìš©
        - ì¸ë°”ìš´ë“œëŠ” í•„ìš”í•œ í¬íŠ¸ë§Œ í—ˆìš©
        - ì•„ì›ƒë°”ìš´ë“œë„ ê°€ëŠ¥í•˜ë©´ ì œí•œ

    # S3 Bucket Resources
    - path: "**/*s3*.tf"
      instructions: |
        ğŸš¨ **S3 SECURITY RULES**:

        1. **Public Access Block í•„ìˆ˜**
           - âœ… `aws_s3_bucket_public_access_block` ë¦¬ì†ŒìŠ¤ í•„ìˆ˜
           - âœ… `block_public_acls = true`
           - âœ… `block_public_policy = true`
           - âœ… `ignore_public_acls = true`
           - âœ… `restrict_public_buckets = true`

        2. **KMS Encryption í•„ìˆ˜**
           - âœ… `aws_s3_bucket_server_side_encryption_configuration` í•„ìˆ˜
           - âœ… `sse_algorithm = "aws:kms"` + KMS key ARN
           - âŒ `sse_algorithm = "AES256"` ê¸ˆì§€

        3. **Versioning ê¶Œì¥**
           - âœ… ì¤‘ìš” ë°ì´í„° ë²„í‚·ì€ versioning í™œì„±í™”

        4. **Naming**
           - âœ… ë²„í‚· ì´ë¦„: kebab-case ë˜ëŠ” ì (.) í—ˆìš©
           - âœ… ê¸€ë¡œë²Œ ìœ ë‹ˆí¬ ì´ë¦„ ê·œì¹™ ì¤€ìˆ˜

    # RDS Resources
    - path: "**/*rds*.tf"
      instructions: |
        ğŸš¨ **RDS CRITICAL RULES**:

        1. **Public Access ê¸ˆì§€**
           - âŒ `publicly_accessible = true` ì ˆëŒ€ ê¸ˆì§€
           - âœ… Private Subnetì—ë§Œ ë°°ì¹˜

        2. **Encryption í•„ìˆ˜**
           - âœ… `storage_encrypted = true`
           - âœ… `kms_key_id` ì„¤ì • (ê³ ê° ê´€ë¦¬í˜• KMS)

        3. **Password ë³´ì•ˆ**
           - âŒ í•˜ë“œì½”ë”©ëœ password ê¸ˆì§€
           - âœ… `random_password` ë˜ëŠ” Secrets Manager ì‚¬ìš©

        4. **Production ìš”êµ¬ì‚¬í•­**
           - âœ… `multi_az = true` (ê³ ê°€ìš©ì„±)
           - âœ… `backup_retention_period >= 7`
           - âœ… `deletion_protection = true` ê¶Œì¥

        **Best Practices**:
        - Performance Insights í™œì„±í™”
        - Enhanced Monitoring í™œì„±í™”
        - ì ì ˆí•œ íŒŒë¼ë¯¸í„° ê·¸ë£¹ ì„¤ì •

    # IAM Resources
    - path: "**/*iam*.tf"
      instructions: |
        ğŸš¨ **IAM SECURITY RULES**:

        1. **Least Privilege**
           - âŒ `"Action": "*"` ê¸ˆì§€
           - âŒ `"Resource": "*"` ìµœì†Œí™”
           - âœ… í•„ìš”í•œ ê¶Œí•œë§Œ ëª…ì‹œì ìœ¼ë¡œ ë¶€ì—¬

        2. **No Hardcoded Credentials**
           - âŒ access_key, secret_key í•˜ë“œì½”ë”© ê¸ˆì§€
           - âœ… IAM Role ê¸°ë°˜ ì¸ì¦ ì‚¬ìš©

        3. **Policy Description**
           - âœ… ëª¨ë“  Policyì— description í•„ìˆ˜
           - âœ… ê° Statementì— Sidë¡œ ëª©ì  ëª…ì‹œ

        **Best Practices**:
        - ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´ (RBAC)
        - ì¡°ê±´(Condition) í™œìš©í•˜ì—¬ ë²”ìœ„ ì œí•œ
        - ì •ê¸°ì ì¸ ê¶Œí•œ ê²€í† 

    # GitHub Actions Workflows
    - path: ".github/workflows/**/*.yml"
      instructions: |
        **CI/CD Workflow Rules**:

        1. **Secrets ê´€ë¦¬**
           - âœ… `${{ secrets.* }}` ì‚¬ìš©
           - âŒ í•˜ë“œì½”ë”©ëœ credentials ê¸ˆì§€

        2. **Terraform ì›Œí¬í”Œë¡œìš°**
           - âœ… Plan â†’ Review â†’ Apply ìˆœì„œ ì¤€ìˆ˜
           - âœ… `terraform fmt -check` í¬í•¨
           - âœ… `terraform validate` í¬í•¨
           - âœ… Security scan (tfsec, checkov) í¬í•¨

        3. **Branch Protection**
           - âœ… main ë¸Œëœì¹˜ ì§ì ‘ push ê¸ˆì§€
           - âœ… PR ìŠ¹ì¸ í•„ìˆ˜

  # ë„êµ¬ í™œì„±í™” (Infrastructure ì „ìš©)
  tools:
    # ë³´ì•ˆ ìŠ¤ìº”
    gitleaks:
      enabled: true

    # Terraform ì·¨ì•½ì 
    trivy:
      enabled: true

    # Dockerfile ê²€ì¦
    hadolint:
      enabled: true

    # YAML ê²€ì¦
    yamllint:
      enabled: true

chat:
  auto_reply: true
  art: false

knowledge_base:
  opt_out: false

  # í”„ë¡œì íŠ¸ ì»¨ë²¤ì…˜ íŒŒì¼ ìë™ í•™ìŠµ
  code_guidelines:
    enabled: true
    filePatterns:
      - "**/.claude/CLAUDE.md"
      - "**/.claude/INFRASTRUCTURE_RULES.md"
      - "**/governance/policies/**/*.rego"
      - "**/docs/**/*.md"

  learnings:
    scope: "organization"

  # ì™¸ë¶€ ì§€ì‹ í†µí•©
  web_search:
    enabled: true

code_generation:
  docstrings:
    language: ko-KR
  unit_tests:
    language: ko-KR
