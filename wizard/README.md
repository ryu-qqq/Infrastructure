# Infrastructure Wizard 🔧

Automated Terraform code generator for company infrastructure standards.

## 📋 Overview

The Infrastructure Wizard helps you generate production-ready Terraform code by:
1. Asking guided questions about your infrastructure needs
2. Generating Terraform code from templates
3. Updating `atlantis.yaml` automatically
4. Creating a Pull Request with all changes

**No Terraform knowledge required!**

## 🚀 Quick Start

```bash
# Run the wizard
./wizard/infra-wizard.sh

# Or with Python directly
python3 wizard/infra-wizard.py
```

## 📦 Prerequisites

- Python 3.9 or later
- Git installed and configured
- GitHub CLI (`gh`) for PR creation (optional)

## 🎯 Features

### ✅ Complete Automation Pipeline

1. **Interactive Configuration** - Guided questions with validation
2. **Code Generation** - Jinja2 templates with governance compliance
3. **Atlantis Registration** - Automatic atlantis.yaml updates
4. **Git Automation** - Branch creation, commits with conventional messages
5. **PR Creation** - GitHub PR with detailed descriptions via `gh` CLI

### Supported Infrastructure

- ✅ **ECS Service** (Fargate)
  - With or without ALB
  - Shared or dedicated RDS database
  - Shared or dedicated ElastiCache
  - Optional S3 storage
  - Auto-applied tags and KMS encryption

### More templates coming soon:
- 🚧 Lambda Function
- 🚧 RDS Database (standalone)
- 🚧 ElastiCache (standalone)
- 🚧 S3 Bucket with lifecycle policies
- 🚧 SQS + SNS messaging pattern

## 📖 Usage Guide

### Step 1: Run the Wizard

```bash
./wizard/infra-wizard.sh
```

### Step 2: Answer Questions

The wizard will ask about:
- **Service name** (kebab-case: api-server, worker, etc.)
- **Environment** (dev, staging, prod)
- **Resources** (CPU, Memory)
- **Optional components** (database, cache, load balancer)

### Step 3: Review Summary

The wizard shows what will be created:
```
📊 생성 요약
─────────────────────────────────────
서비스: api-server
환경: prod
CPU: 512 units
메모리: 1024 MiB

선택된 컴포넌트:
├─ 데이터베이스: 기존 공유 RDS
├─ 캐시: 전용 Redis
└─ 로드밸런서: ALB

생성될 위치: terraform/services/api-server/
```

### Step 4: Wizard Generates (Fully Automated!)

The wizard automatically executes 4 steps:

**Step 1/4: 코드 생성**
```
🔧 코드 생성 중...
템플릿: ecs-service
출력 위치: terraform/services/api-server

  📄 렌더링: main.tf
  📄 렌더링: data.tf
  📄 렌더링: locals.tf
  📄 렌더링: outputs.tf
  📄 렌더링: provider.tf
  📄 렌더링: alb.tf
  📄 렌더링: README.md

💾 파일 저장 중...
  ✅ main.tf
  ✅ data.tf
  ✅ locals.tf
  ✅ outputs.tf
  ✅ provider.tf
  ✅ alb.tf
  ✅ README.md

✅ 7개 파일 생성 완료
```

**Step 2/4: atlantis.yaml 업데이트**
```
🔧 atlantis.yaml 업데이트 중...
✅ atlantis.yaml 업데이트 완료
   → 프로젝트 추가: api-server-prod
   → 디렉토리: terraform/services/api-server
```

**Step 3/4: Git 커밋**
```
🔀 Git 브랜치 생성 중...
✅ 브랜치 생성 완료: feature/wizard-api-server-20251024

📦 파일 스테이징 중...
   ✅ terraform/services/api-server/main.tf
   ✅ terraform/services/api-server/data.tf
   ... (7개 파일)
   ✅ atlantis.yaml

💾 Git 커밋 생성 중...
✅ 커밋 생성 완료
```

**Step 4/4: GitHub PR 생성**
```
🚀 GitHub PR 생성 중...
✅ PR 생성 완료!

PR URL: https://github.com/org/infrastructure/pull/123
```

### Step 5: Review & Deploy

1. Open the PR link
2. Wait for Atlantis plan (1-2 minutes)
3. Review plan results in PR comment
4. Approve and merge
5. Atlantis applies automatically

## 📁 Generated Structure

```
terraform/services/api-server/
├── data.tf              # Shared infrastructure references (SSM params)
├── locals.tf            # Local variables and required tags
├── main.tf              # ECS service, security groups
├── alb.tf               # ALB (if selected)
├── elasticache.tf       # Redis (if selected, dedicated)
├── rds.tf               # RDS (if selected, dedicated)
├── outputs.tf           # Service outputs
├── provider.tf          # Terraform backend config
└── README.md            # Service documentation

atlantis.yaml            # Auto-updated with new project entry
```

### atlantis.yaml Auto-Registration

The wizard automatically adds your service to Section 4:

```yaml
# 4. Application Services (애플리케이션 서비스) - Wizard Auto-Managed
# ============================================================================
# Last updated: 2025-10-24

# API-SERVER - Generated by wizard on 2025-10-24
- name: api-server-prod
  dir: terraform/services/api-server
  workspace: default
  autoplan:
    when_modified: ["*.tf", "*.tfvars"]
    enabled: true
  apply_requirements: ["approved", "mergeable"]
  workflow: default

# END OF WIZARD AUTO-MANAGED SECTION
```

## 🔧 Development

### Project Structure

```
wizard/
├── infra-wizard.sh       # Shell wrapper (entry point)
├── infra-wizard.py       # Main CLI application
├── generator.py          # Jinja2 code generation engine
├── atlantis_updater.py   # atlantis.yaml auto-update
├── git_helper.py         # Git automation (branch, commit, PR)
├── requirements.txt      # Python dependencies
├── .venv/                # Virtual environment (auto-created)
└── README.md             # This file
```

### Module Responsibilities

**infra-wizard.py** (Main Orchestrator)
- Interactive CLI with Rich console
- Template selection and metadata loading
- Parameter collection with validation
- Component selection (shared vs dedicated)
- 4-step pipeline orchestration

**generator.py** (Code Generation)
- Jinja2 environment setup
- Template rendering with context
- Conditional file generation
- Output directory management

**atlantis_updater.py** (atlantis.yaml Management)
- Auto-managed section detection
- Project configuration generation
- Duplicate prevention
- YAML validation
- Timestamp updates

**git_helper.py** (Git Automation)
- Feature branch creation
- File staging and commits
- Conventional commit messages
- GitHub PR creation via `gh` CLI
- PR description generation

### Adding New Templates

1. Create template directory:
   ```bash
   mkdir -p terraform/templates/{template-name}
   ```

2. Create `metadata.json`:
   ```json
   {
     "module": "template-name",
     "version": "1.0.0",
     "description": "Template description",
     "required_parameters": [...],
     "optional_components": {...}
   }
   ```

3. Create Jinja2 templates (`.tf.j2` files)

4. Test with wizard

### Running in Development Mode

```bash
# With dry-run (no files created, no commits, no PR)
python3 wizard/infra-wizard.py --dry-run

# Commit only (skip PR creation)
python3 wizard/infra-wizard.py --no-pr

# With specific template
python3 wizard/infra-wizard.py --template ecs-service

# With debug mode
python3 wizard/infra-wizard.py --debug
```

### Command Options

- `--template NAME` - Skip template selection, use specified template
- `--dry-run` - Preview only, don't create files/commits/PR
- `--no-pr` - Generate code and commit, but skip PR creation
- `--debug` - Show full stack traces on errors

## 🔍 Troubleshooting

### Virtual Environment Issues

```bash
# Remove and recreate venv
rm -rf wizard/.venv
./wizard/infra-wizard.sh
```

### Python Version Issues

```bash
# Check Python version
python3 --version

# Must be 3.9 or later
```

### Template Not Found

```bash
# List available templates
ls terraform/templates/

# Check metadata.json exists
cat terraform/templates/ecs-service/metadata.json
```

## 📚 Related Documentation

- [atlantis.yaml Structure](../atlantis.yaml)
- [Template Development Guide](../terraform/templates/README.md) (TODO)
- [Infrastructure Governance](../docs/governance/)

## 🤝 Contributing

To add new features:
1. Create feature branch
2. Add templates and wizard logic
3. Test thoroughly
4. Create PR with examples

## 📝 License

Internal use only. Property of [Your Company].

---

**Version**: 1.0.0 (MVP)
**Last Updated**: 2025-10-24
**Maintainer**: Platform Team
